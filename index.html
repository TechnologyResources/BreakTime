<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BreakTime Buddy - مؤقت البريكات</title>
      <link rel="icon" href="images/favicon.png" type="image/png" />

    <script>
        // دالة يتم استدعاؤها قبل تحميل محتوى الصفحة لتطبيق التفضيل المحفوظ
        function applyDarkModePreference() {
            const isDarkMode = localStorage.getItem('theme') === 'dark' || 
                                (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        applyDarkModePreference();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
        body {
            font-family: 'Tajawal', sans-serif;
        }
        /* Custom styles for the break selection buttons */
        .time-slot {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .time-slot:hover:not(.booked):not([disabled]) {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        /* Dark Mode adjustments for custom hover effect */
        .dark .time-slot:hover:not(.booked):not([disabled]) {
            box-shadow: 0 8px 15px rgba(255, 255, 255, 0.05);
        }

        .floating-notification {
            animation: floatUp 4s ease forwards;
        }
        @keyframes floatUp {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .timer-text {
            font-size: 0.75rem; /* text-xs */
            font-weight: 700; /* font-bold */
        }
         /* Style for the Admin Modal */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen dark:from-gray-900 dark:to-black dark:text-gray-100">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-12 relative">
            
            <button id="themeToggle" class="absolute top-0 left-0 p-3 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 dark:bg-gray-700 dark:text-yellow-400 dark:hover:bg-gray-600 transition-colors" title="تبديل الوضع">
                <i data-feather="moon" class="w-6 h-6"></i>
            </button>
            
            <button id="adminToggle" class="absolute top-0 right-0 p-3 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 dark:bg-gray-700 dark:text-indigo-400 dark:hover:bg-gray-600 transition-colors" title="إعدادات النظام (إدارة)">
                <i data-feather="settings" class="w-6 h-6"></i>
            </button>
            <h1 class="text-5xl font-extrabold text-indigo-800 mb-2 tracking-wide dark:text-indigo-400">BreakTime Buddy ⏳</h1>
            <p class="text-lg text-gray-600 dark:text-gray-400">نظام حجز ومتابعة فترات الراحة (الترتيب الإجباري: 15 د، 30 د، 15 د)</p>
        </header>

        <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden dark:bg-gray-800 dark:shadow-none dark:border dark:border-indigo-900">
            
            <div id="shiftSelection" class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-3xl font-extrabold text-indigo-900 mb-6 text-center dark:text-white">
                    اختر وردية العمل اليومية
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button id="morningShift" onclick="selectShift('morning')" 
                            class="shift-card bg-white dark:bg-gray-700 dark:border-gray-600 border-2 border-transparent p-6 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:scale-[1.02] cursor-pointer focus:outline-none focus:ring-4 focus:ring-blue-300 dark:hover:shadow-indigo-900/50">
                        <div class="flex flex-col items-center">
                            <i data-feather="sun" class="w-12 h-12 text-yellow-500 mb-3 drop-shadow-md"></i>
                            <span class="text-xl font-extrabold text-gray-800 mb-1 dark:text-gray-100">الدوام الصباحي</span>
                            <span class="text-sm text-gray-500 font-medium dark:text-gray-300">9:00 صباحًا - 5:00 مساءً</span>
                            <span class="mt-4 inline-block bg-blue-50 text-blue-700 text-xs font-bold px-3 py-1 rounded-full dark:bg-blue-900 dark:text-blue-300">
                                البريك متاح بين 10:00 ص و 4:00 م
                            </span>
                        </div>
                    </button>

                    <button id="eveningShift" onclick="selectShift('evening')" 
                            class="shift-card bg-white dark:bg-gray-700 dark:border-gray-600 border-2 border-transparent p-6 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:scale-[1.02] cursor-pointer focus:outline-none focus:ring-4 focus:ring-purple-300 dark:hover:shadow-indigo-900/50">
                        <div class="flex flex-col items-center">
                            <i data-feather="moon" class="w-12 h-12 text-purple-600 mb-3 drop-shadow-md"></i>
                            <span class="text-xl font-extrabold text-gray-800 mb-1 dark:text-gray-100">الدوام المسائي</span>
                            <span class="text-sm text-gray-500 font-medium dark:text-gray-300">3:00 مساءً - 11:00 مساءً</span>
                            <span class="mt-4 inline-block bg-purple-50 text-purple-700 text-xs font-bold px-3 py-1 rounded-full dark:bg-purple-900 dark:text-purple-300">
                                البريك متاح بين 4:00 م و 10:00 م
                            </span>
                        </div>
                    </button>
                </div>
            </div>

            <div id="breakSelection" class="hidden p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-100">اختر فترات الراحة (الترتيب الإجباري):</h2>
                    <div class="flex items-center gap-2 bg-indigo-100 text-indigo-800 font-bold px-4 py-1.5 rounded-full text-lg dark:bg-indigo-900 dark:text-indigo-300">
                        <span id="selectedCount">0</span>
                        <span>/ 3</span>
                    </div>
                </div>
                
                <p class="text-sm text-center text-gray-600 mb-4 font-bold dark:text-gray-400">
                    يجب اختيار البريكات بالترتيب: <span class="text-indigo-700 dark:text-indigo-300">15 دقيقة</span> ، ثم <span class="text-red-700 dark:text-red-300">30 دقيقة</span> ، ثم <span class="text-indigo-700 dark:text-indigo-300">15 دقيقة</span>.
                </p>
                
                <div id="timeSlotsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-6 p-3 bg-gray-50 rounded-lg border border-gray-200 dark:bg-gray-900 dark:border-gray-700">
                    </div>
                
                <div class="flex flex-col sm:flex-row gap-3">
                    <input id="employeeName" type="text" placeholder="اسم الموظف" 
                           class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                    
                    <button id="confirmButton" disabled class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed dark:bg-indigo-700 dark:hover:bg-indigo-600">
                        تأكيد الحجز
                    </button>
                    <button onclick="resetSelection()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-6 rounded-lg shadow-md transition-all duration-300 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-white">
                        اختيار وردية أخرى
                    </button>
                </div>
            </div>

            <div id="scheduleDisplay" class="p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 dark:text-gray-100">جدول فترات الراحة المحجوزة</h2>
                <div id="scheduleTable" class="bg-gray-50 rounded-xl shadow-inner overflow-hidden border border-gray-200 dark:bg-gray-900 dark:border-indigo-900">
                    <div class="grid grid-cols-12 bg-gray-200 font-bold text-gray-700 text-sm md:text-base dark:bg-gray-700 dark:text-gray-200">
                        <div class="col-span-3 p-3 border-r border-gray-300 text-center dark:border-gray-600">الموظف</div>
                        <div class="col-span-3 p-3 border-r border-gray-300 text-center dark:border-gray-600">البريك الأول (15 د)</div>
                        <div class="col-span-3 p-3 border-r border-gray-300 text-center dark:border-gray-600">البريك الثاني (30 د)</div>
                        <div class="col-span-3 p-3 text-center">البريك الثالث (15 د)</div>
                    </div>
                    <div id="scheduleContent" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <div class="grid grid-cols-12 text-center items-center py-4 px-2 text-gray-500 dark:text-gray-400">
                            <div class="col-span-12 p-2">لا توجد حجوزات في هذه الوردية حتى الآن</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-6 text-center text-gray-600 dark:text-gray-400">
            <p id="currentTime" class="text-md font-medium bg-white/50 inline-block px-4 py-2 rounded-lg shadow-inner dark:bg-gray-800/50"></p>
        </div>

        <div id="notificationContainer" class="fixed bottom-4 right-4 space-y-2 z-50"></div>
    </div>

    <div id="adminModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg dark:bg-gray-800 dark:border dark:border-indigo-900">
            <div class="flex justify-between items-center border-b pb-3 mb-4 dark:border-gray-700">
                <h3 class="text-2xl font-bold text-indigo-700 dark:text-indigo-400">إعدادات النظام (Admin)</h3>
                <button onclick="document.getElementById('adminModal').classList.add('hidden', 'opacity-0')" class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-400">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div id="adminStep1">
                <p class="mb-4 text-gray-600 dark:text-gray-300">للوصول إلى أدوات الإدارة، يرجى إدخال الرمز السري:</p>
                <input id="adminCode" type="password" placeholder="الرمز السري"
                       class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <button id="adminLoginButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600">
                    دخول
                </button>
            </div>

            <div id="adminStep2" class="hidden">
                <p class="text-lg font-semibold mb-3 text-indigo-700 dark:text-indigo-400 border-b pb-2 dark:border-gray-700">إدارة الحجوزات يدوياً:</p>
                
                <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg dark:bg-red-900/20 dark:border-red-900">
                    <h4 class="text-lg font-bold text-red-800 dark:text-red-400 mb-2">حذف موظف كامل وسجل بريكاته ⚠️</h4>
                    <p class="text-sm text-red-700 dark:text-red-300 mb-3">سيتم مسح جميع بريكات الموظف بالاسم وجعلها متاحة للحجز مرة أخرى.</p>
                    <input id="deleteEmployeeName" type="text" placeholder="اسم الموظف المراد حذفه بالكامل"
                           class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <button id="deleteEmployeeButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg shadow-md transition-colors dark:bg-red-700 dark:hover:bg-red-600">
                        <i data-feather="user-x" class="w-5 h-5 inline-block ml-2"></i>
                        حذف الموظف وحجوزاته بالكامل
                    </button>
                </div>
                <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg dark:bg-yellow-900/20 dark:border-yellow-900">
                    <h4 class="text-lg font-bold text-yellow-800 dark:text-yellow-400 mb-2">حذف بريك لموظف محدد (Admin Override)</h4>
                    <p class="text-sm text-yellow-700 dark:text-yellow-300 mb-3">يمكنك حذف بريك واحد من سجل موظف معين بالاسم ورقم البريك (1، 2، أو 3).</p>
                    <input id="deleteBreakName" type="text" placeholder="اسم الموظف"
                           class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <input id="deleteBreakIndex" type="number" min="1" max="3" placeholder="رقم البريك (1 أو 2 أو 3)"
                           class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <button id="deleteSingleBreakButton" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg shadow-md transition-colors dark:bg-yellow-700 dark:hover:bg-yellow-600">
                        <i data-feather="minus-circle" class="w-5 h-5 inline-block ml-2"></i>
                        حذف هذا البريك
                    </button>
                </div>
                
                <p class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-200 border-b pb-2 dark:border-gray-700">مسح بيانات التخزين بالكامل:</p>
                <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg dark:bg-red-900/20 dark:border-red-900">
                    <p class="text-sm font-medium text-red-700 dark:text-red-400 mb-2">حجم بيانات الحجوزات الحالي في التخزين المحلي:</p>
                    <span id="storageSizeDisplay" class="text-xl font-bold text-red-800 dark:text-red-300">0 KB</span>
                </div>

                <button id="deleteStorageButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg shadow-md transition-colors dark:bg-red-700 dark:hover:bg-red-600">
                    <i data-feather="trash-2" class="w-5 h-5 inline-block ml-2"></i>
                    مسح جميع بيانات الموظفين بالكامل
                </button>
                <p class="text-xs text-red-500 mt-2 text-center dark:text-red-400">⚠️ هذا الإجراء لا يمكن التراجع عنه.</p>
            </div>

        </div>
    </div>
    <script>
        // دالة يتم استدعاؤها قبل تحميل محتوى الصفحة لتطبيق التفضيل المحفوظ
        // (تم نقلها للأعلى لتطبيق الوضع الليلي قبل ظهور المحتوى)
        
        
        feather.replace();
        
        // ****** التعديل 1: تحميل البيانات المحفوظة ******
        let employees = JSON.parse(localStorage.getItem('breakTimeBuddyEmployees')) || [];
        let selectedShift = null;
        let selectedBreaks = []; // سيحتوي على كائنات { time: "10:00 ص", duration: 15 }
        
        const BREAK_TYPES = {
            '15': 15, // مدة 15 دقيقة
            '30': 30  // مدة 30 دقيقة
        };
        const MAX_TOTAL_BREAKS = 3;
        
        // ******* التعديل الجديد لفرض الترتيب *******
        const REQUIRED_ORDER = [15, 30, 15]; // الترتيب الإجباري: 15 د، 30 د، 15 د
        
        
        // توليد فترات البريك المتاحة
        const generateBreakTimes = (startHour, endHour) => {
            const slots = [];
            for (let h = startHour; h < endHour; h++) {
                for (let m = 0; m < 60; m += 15) {
                    let time = `${String(h % 12 || 12).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    let period = h >= 12 && h < 24 ? 'م' : 'ص';
                    
                    // بريك 15 دقيقة
                    if (h + (m + 15) / 60 <= endHour) {
                        slots.push({ time: `${time} ${period}`, duration: 15 });
                    }
                    
                    // بريك 30 دقيقة (فقط في بداية ونصف الساعة)
                    if (m % 30 === 0 && h + (m + 30) / 60 <= endHour) {
                        slots.push({ time: `${time} ${period}`, duration: 30 });
                    }
                }
            }
            // إزالة التكرارات
            const uniqueSlots = Array.from(new Set(slots.map(s => `${s.time}-${s.duration}`)))
                                             .map(str => {
                                                 const [time, durationStr] = str.split('-');
                                                 return { time: time, duration: Number(durationStr) };
                                             });
            
            // التصفية النهائية للحفاظ على النطاق
            const filterSlots = (slots, startHour, endHour) => {
                const today = new Date();
                return slots.filter(slot => {
                    const [timeStr, period] = slot.time.split(' ');
                    let [hours, minutes] = timeStr.split(':').map(Number);
                    if (period === 'م' && hours !== 12) hours += 12;
                    if (period === 'ص' && hours === 12) hours = 0;
                    
                    // يتم إنشاء كائن وقت النهاية للبريك
                    const startTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes, 0, 0);
                    const endTime = new Date(startTime.getTime() + slot.duration * 60000);
                    
                    // تحويل ساعات النهاية إلى تنسيق 24 ساعة لغرض المقارنة
                    const endLimit = new Date(today.getFullYear(), today.getMonth(), today.getDate(), endHour, 0, 0, 0);
                    
                    return endTime <= endLimit;
                });
            };
            
            return filterSlots(uniqueSlots, startHour, endHour).sort((a, b) => timeToDate(a.time) - timeToDate(b.time));
        };

        const morningBreakStartTimes = generateBreakTimes(10, 16); // 10:00 ص إلى 4:00 م (16:00)
        const eveningBreakStartTimes = generateBreakTimes(16, 22); // 4:00 م (16:00) إلى 10:00 م (22:00)

        const shiftSelection = document.getElementById('shiftSelection');
        const breakSelection = document.getElementById('breakSelection');
        const timeSlotsContainer = document.getElementById('timeSlotsContainer');
        const selectedCount = document.getElementById('selectedCount');
        const employeeName = document.getElementById('employeeName');
        const confirmButton = document.getElementById('confirmButton');
        const scheduleContent = document.getElementById('scheduleContent');
        const currentTimeDisplay = document.getElementById('currentTime');
        const notificationContainer = document.getElementById('notificationContainer');
        const themeToggle = document.getElementById('themeToggle');
        
        // ****** متغيرات وإعدادات التحكم بالتخزين الجديدة ******
        const ADMIN_CODE = '!#?!#!@@??#!'; // الرمز السري للوصول للإدارة
        const adminToggle = document.getElementById('adminToggle');
        const adminModal = document.getElementById('adminModal');
        const adminCode = document.getElementById('adminCode');
        const adminLoginButton = document.getElementById('adminLoginButton');
        const adminStep1 = document.getElementById('adminStep1');
        const adminStep2 = document.getElementById('adminStep2');
        const deleteStorageButton = document.getElementById('deleteStorageButton');
        const storageSizeDisplay = document.getElementById('storageSizeDisplay');
        // المتغيرات لخاصية حذف بريك موظف محدد (موجودة سابقاً)
        const deleteBreakName = document.getElementById('deleteBreakName');
        const deleteBreakIndex = document.getElementById('deleteBreakIndex');
        const deleteSingleBreakButton = document.getElementById('deleteSingleBreakButton');
        // المتغيرات الجديدة لخاصية حذف موظف كامل
        const deleteEmployeeName = document.getElementById('deleteEmployeeName');
        const deleteEmployeeButton = document.getElementById('deleteEmployeeButton');
        // *******************************************************


        // UTILITY FUNCTIONS

        function timeToDate(timeString) {
            const [time, period] = timeString.split(' ');
            let [hours, minutes] = time.split(':').map(Number);

            if (period === 'م' && hours !== 12) {
                hours += 12;
            } else if (period === 'ص' && hours === 12) {
                hours = 0;
            }

            const today = new Date();
            let date = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes, 0, 0);
            
            return date;
        }

        function formatTimeDifference(ms) {
            const totalSeconds = Math.max(0, Math.floor(ms / 1000));
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            const pad = (num) => num.toString().padStart(2, '0');
            
            if (hours > 0) return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
            return `${pad(minutes)}:${pad(seconds)}`;
        }
        
        function getBreakEndString(startTime, duration) {
            const startDate = timeToDate(startTime);
            const endDate = new Date(startDate.getTime() + duration * 60000);
            
            const options = { hour: '2-digit', minute: '2-digit', hour12: true };
            let endString = endDate.toLocaleTimeString('ar-EG', options);
            
            // تصحيح التنسيق (قد تختلف البيئة)
            endString = endString.replace('ص', 'ص').replace('م', 'م'); 
            
            return endString;
        }

        function toggleTheme() {
            const htmlElement = document.documentElement;
            const isDark = htmlElement.classList.toggle('dark');
            const icon = themeToggle.querySelector('i');

            if (isDark) {
                localStorage.setItem('theme', 'dark');
                icon.setAttribute('data-feather', 'sun');
            } else {
                localStorage.setItem('theme', 'light');
                icon.setAttribute('data-feather', 'moon');
            }
            feather.replace();

            if (selectedShift) {
                renderTimeSlots();
                renderSchedule();
            }
        }
        
        function updateThemeIcon() {
            const htmlElement = document.documentElement;
            const icon = themeToggle.querySelector('i');
            if (htmlElement.classList.contains('dark')) {
                icon.setAttribute('data-feather', 'sun');
            } else {
                icon.setAttribute('data-feather', 'moon');
            }
            feather.replace();
        }

        function showNotification(message, type) {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            const icon = {
                success: 'check-circle',
                error: 'x-circle',
                info: 'info'
            };

            const notification = document.createElement('div');
            notification.className = `floating-notification flex items-center p-4 rounded-lg shadow-xl text-white ${colors[type]} transform translate-y-20 opacity-0`;
            notification.innerHTML = `
                <i data-feather="${icon[type]}" class="w-6 h-6 ml-2"></i>
                <span class="font-medium">${message}</span>
            `;
            
            notificationContainer.appendChild(notification);
            feather.replace();

            // إزالة الإشعار بعد انتهاء مدة الأنميشن
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // ****** التعديل 2: دالة لحفظ البيانات ******
        function saveEmployees() {
            localStorage.setItem('breakTimeBuddyEmployees', JSON.stringify(employees));
        }
        
        // ---------------------------------------------------------------------
        // وظائف التحكم بالتخزين (المضافة لطلبك)
        // ---------------------------------------------------------------------
function clearEmployeeStorage() {
    // تفريغ مصفوفة الموظفين
    employees.length = 0;
    saveEmployees(); // حفظ الحالة الفارغة
    
    // يجب تعريف دالة لإغلاق نافذة الإدارة (Modal)
    // closeAdminModal(); 
    renderSchedule(); // تحديث الجدول
    showNotification('تم مسح جميع حجوزات الموظفين بنجاح.', 'success');
}

      function deleteEmployeeAndBreaks() {
    // يجب أن تكون هذه المتغيرات مُعرفة كعناصر DOM في كود الإعدادات
    const name = adminEmployeeSelect.value;
    const shift = adminShiftSelect.value;

    if (!name || !shift) {
        showNotification('يجب اختيار اسم موظف ووردية لحذفه بالكامل.', 'error');
        return;
    }
    const initialLength = employees.length;
    // تصفية المصفوفة للاحتفاظ بجميع الموظفين ما عدا المطابق للاسم والوردية
    employees = employees.filter(emp => !(emp.name === name && emp.shift === shift));

    if (employees.length < initialLength) {
        saveEmployees();
        // closeAdminModal(); 
        renderSchedule();
        showNotification(`تم حذف الموظف "${name}" بالكامل من وردية ${shift}.`, 'success');
    } else {
        showNotification(`لم يتم العثور على حجز للموظف "${name}" في وردية ${shift}.`, 'error');
    }
}
      
      // الحدث الخاص بزر مسح التخزين بالكامل
deleteStorageButton.addEventListener('click', clearEmployeeStorage);

// الحدث الخاص بزر حذف بريك موظف محدد
deleteSingleBreakButton.addEventListener('click', deleteSingleBreak);

// الحدث الخاص بزر حذف موظف كامل (جميع بريكاته)
deleteEmployeeButton.addEventListener('click', deleteEmployeeAndBreaks);

      function deleteSingleBreak() {
    // يجب أن تكون هذه المتغيرات مُعرفة كعناصر DOM في كود الإعدادات
    const name = adminEmployeeSelect.value;
    const shift = adminShiftSelect.value;
    const breakIndex = parseInt(adminBreakIndexSelect.value, 10);

    if (!name || !shift || isNaN(breakIndex)) {
        showNotification('يجب اختيار موظف، وردية، ورقم بريك للحذف.', 'error');
        return;
    }

    const employee = employees.find(emp => emp.name === name && emp.shift === shift);

    if (employee) {
        if (employee.breaks[breakIndex]) {
            const deletedBreakTime = employee.breaks[breakIndex].time;
            employee.breaks.splice(breakIndex, 1); // حذف العنصر
            
            saveEmployees();
            // closeAdminModal();
            renderSchedule();
            showNotification(`تم إلغاء البريك رقم ${breakIndex + 1} (${deletedBreakTime}) للموظف ${name} بنجاح.`, 'success');
        } else {
            showNotification('هذا البريك غير محجوز أساساً لهذا الموظف.', 'warning');
        }
    } else {
        showNotification('لم يتم العثور على الموظف المحدد.', 'error');
    }
}
        function getLocalStorageSize() {
            let totalBytes = 0;
            // يتم استخدام المفتاح الخاص بحجوزات الموظفين فقط
            const data = localStorage.getItem('breakTimeBuddyEmployees');
            if (data) {
                // الحجم التقريبي = طول المفتاح + طول القيمة (بوحدة البايت)
                totalBytes += 'breakTimeBuddyEmployees'.length * 2 + data.length * 2;
            }
            // تحويل البايت إلى كيلوبايت وتقريبه
            return (totalBytes / 1024).toFixed(2);
        }

        function openAdminModal() {
            // إعادة تعيين حالة النافذة عند فتحها
            adminCode.value = '';
            adminStep1.classList.remove('hidden');
            adminStep2.classList.add('hidden');
            
            adminModal.classList.remove('hidden', 'opacity-0');
            // إضافة تأخير بسيط لتشغيل الانتقال
            setTimeout(() => adminModal.classList.remove('opacity-0'), 10);
            adminCode.focus();
        }

        function checkAdminLogin() {
            if (adminCode.value === ADMIN_CODE) {
                storageSizeDisplay.textContent = `${getLocalStorageSize()} KB`; // عرض حجم التخزين
                adminStep1.classList.add('hidden');
                adminStep2.classList.remove('hidden');
                showNotification('تم تسجيل الدخول بنجاح إلى لوحة التحكم.', 'info');
            } else {
                showNotification('الرمز السري غير صحيح.', 'error');
                adminCode.value = ''; // مسح الإدخال
            }
        }

        function clearEmployeeStorage() {
            // تأكيد العملية من المستخدم قبل المسح
            if (!confirm("هل أنت متأكد من مسح جميع حجوزات الموظفين المحفوظة؟ هذا الإجراء لا يمكن التراجع عنه!")) {
                return;
            }

            // ⚠️ يتم حذف المفتاح الخاص بحجوزات الموظفين
            localStorage.removeItem('breakTimeBuddyEmployees'); 
            
            employees = []; // تحديث المتغير الداخلي
            
            // إخفاء نافذة الإدارة بعد المسح
            adminModal.classList.add('hidden', 'opacity-0'); 
            showNotification('تم حذف جميع بيانات الموظفين بنجاح! 🗑️', 'success');

            // إعادة تحديث الواجهة بعد الحذف
            if (selectedShift) {
                renderTimeSlots();
                renderSchedule();
            }
        }

        // ---------------------------------------------------------------------
        // وظائف رئيسية
        // ---------------------------------------------------------------------
 
              // ****** الوظيفة الجديدة: حذف موظف كامل ******
        function deleteEmployeeAndBreaks() {
            const nameToDelete = deleteEmployeeName.value.trim();

            if (!nameToDelete) {
                showNotification('الرجاء إدخال اسم الموظف المراد حذفه بالكامل.', 'error');
                return;
            }

            const initialLength = employees.length;
            
            // تصفية المصفوفة لحذف جميع سجلات هذا الموظف (قد يكون له سجل في الوردية الصباحية والمسائية)
            employees = employees.filter(emp => emp.name !== nameToDelete);
            
            const newLength = employees.length;
            const employeesRemoved = initialLength - newLength;


            if (employeesRemoved === 0) {
                showNotification(`لم يتم العثور على أي سجلات للموظف: ${nameToDelete}`, 'warning');
                return;
            }
            
            // تأكيد العملية
            if (!confirm(`هل أنت متأكد من حذف جميع سجلات (${employeesRemoved} سجل) وحجوزات البريك للموظف ${nameToDelete}؟`)) {
                employees = JSON.parse(localStorage.getItem('breakTimeBuddyEmployees')) || []; // إعادة تحميل للحالة الأصلية إذا ألغى
                return;
            }

            saveEmployees(); // حفظ البيانات بعد الحذف
            
            // مسح الحقل وإظهار الإشعار
            deleteEmployeeName.value = '';
            showNotification(`تم حذف جميع سجلات الموظف ${nameToDelete} (${employeesRemoved} سجل) بنجاح. الأوقات أصبحت متاحة الآن.`, 'success');

            // إخفاء نافذة الإدارة وتحديث الواجهة
            adminModal.classList.add('hidden', 'opacity-0');

            if (selectedShift) {
                renderTimeSlots(); // تحديث أوقات الحجز المتاحة
                renderSchedule(); // تحديث الجدول
            }
        }


        // ****** الوظيفة الموجودة: حذف بريك موظف محدد ******
        function deleteSingleBreak() {
            const name = deleteBreakName.value.trim();
            const indexStr = deleteBreakIndex.value.trim();
            const index = parseInt(indexStr);

            if (!name || isNaN(index) || index < 1 || index > 3) {
                showNotification('الرجاء إدخال اسم موظف صحيح ورقم بريك بين 1 و 3.', 'error');
                return;
            }

            const employeeIndex = employees.findIndex(emp => emp.name === name);

            if (employeeIndex === -1) {
                showNotification(`لم يتم العثور على موظف باسم: ${name}`, 'error');
                return;
            }

            const emp = employees[employeeIndex];
            const breakToRemoveIndex = index - 1; // تحويل من (1, 2, 3) إلى (0, 1, 2)

            if (!emp.breaks || breakToRemoveIndex >= emp.breaks.length || !emp.breaks[breakToRemoveIndex].time) {
                showNotification(`الموظف ${name} لم يحجز البريك رقم ${index} أو أنه محذوف مسبقًا.`, 'warning');
                return;
            }

            // تأكيد العملية
            const breakInfo = emp.breaks[breakToRemoveIndex];
            if (!confirm(`هل أنت متأكد من حذف البريك رقم ${index} (${breakInfo.duration} دقيقة يبدأ عند ${breakInfo.time}) للموظف ${name}؟ هذا سيجعله متاحًا للحجز مجدداً.`)) {
                return;
            }

            // حذف البريك: نستخدم splice لحذفه بالكامل من المصفوفة
            emp.breaks.splice(breakToRemoveIndex, 1);
            
            saveEmployees(); // حفظ البيانات المحدثة بعد الحذف

            // مسح الحقول وإظهار الإشعار
            deleteBreakName.value = '';
            deleteBreakIndex.value = '';
            showNotification(`تم حذف البريك رقم ${index} للموظف ${name} بنجاح. الوقت متاح الآن للحجز.`, 'success');

            // إخفاء نافذة الإدارة وتحديث الواجهة
            adminModal.classList.add('hidden', 'opacity-0');

            if (selectedShift) {
                renderTimeSlots(); // تحديث أوقات الحجز المتاحة
                renderSchedule(); // تحديث الجدول لإظهار أن البريك قد حذف
            }
        }

        function selectShift(shift) {
            selectedShift = shift;
            
            document.querySelectorAll('.shift-card').forEach(card => {
                card.classList.remove('border-indigo-600', 'ring-4', 'ring-indigo-200', 'dark:ring-indigo-900');
                card.classList.add('border-transparent');
            });

            const selectedElement = document.getElementById(`${shift}Shift`);
            selectedElement.classList.remove('border-transparent');
            selectedElement.classList.add('border-indigo-600', 'ring-4', 'ring-indigo-200', 'dark:ring-indigo-900');

            setTimeout(() => {
                shiftSelection.classList.add('hidden');
                breakSelection.classList.remove('hidden');
                renderTimeSlots();
                renderSchedule(); 
                updateAllTimers();
            }, 200); 
        }
        
        function renderTimeSlots() {
            const now = new Date();
            
            const lastPossibleBreakTime = selectedShift === 'morning' ? '04:00 م' : '10:00 م';
            const lastBreakEnd = timeToDate(lastPossibleBreakTime);
            const isShiftClosed = lastBreakEnd.getTime() < now.getTime();

            timeSlotsContainer.innerHTML = '';
            const slots = selectedShift === 'morning' ? morningBreakStartTimes : eveningBreakStartTimes;
            
            if (isShiftClosed) {
                timeSlotsContainer.innerHTML = `<p class="col-span-full text-center text-red-600 font-semibold py-4 bg-red-50 rounded-lg dark:bg-red-900 dark:text-red-300">
                    انتهى وقت حجز البريكات لهذه الوردية لليوم.
                </p>`;
                confirmButton.disabled = true;
                return;
            }
            
            // تحديد نوع البريك المطلوب حالياً
            const currentIndex = selectedBreaks.length;
            const requiredDuration = currentIndex < MAX_TOTAL_BREAKS ? REQUIRED_ORDER[currentIndex] : null;

            // دمج كل الحجوزات الحالية للوردية (لأغراض الإغلاق)
            const allBookedSlots = employees
                                            .filter(emp => emp.shift === selectedShift)
                                            .flatMap(emp => emp.breaks)
                                            .map(b => `${b.time}-${b.duration}`);


            slots.forEach(slot => {
                const slotStartTime = slot.time;
                const duration = slot.duration;
                const slotEndTime = getBreakEndString(slotStartTime, duration);
                const uniqueSlotKey = `${slotStartTime}-${duration}`;

                // حالة الحجز: محجوزة من موظف آخر
                const isBooked = allBookedSlots.includes(uniqueSlotKey);
                
                // حالة الاختيار: مختارة حاليًا من قبل هذا المستخدم
                const isSelected = selectedBreaks.some(b => b.time === slotStartTime && b.duration === duration);
                
                // حالة انتهاء الوقت
                const breakTimeEnd = new Date(timeToDate(slotStartTime).getTime() + duration * 60000);
                const isPastTime = breakTimeEnd.getTime() < now.getTime();
                
                // ******* التعديل لتطبيق قيد الترتيب *******
                const isIncorrectDuration = requiredDuration !== null && duration !== requiredDuration;

                // حالة تجاوز العدد الكلي (3 بريكات)
                const isTotalMaxed = selectedBreaks.length >= MAX_TOTAL_BREAKS && !isSelected;
                
                const isDisabled = isBooked || isPastTime || isIncorrectDuration || isTotalMaxed;

                let slotClasses;
                let statusText;
                let durationText = `(${duration} دقيقة)`;

                if (isPastTime) {
                    slotClasses = 'bg-gray-200 text-gray-500 cursor-not-allowed booked dark:bg-gray-700 dark:text-gray-400';
                    statusText = 'انتهت';
                } else if (isBooked) {
                    slotClasses = 'bg-gray-300 text-red-600 cursor-not-allowed booked dark:bg-gray-700 dark:text-red-400';
                    statusText = 'محجوزة';
                } else if (isSelected) {
                    slotClasses = 'bg-indigo-600 text-white shadow-lg border-2 border-indigo-800 dark:bg-indigo-700 dark:border-indigo-500 dark:shadow-indigo-500/50';
                    statusText = 'مختارة';
                } else if (isIncorrectDuration) {
                    slotClasses = 'bg-gray-200 text-orange-600 cursor-not-allowed booked dark:bg-gray-700 dark:text-orange-400';
                    statusText = `يجب اختيار بريك ${requiredDuration} دقيقة`;
                } else if (isTotalMaxed) {
                    slotClasses = 'bg-gray-200 text-red-600 cursor-not-allowed booked dark:bg-gray-700 dark:text-red-400';
                    statusText = 'اكتمل اختيار البريكات';
                } else {
                    slotClasses = 'bg-white text-indigo-600 hover:bg-indigo-100 border border-indigo-200 dark:bg-gray-800 dark:text-indigo-400 dark:hover:bg-gray-700 dark:border-indigo-900';
                    statusText = 'متاحة للحجز';
                }
                
                const slotElement = document.createElement('button');
                slotElement.className = `time-slot p-3 rounded-lg text-center text-sm font-bold ${slotClasses}`;
                slotElement.innerHTML = `
                    <span class="block text-xs font-normal mb-1">${durationText}</span>
                    <span class="block">${slotStartTime} - ${slotEndTime}</span>
                    <span class="block text-xs font-normal mt-1">${statusText}</span>
                `;
                slotElement.disabled = isDisabled;
                
                if (!isDisabled || isSelected) {
                    slotElement.addEventListener('click', () => toggleBreakSelection(slotStartTime, duration));
                }
                
                timeSlotsContainer.appendChild(slotElement);
            });
        }

        // ******* التعديل 3: منطق التحقق من الترتيب الزمني *******
        function toggleBreakSelection(slotStartTime, duration) {
            const index = selectedBreaks.findIndex(b => b.time === slotStartTime && b.duration === duration);
            
            if (index !== -1) {
                // إلغاء الاختيار مسموح به فقط إذا كان هو آخر بريك تم اختياره
                if (index !== selectedBreaks.length - 1) {
                    showNotification('لا يمكن إلغاء بريك من المنتصف، يجب إلغاء آخر بريك تم اختياره أولاً.', 'error');
                    return;
                }
                
                selectedBreaks.splice(index, 1);
            } else {
                // إضافة الاختيار
                
                const currentSelectionIndex = selectedBreaks.length;
                
                if (currentSelectionIndex >= MAX_TOTAL_BREAKS) {
                    showNotification('تم اختيار 3 بريكات بالفعل.', 'error');
                    return;
                }

                const requiredDuration = REQUIRED_ORDER[currentSelectionIndex];
                
                // التحقق من الترتيب الإجباري (المدة)
                if (duration !== requiredDuration) {
                    showNotification(`البريك رقم ${currentSelectionIndex + 1} يجب أن يكون ${requiredDuration} دقيقة.`, 'error');
                    return;
                }
                
                // منطق التحقق من الترتيب الزمني الجديد (التسلسل وعدم التداخل)
                if (selectedBreaks.length > 0) {
                    const lastBreak = selectedBreaks[selectedBreaks.length - 1];
                    const lastBreakStartTime = timeToDate(lastBreak.time);
                    const lastBreakEndTime = new Date(lastBreakStartTime.getTime() + lastBreak.duration * 60000); // وقت انتهاء البريك الأخير
                    const newBreakStartTime = timeToDate(slotStartTime); // وقت بدء البريك الجديد

                    // إذا كان وقت بدء البريك الجديد أصغر من أو يساوي وقت انتهاء البريك الأخير، فإنه متداخل أو معكوس.
                    if (newBreakStartTime <= lastBreakEndTime) {
                        const lastBreakEndTimeString = getBreakEndString(lastBreak.time, lastBreak.duration);
                        showNotification(`البريك رقم ${currentSelectionIndex + 1} يجب أن يبدأ بعد انتهاء البريك السابق (بعد ${lastBreakEndTimeString}).`, 'error');
                        return;
                    }
                }
                
                selectedBreaks.push({ time: slotStartTime, duration: duration });
                
                // الفرز ليس ضرورياً هنا بعد الآن بل نعتمد على ترتيب الإضافة
            }
            
            renderTimeSlots();
            selectedCount.textContent = selectedBreaks.length;
            
            const isThreeBreaks = selectedBreaks.length === MAX_TOTAL_BREAKS;
            // التحقق من الترتيب الصحيح للمدد
            const isCorrectDurationOrder = isThreeBreaks && selectedBreaks.every((b, i) => b.duration === REQUIRED_ORDER[i]);
            
            // التحقق من الترتيب الزمني (متتالي وغير متداخل)
            let isCorrectTimeOrder = true;
            for(let i = 1; i < selectedBreaks.length; i++) {
                const prevBreak = selectedBreaks[i-1];
                const currentBreak = selectedBreaks[i];

                const prevBreakStartTime = timeToDate(prevBreak.time);
                const prevBreakEndTime = new Date(prevBreakStartTime.getTime() + prevBreak.duration * 60000);
                const currentBreakStartTime = timeToDate(currentBreak.time);

                if (currentBreakStartTime <= prevBreakEndTime) {
                    isCorrectTimeOrder = false;
                    break;
                }
            }

            confirmButton.disabled = !(isCorrectDurationOrder && isCorrectTimeOrder && employeeName.value.trim());
        }

        // ******* التعديل 4: استدعاء دالة الحفظ داخل تأكيد الحجز *******
        function confirmReservation() {
            const name = employeeName.value.trim();
            
            const isThreeBreaks = selectedBreaks.length === MAX_TOTAL_BREAKS;
            const isCorrectDurationOrder = isThreeBreaks && selectedBreaks.every((b, i) => b.duration === REQUIRED_ORDER[i]);
            
            let isCorrectTimeOrder = true;
            for(let i = 1; i < selectedBreaks.length; i++) {
                const prevBreak = selectedBreaks[i-1];
                const currentBreak = selectedBreaks[i];
                const prevBreakStartTime = timeToDate(prevBreak.time);
                const prevBreakEndTime = new Date(prevBreakStartTime.getTime() + prevBreak.duration * 60000);
                const currentBreakStartTime = timeToDate(currentBreak.time);
                if (currentBreakStartTime <= prevBreakEndTime) {
                    isCorrectTimeOrder = false;
                    break;
                }
            }
            
            if (!name || !isCorrectDurationOrder || !isCorrectTimeOrder) {
                showNotification('يجب إدخال الاسم واختيار 3 بريكات بالترتيب الإجباري (15، 30، 15) وبتسلسل زمني صحيح لتأكيد الحجز.', 'error');
                return;
            }
            
            if (employees.some(emp => emp.name === name && emp.shift === selectedShift)) {
                showNotification(`الموظف ${name} لديه حجز بالفعل في هذه الوردية.`, 'error');
                return;
            }
            
            const employee = {
                name,
                shift: selectedShift,
                breaks: [...selectedBreaks], // نسخ البريكات بالوقت والمدة
                confirmedAt: new Date().toISOString()
            };
            
            employees.push(employee);
            saveEmployees(); // حفظ البيانات
            renderSchedule();
            
            employeeName.value = '';
            selectedBreaks = [];
            selectedCount.textContent = '0';
            confirmButton.disabled = true;
            renderTimeSlots();
            
            showNotification(`تم حجز البريكات لـ ${name} بنجاح ✅`, 'success');
        }
        
        function createBreakCellContent(breakItem) {
            const breakTime = breakItem.time;
            const duration = breakItem.duration;
            const breakEndString = getBreakEndString(breakTime, duration);
            
            const durationTextClass = duration === 30 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400';

            return `
                <span class="inline-block font-bold text-sm text-gray-800 dark:text-gray-100">${breakTime} - ${breakEndString}</span>
                <span class="block text-xs font-medium ${durationTextClass}">(${duration} دقيقة)</span>
                <div id="status-timer-${breakTime.replace(/ /g, '-').replace(/:/g, '-')}-${duration}" class="timer-display mt-1">
                    </div>
            `;
        }

      // دالة جديدة لحذف حجز موظف واحد
        function deleteEmployeeBreak(name, shift) {
            if (!confirm(`هل أنت متأكد من حذف حجز البريكات للموظف: ${name} في وردية ${shift === 'morning' ? 'الصباح' : 'المساء'}؟ هذا الإجراء لا يمكن التراجع عنه.`)) {
                return; // إلغاء إذا لم يتم التأكيد
            }

            // البحث عن الموظف وحذفه
            const initialLength = employees.length;
            employees = employees.filter(emp => !(emp.name === name && emp.shift === shift));

            if (employees.length < initialLength) {
                saveEmployees(); // حفظ البيانات بعد الحذف
                renderSchedule(); // تحديث الجدول لإظهار أن الحجز قد حذف
                renderTimeSlots(); // تحديث أوقات الحجز المتاحة (لأن الخانات أصبحت متاحة الآن)
                updateAllTimers();
                showNotification(`تم حذف حجز الموظف ${name} بنجاح.`, 'warning');
            } else {
                showNotification('لم يتم العثور على الحجز للحذف.', 'error');
            }
        }
      
        function renderSchedule() {
            const filteredEmployees = employees.filter(emp => emp.shift === selectedShift);

            if (filteredEmployees.length === 0) {
                scheduleContent.innerHTML = `
                    <div class="grid grid-cols-12 text-center items-center py-4 px-2 text-gray-500 dark:text-gray-400">
                        <div class="col-span-12 p-2">لا توجد حجوزات في هذه الوردية حتى الآن</div>
                    </div>
                `;
                return;
            }
            
            // فرز الموظفين
            filteredEmployees.sort((a, b) => {
                const timeA = timeToDate(a.breaks[0].time);
                const timeB = timeToDate(b.breaks[0].time);
                return timeA - timeB;
            });
            
            scheduleContent.innerHTML = filteredEmployees.map((emp, index) => {
                const rowClass = index % 2 === 0 ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-900';
                
                const breakCells = emp.breaks.map(breakItem => `
                    <div class="col-span-3 p-3 border-r border-gray-200 dark:border-gray-700">
                        ${createBreakCellContent(breakItem)}
                    </div>
                `).join('');
                
                return `
                    <div class="grid grid-cols-12 text-center items-center py-3 px-2 ${rowClass} hover:bg-indigo-50 dark:hover:bg-indigo-900/40 transition-colors">
                        <div class="col-span-3 p-3 font-extrabold text-gray-900 dark:text-white border-r border-gray-200 dark:border-gray-700">${emp.name}</div>
                        ${breakCells}
                    </div>
                `;
            }).join('');
        }

        let timerInterval = null;

        function updateTimer(breakItem) {
            const now = new Date();
            const breakStartTime = timeToDate(breakItem.time);
            const breakEndTime = new Date(breakStartTime.getTime() + breakItem.duration * 60000);
            
            const timerId = `status-timer-${breakItem.time.replace(/ /g, '-').replace(/:/g, '-')}-${breakItem.duration}`;
            const timerElement = document.getElementById(timerId);

            if (!timerElement) return; // قد لا يكون العنصر موجوداً إذا تم تبديل الوردية

            let statusHTML = '';

            if (now < breakStartTime) {
                // حالة: لم يبدأ بعد (يتبقى)
                const msUntilStart = breakStartTime.getTime() - now.getTime();
                statusHTML = `
                    <span class="timer-text text-blue-600 dark:text-blue-400">
                        يبدأ بعد: ${formatTimeDifference(msUntilStart)}
                    </span>
                `;
            } else if (now >= breakStartTime && now < breakEndTime) {
                // حالة: البريك قيد التشغيل (متبقي)
                const msRemaining = breakEndTime.getTime() - now.getTime();
                statusHTML = `
                    <span class="timer-text text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/50 px-2 py-0.5 rounded-full">
                        متبقي: ${formatTimeDifference(msRemaining)}
                    </span>
                `;
            } else {
                // حالة: انتهى البريك
                statusHTML = `
                    <span class="timer-text text-gray-500 dark:text-gray-500">
                        انتهى البريك
                    </span>
                `;
            }

            timerElement.innerHTML = statusHTML;
        }

        function updateAllTimers() {
            if (!selectedShift) return;

            // تحديد جميع البريكات في الوردية المحددة حالياً
            const activeBreaks = employees
                                    .filter(emp => emp.shift === selectedShift)
                                    .flatMap(emp => emp.breaks);
            
            // تحديث مؤقت كل بريك
            activeBreaks.forEach(breakItem => updateTimer(breakItem));

            // تحديث الساعة الحالية
            const now = new Date();
            const options = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            currentTimeDisplay.textContent = `الساعة الحالية: ${now.toLocaleTimeString('ar-EG', options)}`;
        }

        function startTimerLoop() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            // تحديث كل ثانية
            timerInterval = setInterval(updateAllTimers, 1000);
        }
        
        function resetSelection() {
            selectedShift = null;
            selectedBreaks = [];
            employeeName.value = '';
            selectedCount.textContent = '0';
            confirmButton.disabled = true;
            
            shiftSelection.classList.remove('hidden');
            breakSelection.classList.add('hidden');
        }

        // INITIALIZATION AND EVENT LISTENERS

        // ربط الأحداث
        confirmButton.addEventListener('click', confirmReservation);
        employeeName.addEventListener('input', () => {
            const isThreeBreaks = selectedBreaks.length === MAX_TOTAL_BREAKS;
            const isCorrectDurationOrder = isThreeBreaks && selectedBreaks.every((b, i) => b.duration === REQUIRED_ORDER[i]);
            confirmButton.disabled = !(isCorrectDurationOrder && employeeName.value.trim());
        });
        themeToggle.addEventListener('click', toggleTheme);
        
        // ****** ربط أحداث الإدارة الجديدة ******
        adminToggle.addEventListener('click', openAdminModal);
        adminLoginButton.addEventListener('click', checkAdminLogin);
        deleteStorageButton.addEventListener('click', clearEmployeeStorage);
        adminCode.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                checkAdminLogin();
            }
        });
        // ***************************************

        // بدء حلقة المؤقت
        startTimerLoop();
        // تحديث حالة الأيقونة عند التحميل الأولي
        updateThemeIcon();
        updateAllTimers(); // تحديث أولي للساعة والمؤقتات
    </script>
</body>
</html>
