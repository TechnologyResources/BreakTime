<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Break Time Buddy - جدول حجز البريكات للأقسام</title>
    
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- تحميل Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <script>
        // =========================================================================
        //                 إعدادات Tailwind CSS المخصصة (Configuration)
        // =========================================================================
        // تحديد الثيمات والألوان الأساسية التي سيتم استخدامها في التصميم
        tailwind.config = {
            darkMode: 'class', // تفعيل الوضع الداكن بناءً على الكلاس 'dark' في عنصر <html>
            theme: {
                extend: {
                    // تعريف ألوان مخصصة للنظام لسهولة تغيير الثيم
                    colors: {
                        'primary-indigo': '#4f46e5',   // اللون الأساسي: أزرق نيلي
                        'secondary-green': '#10b981', // اللون الثانوي: أخضر لعمليات النجاح والحجز المتاح
                        'danger-red': '#ef4444',      // لون الخطر: أحمر لعمليات الحذف أو الأخطاء
                        'gold-star': '#facc15',       // لون الذهب: للتنبيهات والتحذيرات
                        'light-blue': '#3b82f6',      // لون أزرق فاتح: للمعلومات والحالة
                        'gray-dark-900': '#1f2937'    // لون داكن إضافي للخلفيات
                    }
                }
            }
        }
    </script>
<style>
    /* تخصيص شريط التمرير لوضع المدير */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
</style>
</head>
<body class="bg-gray-50 dark:bg-gray-dark-900 transition-colors duration-300 min-h-screen p-4">

    <!-- رسالة التنبيه (Message Box) -->
    <div id="messageBox" class="fixed top-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg shadow-2xl z-50 transition-opacity duration-300 flex items-center hidden opacity-0 min-w-[300px] text-center" role="alert">
        <div id="messageIcon" class="flex-shrink-0"></div>
        <span id="messageText" class="font-medium text-sm"></span>
    </div>

    <div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-6 md:p-10">
        
        <!-- العنوان ومعرف المستخدم -->
        <header class="text-center mb-8 border-b pb-4 border-gray-100 dark:border-gray-700">
            <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-2">
                رفيق وقت البريك ☕
            </h1>
            <p class="text-lg text-gray-600 dark:text-gray-400">
                جدول حجز البريكات لليوم الحالي (من الساعة ٨ صباحاً إلى ٤ مساءً)
            </p>
            <div class="mt-3 text-xs text-gray-500 dark:text-gray-500">
                معرّف المستخدم: <span id="userIdDisplay" class="font-mono text-xs text-primary-indigo dark:text-light-blue bg-gray-100 dark:bg-gray-700 p-1 rounded-md cursor-pointer" onclick="copyUserId()">Loading...</span>
            </div>
        </header>

        <!-- منطقة اختيار القسم وتعديل الإعدادات -->
        <div class="mb-8 p-5 bg-gray-50 dark:bg-gray-700 rounded-xl shadow-inner">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4 flex items-center justify-between">
                <span>تعديل إعدادات الحجز</span>
                <button id="adminButton" class="text-sm text-primary-indigo hover:text-indigo-700 dark:text-light-blue dark:hover:text-blue-400 font-medium flex items-center">
                    <i data-feather="lock" class="w-4 h-4 ml-1"></i>
                    وضع المدير
                </button>
            </h2>
            
            <!-- اختيار القسم (Department Selection) -->
            <div class="mb-4">
                <label for="departmentSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    القسم الحالي:
                </label>
                <select id="departmentSelect" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-indigo focus:border-primary-indigo dark:bg-gray-800 dark:text-white font-medium">
                    <option value="القسم 1">القسم 1</option>
                    <option value="القسم 2">القسم 2</option>
                    <option value="القسم 3">القسم 3</option>
                </select>
            </div>

            <!-- إعدادات عدد البريكات (Settings) -->
            <div class="flex items-center space-x-4 space-x-reverse">
                <div class="flex-1">
                    <label for="maxBreaksInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        عدد البريكات المسموح بها لكل شخص:
                    </label>
                    <input type="number" id="maxBreaksInput" value="1" min="1" max="5" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-indigo focus:border-primary-indigo dark:bg-gray-800 dark:text-white font-medium" />
                </div>
                <div class="flex-1">
                    <label for="breakDurationInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        مدة البريك (دقائق):
                    </label>
                    <select id="breakDurationInput" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-indigo focus:border-primary-indigo dark:bg-gray-800 dark:text-white font-medium">
                        <option value="15">15 دقيقة</option>
                        <option value="20">20 دقيقة</option>
                        <option value="30">30 دقيقة</option>
                    </select>
                </div>
            </div>
            
        </div>

        <!-- جدول الحجوزات -->
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
            جدول البريكات المحجوزة
        </h2>
        
        <!-- حاوية لعرض الجدول -->
        <div id="bookingsGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <!-- سيتم إنشاء مربعات الحجز ديناميكياً هنا -->
        </div>
        
        <!-- نموذج وضع المدير (Modal) -->
        <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 z-40 hidden flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg p-6 relative">
                
                <!-- عنوان وأزرار الإغلاق -->
                <div class="flex justify-between items-center border-b pb-3 mb-4 dark:border-gray-700">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">وضع المدير</h3>
                    <button id="closeAdminModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i data-feather="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <!-- نموذج تسجيل الدخول للمدير -->
                <div id="adminLoginForm">
                    <p class="text-gray-600 dark:text-gray-400 mb-3">الرجاء إدخال رمز المدير للمتابعة.</p>
                    <input type="password" id="adminCode" placeholder="رمز المدير" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-indigo focus:border-primary-indigo dark:bg-gray-700 dark:text-white font-medium mb-4" />
                    <button id="adminLoginButton" class="w-full bg-primary-indigo hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition-colors">
                        تسجيل الدخول
                    </button>
                </div>

                <!-- محتوى وضع المدير -->
                <div id="adminContent" class="hidden">
                    <div id="adminSettingsContainer" class="mb-4">
                        <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">إعدادات النظام العامة</h4>
                        <div class="flex items-center space-x-4 space-x-reverse mb-4">
                            <div class="flex-1">
                                <label for="adminMaxBreaks" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">البريكات لكل شخص:</label>
                                <input type="number" id="adminMaxBreaks" min="1" max="5" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white font-medium" />
                            </div>
                            <div class="flex-1">
                                <label for="adminBreakDuration" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">مدة البريك (دقائق):</label>
                                <select id="adminBreakDuration" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white font-medium">
                                    <option value="15">15 دقيقة</option>
                                    <option value="20">20 دقيقة</option>
                                    <option value="30">30 دقيقة</option>
                                </select>
                            </div>
                        </div>
                        <button id="saveAdminSettingsButton" class="w-full bg-secondary-green hover:bg-green-600 text-white font-bold py-2 rounded-lg transition-colors mb-4">
                            حفظ الإعدادات
                        </button>
                    </div>

                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">إدارة الحجوزات النشطة</h4>
                    <p class="text-sm font-semibold text-red-600 dark:text-red-400 mb-4">⚠️ تنبيه: الحذف هنا يؤثر على حجوزات اليوم الحالي فقط.</p>
                    <div id="adminBookingsList" class="max-h-80 overflow-y-auto no-scrollbar border border-gray-200 dark:border-gray-700 rounded-lg p-3 space-y-2">
                        <!-- قائمة الحجوزات الحالية تظهر هنا -->
                        <p id="noAdminBookings" class="text-center text-gray-500 dark:text-gray-400">لا توجد حجوزات نشطة حالياً.</p>
                    </div>
                    <button id="adminLogoutButton" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-colors mt-4">
                        تسجيل الخروج
                    </button>
                </div>

            </div>
        </div> <!-- End of main content container -->
    </div>

    <!-- ========================================================================= -->
    <!--                  Firebase & App Logic Setup (الوحدة النمطية)                -->
    <!-- ========================================================================= -->
    <script type="module">
        // استيراد وظائف Firebase المطلوبة
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================
        //                            تهيئة الثوابت والمتغيرات
        // =========================================================================

        // تفعيل وضع التصحيح (Debug) لـ Firestore
        setLogLevel('debug');

        // التأكد من أن المتغيرات العامة متوفرة أو استخدام قيم افتراضية
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const ADMIN_CODE = "1234"; // رمز المدير الثابت
        const MAX_BREAKS_FIELD = 'maxBreaks';
        const BREAK_DURATION_FIELD = 'breakDuration';
        
        // تهيئة Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // متغيرات الحالة
        let currentUserId = null;
        let isAdminMode = false;
        let currentBookings = [];
        let systemSettings = {};

        // عناوين مسارات Firestore
        const settingsDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global');
        const bookingsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'bookings');

        // العناصر
        const elements = {
            userIdDisplay: document.getElementById('userIdDisplay'),
            departmentSelect: document.getElementById('departmentSelect'),
            maxBreaksInput: document.getElementById('maxBreaksInput'),
            breakDurationInput: document.getElementById('breakDurationInput'),
            bookingsGrid: document.getElementById('bookingsGrid'),
            adminButton: document.getElementById('adminButton'),
            adminModal: document.getElementById('adminModal'),
            closeAdminModal: document.getElementById('closeAdminModal'),
            adminLoginForm: document.getElementById('adminLoginForm'),
            adminCode: document.getElementById('adminCode'),
            adminLoginButton: document.getElementById('adminLoginButton'),
            adminContent: document.getElementById('adminContent'),
            adminMaxBreaks: document.getElementById('adminMaxBreaks'),
            adminBreakDuration: document.getElementById('adminBreakDuration'),
            saveAdminSettingsButton: document.getElementById('saveAdminSettingsButton'),
            adminBookingsList: document.getElementById('adminBookingsList'),
            adminLogoutButton: document.getElementById('adminLogoutButton'),
            noAdminBookings: document.getElementById('noAdminBookings'),
        };

        // =========================================================================
        //                            الدوال المساعدة
        // =========================================================================

        /** عرض رسالة تنبيه للمستخدم */
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const messageIcon = document.getElementById('messageIcon');

            messageText.textContent = message;

            messageBox.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg shadow-2xl z-50 transition-opacity duration-300 flex items-center min-w-[300px] text-center';
            messageIcon.innerHTML = '';

            let bgColor, textColor, iconHtml;

            switch (type) {
                case 'success':
                    bgColor = 'bg-secondary-green';
                    textColor = 'text-white';
                    iconHtml = '<i data-feather="check-circle" class="w-6 h-6 ml-2"></i>';
                    break;
                case 'error':
                    bgColor = 'bg-danger-red';
                    textColor = 'text-white';
                    iconHtml = '<i data-feather="alert-octagon" class="w-6 h-6 ml-2"></i>';
                    break;
                case 'warning':
                    bgColor = 'bg-gold-star';
                    textColor = 'text-gray-800';
                    iconHtml = '<i data-feather="alert-triangle" class="w-6 h-6 ml-2"></i>';
                    break;
                case 'info':
                default:
                    bgColor = 'bg-light-blue';
                    textColor = 'text-white';
                    iconHtml = '<i data-feather="info" class="w-6 h-6 ml-2"></i>';
                    break;
            }

            messageBox.classList.add(bgColor, textColor);
            messageIcon.innerHTML = iconHtml;
            feather.replace(); // تحديث أيقونات Feather

            messageBox.classList.remove('opacity-0', 'hidden');
            messageBox.classList.add('opacity-100');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300);
            }, 4000);
        }

        /** نسخ معرف المستخدم عند النقر */
        function copyUserId() {
            if (currentUserId) {
                navigator.clipboard.writeText(currentUserId)
                    .then(() => showMessage("تم نسخ معرّف المستخدم بنجاح!", 'success'))
                    .catch(() => showMessage("فشل في النسخ. يرجى النسخ يدوياً.", 'warning'));
            }
        }
        window.copyUserId = copyUserId; // لجعلها متاحة لـ onclick في HTML

        /** تحويل كائن التاريخ إلى سلسلة زمنية (HH:MM) */
        function formatTime(date) {
            return date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: false });
        }
        
        /** تحويل التاريخ إلى مفتاح يومي (YYYY-MM-DD) */
        function getTodayKey() {
            return new Date().toISOString().split('T')[0];
        }

        /** بناء قائمة الفترات الزمنية المتاحة (8:00 إلى 16:00) */
        function generateTimeSlots(durationMinutes) {
            const slots = [];
            const startTime = new Date();
            startTime.setHours(8, 0, 0, 0); // 8:00 AM

            const endTime = new Date();
            endTime.setHours(16, 0, 0, 0); // 4:00 PM (Exclusive)

            let currentTime = startTime;

            while (currentTime.getTime() < endTime.getTime()) {
                const start = new Date(currentTime);
                currentTime.setMinutes(currentTime.getMinutes() + durationMinutes);
                const end = new Date(currentTime);

                if (end.getTime() <= endTime.getTime()) {
                    slots.push({
                        id: `${formatTime(start)}-${formatTime(end)}`,
                        start: formatTime(start),
                        end: formatTime(end),
                    });
                }
            }
            return slots;
        }

        // =========================================================================
        //                            وظائف المصادقة (Auth)
        // =========================================================================

        /** الوظيفة الرئيسية لتسجيل الدخول وتحديد معرف المستخدم */
        async function initAuthAndApp() {
            try {
                // محاولة تسجيل الدخول باستخدام الرمز المخصص (Custom Token)
                if (initialAuthToken) {
                    console.log("Attempting sign in with Custom Token...");
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Sign in with Custom Token successful.");
                } else {
                    console.warn("Custom Auth Token is not available. Proceeding to check for existing session/local ID.");
                }
            } catch (error) {
                // *** FIX: تجنب signInAnonymously الذي يسبب خطأ App Check ***
                console.error("Firebase Sign-in Failed (Custom Token Error, bypassing Anonymous Sign-in):", error.message);
            }

            // مراقبة حالة المصادقة وتحديد معرف المستخدم النهائي
            onAuthStateChanged(auth, (user) => {
                let userId = null;
                
                if (user) {
                    // 1. المستخدم مصادق عليه عبر الرمز المخصص (أو أي طريقة أخرى)
                    userId = user.uid;
                    console.log(`User Signed In. UID: ${userId}`);
                } else {
                    // 2. المستخدم غير مصادق عليه: استخدام معرف فريد محلي
                    userId = localStorage.getItem('localUserId');
                    if (!userId) {
                        userId = crypto.randomUUID();
                        localStorage.setItem('localUserId', userId);
                    }
                    console.log(`User Not Signed In. Using Local ID: ${userId}`);
                }

                currentUserId = userId;
                elements.userIdDisplay.textContent = currentUserId;

                // بدء تهيئة التطبيق بمنطقية بعد تحديد معرف المستخدم
                initApp(currentUserId);
            });
        }

        // =========================================================================
        //                      وظائف التطبيق الرئيسية (App Logic)
        // =========================================================================

        /** تهيئة التطبيق بعد المصادقة */
        function initApp(userId) {
            console.log("Application Initialized for User:", userId);
            
            loadSystemSettings(); // تحميل الإعدادات أولاً
            setupBookingsListener(); // ثم الاستماع للحجوزات
            setupEventListeners(); // إعداد المستمعين لواجهة المستخدم
        }

        /** تحميل إعدادات النظام وتعيين المستمع */
        function loadSystemSettings() {
            onSnapshot(settingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    systemSettings = docSnap.data();
                    console.log("System Settings loaded:", systemSettings);
                } else {
                    // إعدادات افتراضية في حالة عدم وجود مستند
                    systemSettings = {
                        [MAX_BREAKS_FIELD]: 1,
                        [BREAK_DURATION_FIELD]: 15,
                        adminLoggedIn: false
                    };
                    // إنشاء المستند الافتراضي إذا لم يكن موجوداً
                    setDoc(settingsDocRef, systemSettings, { merge: true }).catch(e => console.error("Error creating default settings:", e));
                }
                applySettingsToUI();
                renderTimeSlots(); // إعادة رسم الأوقات بعد تحديث الإعدادات
            }, (error) => {
                console.error("Error fetching settings:", error);
                showMessage("خطأ في تحميل إعدادات النظام.", 'error');
            });
        }
        
        /** تطبيق الإعدادات المحملة على واجهة المستخدم */
        function applySettingsToUI() {
            elements.maxBreaksInput.value = systemSettings[MAX_BREAKS_FIELD] || 1;
            elements.breakDurationInput.value = systemSettings[BREAK_DURATION_FIELD] || 15;

            // تحديث وضع المدير في حال خروج المدير من مكان آخر
            if (isAdminMode && !systemSettings.adminLoggedIn) {
                logoutAdmin();
            }
        }

        /** إعداد مستمع الحجوزات في الوقت الفعلي */
        function setupBookingsListener() {
            // فلترة الحجوزات لليوم الحالي فقط
            const todayKey = getTodayKey();
            const q = query(bookingsCollectionRef, where("dateKey", "==", todayKey));

            onSnapshot(q, (snapshot) => {
                currentBookings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Current Bookings updated:", currentBookings);
                renderTimeSlots();
                if (isAdminMode) {
                    renderAdminBookings();
                }
            }, (error) => {
                console.error("Error fetching bookings:", error);
                showMessage("خطأ في تحميل الحجوزات.", 'error');
            });
        }

        /** رسم مربعات الأوقات وتحديث حالتها */
        function renderTimeSlots() {
            const duration = parseInt(elements.breakDurationInput.value || 15);
            const slots = generateTimeSlots(duration);
            elements.bookingsGrid.innerHTML = '';
            
            const selectedDepartment = elements.departmentSelect.value;
            const maxBreaks = parseInt(elements.maxBreaksInput.value || 1);

            slots.forEach(slot => {
                // فحص الحجوزات لهذا القسم ولهذا الوقت
                const booking = currentBookings.find(b => b.timeSlotId === slot.id && b.department === selectedDepartment);

                let status = 'available';
                let buttonText = 'حجز';
                let bgColor = 'bg-secondary-green hover:bg-green-600';
                let textColor = 'text-white';
                let userBreakCount = currentBookings.filter(b => b.userId === currentUserId && b.department === selectedDepartment).length;
                let isBookedByUser = false;

                if (booking) {
                    if (booking.userId === currentUserId) {
                        status = 'booked-by-user';
                        buttonText = 'إلغاء الحجز';
                        bgColor = 'bg-danger-red hover:bg-red-600';
                        textColor = 'text-white';
                        isBookedByUser = true;
                    } else {
                        status = 'booked-by-other';
                        buttonText = 'محجوز';
                        bgColor = 'bg-gray-400 dark:bg-gray-600';
                        textColor = 'text-gray-900 dark:text-gray-100';
                    }
                } else if (userBreakCount >= maxBreaks) {
                    status = 'limit-reached';
                    buttonText = 'تم تجاوز الحد';
                    bgColor = 'bg-gray-200 dark:bg-gray-700';
                    textColor = 'text-gray-500 dark:text-gray-400';
                }

                // تحديد ما إذا كان الزر معطلاً
                const isDisabled = (status === 'booked-by-other' || status === 'limit-reached') && !isBookedByUser;
                const cursorStyle = isDisabled ? 'cursor-not-allowed' : 'cursor-pointer';

                const slotHTML = `
                    <div class="p-3 border rounded-lg shadow-sm transition-all duration-200 ${booking ? (isBookedByUser ? 'border-danger-red dark:border-red-500' : 'border-gray-300 dark:border-gray-600') : 'border-secondary-green dark:border-green-500'} dark:bg-gray-700">
                        <p class="text-sm font-bold text-gray-900 dark:text-white">${slot.start} - ${slot.end}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">
                            ${booking ? (isBookedByUser ? 'حجزك' : `محجوز بواسطة: ${booking.userId.substring(0, 8)}...`) : 'متاح'}
                        </p>
                        <button 
                            class="w-full text-xs font-semibold py-2 rounded-md transition-colors ${bgColor} ${textColor} ${isDisabled ? 'opacity-50' : ''} ${cursorStyle}"
                            data-slot-id="${slot.id}"
                            data-booking-id="${booking ? booking.id : ''}"
                            data-is-booked-by-user="${isBookedByUser}"
                            ${isDisabled ? 'disabled' : ''}
                        >
                            ${buttonText}
                        </button>
                    </div>
                `;
                elements.bookingsGrid.insertAdjacentHTML('beforeend', slotHTML);
            });

            // إضافة مستمعي الأحداث لمربعات الحجز الجديدة
            elements.bookingsGrid.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', () => handleBooking(button));
            });
        }

        /** معالجة حجز أو إلغاء حجز فترة زمنية */
        async function handleBooking(button) {
            const slotId = button.dataset.slotId;
            const bookingId = button.dataset.bookingId;
            const isBookedByUser = button.dataset.isBookedByUser === 'true';
            const department = elements.departmentSelect.value;
            
            // تحقق من وجود معرف المستخدم
            if (!currentUserId) {
                showMessage("لا يمكن المتابعة. فشل في تحديد معرف المستخدم.", 'error');
                return;
            }

            if (isBookedByUser) {
                // إلغاء الحجز
                try {
                    await setDoc(doc(bookingsCollectionRef, bookingId), {
                        deleted: true,
                        deletedAt: new Date(),
                        deletedBy: currentUserId
                    }, { merge: true });
                    showMessage("تم إلغاء حجز البريك بنجاح.", 'success');
                } catch (e) {
                    console.error("Error cancelling booking:", e);
                    showMessage("فشل في إلغاء الحجز.", 'error');
                }
            } else {
                // حجز جديد
                try {
                    // تحقق مزدوج من الحد الأقصى للحجوزات
                    const maxBreaks = parseInt(elements.maxBreaksInput.value || 1);
                    const userBreakCount = currentBookings.filter(b => b.userId === currentUserId && b.department === department && !b.deleted).length;

                    if (userBreakCount >= maxBreaks) {
                        showMessage(`لقد وصلت إلى الحد الأقصى للحجوزات (${maxBreaks}) في هذا القسم.`, 'warning');
                        return;
                    }

                    // تحقق من أن الفترة غير محجوزة بالفعل (للحد من التعارضات المتزامنة)
                    const existingBooking = currentBookings.find(b => b.timeSlotId === slotId && b.department === department && !b.deleted);
                    if (existingBooking) {
                        showMessage("هذه الفترة محجوزة للتو من قبل شخص آخر. يرجى التحديث والمحاولة مرة أخرى.", 'warning');
                        return;
                    }

                    const newBookingData = {
                        timeSlotId: slotId,
                        department: department,
                        userId: currentUserId,
                        dateKey: getTodayKey(),
                        createdAt: new Date(),
                        deleted: false
                    };

                    // Firestore's addDoc will automatically generate a unique ID
                    await setDoc(doc(bookingsCollectionRef, `${slotId}-${department}-${getTodayKey()}`), newBookingData);
                    showMessage("تم حجز البريك بنجاح!", 'success');

                } catch (e) {
                    console.error("Error setting booking:", e);
                    showMessage("فشل في حجز البريك. يرجى المحاولة مرة أخرى.", 'error');
                }
            }
        }

        /** عرض قائمة الحجوزات لوضع المدير */
        function renderAdminBookings() {
            elements.adminBookingsList.innerHTML = '';
            
            const activeBookings = currentBookings.filter(b => !b.deleted).sort((a, b) => a.timeSlotId.localeCompare(b.timeSlotId));

            if (activeBookings.length === 0) {
                elements.noAdminBookings.classList.remove('hidden');
            } else {
                elements.noAdminBookings.classList.add('hidden');
                activeBookings.forEach(booking => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-700 rounded-lg';
                    listItem.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 dark:text-white truncate">${booking.timeSlotId}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">القسم: ${booking.department} | المستخدم: ${booking.userId.substring(0, 12)}...</p>
                        </div>
                        <button class="admin-delete-booking bg-danger-red hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded-md ml-2 transition-colors" data-id="${booking.id}">
                            حذف
                        </button>
                    `;
                    elements.adminBookingsList.appendChild(listItem);
                });

                elements.adminBookingsList.querySelectorAll('.admin-delete-booking').forEach(button => {
                    button.addEventListener('click', (e) => handleAdminDeleteBooking(e.currentTarget.dataset.id));
                });
            }
        }

        /** معالجة حذف حجز في وضع المدير */
        async function handleAdminDeleteBooking(bookingId) {
            try {
                await setDoc(doc(bookingsCollectionRef, bookingId), {
                    deleted: true,
                    deletedAt: new Date(),
                    deletedBy: currentUserId,
                    adminDeleted: true
                }, { merge: true });
                showMessage("تم حذف الحجز بنجاح (وضع المدير).", 'warning');
            } catch (e) {
                console.error("Error deleting booking (Admin):", e);
                showMessage("فشل في حذف الحجز.", 'error');
            }
        }
        
        /** حفظ إعدادات المدير */
        async function saveAdminSettings() {
            const newMaxBreaks = parseInt(elements.adminMaxBreaks.value);
            const newDuration = parseInt(elements.adminBreakDuration.value);
            
            if (isNaN(newMaxBreaks) || isNaN(newDuration) || newMaxBreaks < 1) {
                showMessage("قيمة الإعدادات غير صالحة.", 'error');
                return;
            }

            try {
                await updateDoc(settingsDocRef, {
                    [MAX_BREAKS_FIELD]: newMaxBreaks,
                    [BREAK_DURATION_FIELD]: newDuration
                });
                showMessage("تم حفظ الإعدادات بنجاح.", 'success');
            } catch (e) {
                console.error("Error saving admin settings:", e);
                showMessage("فشل في حفظ الإعدادات.", 'error');
            }
        }

        /** تسجيل دخول المدير */
        async function loginAdmin() {
            const code = elements.adminCode.value;
            if (code === ADMIN_CODE) {
                try {
                    // تحديث حالة المدير في Firestore لمنع التزامن المتعدد
                    await updateDoc(settingsDocRef, { adminLoggedIn: true, adminUserId: currentUserId, adminLoginTime: new Date() });
                    isAdminMode = true;
                    elements.adminLoginForm.classList.add('hidden');
                    elements.adminContent.classList.remove('hidden');
                    
                    // تحديث قيم الإدخال في وضع المدير
                    elements.adminMaxBreaks.value = systemSettings[MAX_BREAKS_FIELD];
                    elements.adminBreakDuration.value = systemSettings[BREAK_DURATION_FIELD];
                    
                    renderAdminBookings();
                    showMessage("تم تسجيل الدخول كمدير بنجاح!", 'success');
                } catch (e) {
                    console.error("Error setting admin state:", e);
                    showMessage("فشل في تسجيل الدخول كمدير. يرجى المحاولة مرة أخرى.", 'error');
                }

            } else {
                showMessage("رمز المدير غير صحيح.", 'error');
            }
        }

        /** تسجيل خروج المدير */
        async function logoutAdmin() {
            try {
                // تحديث حالة المدير في Firestore
                await updateDoc(settingsDocRef, { adminLoggedIn: false, adminUserId: null });
                isAdminMode = false;
                elements.adminContent.classList.add('hidden');
                elements.adminLoginForm.classList.remove('hidden');
                elements.adminCode.value = ''; // مسح الرمز
                showMessage("تم تسجيل الخروج من وضع المدير.", 'info');
            } catch (e) {
                console.error("Error logging out admin:", e);
                // يمكن السماح بالخروج محلياً حتى إذا فشل تحديث Firestore
                isAdminMode = false;
                elements.adminContent.classList.add('hidden');
                elements.adminLoginForm.classList.remove('hidden');
                elements.adminCode.value = '';
                showMessage("تم تسجيل الخروج محلياً، حدث خطأ في تحديث قاعدة البيانات.", 'warning');
            }
        }


        /** إعداد مستمعي أحداث الواجهة */
        function setupEventListeners() {
            elements.departmentSelect.addEventListener('change', renderTimeSlots);
            elements.breakDurationInput.addEventListener('change', renderTimeSlots);
            elements.maxBreaksInput.addEventListener('change', renderTimeSlots);
            
            // فتح نافذة المدير
            elements.adminButton.addEventListener('click', () => {
                // منع الفتح إذا كان هناك مدير آخر مسجل الدخول
                if (systemSettings.adminLoggedIn && systemSettings.adminUserId !== currentUserId) {
                    showMessage("مدير آخر يقوم بتعديل الإعدادات حالياً.", 'warning');
                    return;
                }
                elements.adminModal.classList.remove('hidden');
                feather.replace(); // تحديث الأيقونات في النافذة
            });

            // إغلاق نافذة المدير
            elements.closeAdminModal.addEventListener('click', () => {
                elements.adminModal.classList.add('hidden');
            });
            
            // معالجة تسجيل الدخول للمدير
            elements.adminLoginButton.addEventListener('click', loginAdmin);
            
            // معالجة تسجيل الخروج للمدير
            elements.adminLogoutButton.addEventListener('click', logoutAdmin);
            
            // حفظ إعدادات المدير
            elements.saveAdminSettingsButton.addEventListener('click', saveAdminSettings);
        }

        // بدء عملية المصادقة والتطبيق
        document.addEventListener('DOMContentLoaded', () => {
            initAuthAndApp();
            feather.replace(); // استبدال الأيقونات عند تحميل DOM
        });
        
    </script>
</body>
</html>
