<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Break Time Buddy - جدول حجز البريكات للأقسام</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        // =========================================================================
        //                 إعدادات Tailwind CSS المخصصة (Configuration)
        // =========================================================================
        // تحديد الثيمات والألوان الأساسية التي سيتم استخدامها في التصميم
        tailwind.config = {
            darkMode: 'class', // تفعيل الوضع الداكن بناءً على الكلاس 'dark' في عنصر <html>
            theme: {
                extend: {
                    // تعريف ألوان مخصصة للنظام لسهولة تغيير الثيم
                    colors: {
                        'primary-indigo': '#4f46e5',   // اللون الأساسي: أزرق نيلي
                        'secondary-green': '#10b981', // اللون الثانوي: أخضر لعمليات النجاح والحجز المتاح
                        'danger-red': '#ef4444',      // لون الخطر: أحمر لعمليات الحذف أو الأخطاء
                        'gold-star': '#facc15',       // لون الذهب: للتنبيهات والتحذيرات
                        'light-blue': '#3b82f6',      // لون أزرق فاتح: للمعلومات والحالة
                    }
                }
            }
        }
    </script>
<style>
    /* إخفاء شريط التمرير ولكن السماح بالتمرير (لتحسين تجربة المستخدم) */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }

    /* تأثيرات CSS إضافية للحالة الداكنة والتخطيط العام */
    body {
        font-family: 'Inter', sans-serif; /* استخدام خط Inter */
        transition: background-color 0.3s, color 0.3s;
    }
    .card {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
    }
    .dark .card {
        box-shadow: 0 10px 15px -3px rgba(255, 255, 255, 0.05), 0 4px 6px -4px rgba(255, 255, 255, 0.05);
    }

    /* تخصيص إطار التنبيه (Modal) */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.75);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 50;
    }
</style>

<!-- ========================================================================= -->
<!--             إعدادات وتهيئة Firebase (مطلوب للتعامل مع البيانات)          -->
<!-- ========================================================================= -->
<script type="module">
    // استيراد وظائف Firebase الأساسية
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, where, addDoc, updateDoc, deleteDoc, doc, Timestamp, setLogLevel, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // تعريف المتغيرات العامة التي سيتم استخدامها في التطبيق
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

    let db = null;
    let auth = null;
    let userId = null;
    let isAuthReady = false; // flag to indicate firebase is initialized and auth state is known
    
    // =========================================================================
    //               وظائف مسارات Firestore (تبعاً لقواعد الأمان)
    // =========================================================================
    /**
     * يحصل على مسار مجموعة الحجوزات العامة.
     * المسار وفقاً لقواعد الأمان هو: /artifacts/{appId}/public/data/public_bookings
     */
    function getPublicBookingsCollectionPath() {
        return `artifacts/${appId}/public/data/public_bookings`;
    }

    /**
     * تهيئة Firebase والمصادقة.
     */
    async function initializeFirebase() {
        try {
            // تفعيل سجلات التصحيح لرؤية عمليات Firestore في الـ console
            setLogLevel('debug');

            // 1. التهيئة
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // 2. المصادقة (تعتمد على التوكن المخصص أو التسجيل المجهول)
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
                console.log("Firebase: تم تسجيل الدخول باستخدام التوكن المخصص.");
            } else {
                await signInAnonymously(auth);
                console.log("Firebase: تم تسجيل الدخول كمجهول.");
            }

            // 3. مستمع لتغير حالة المصادقة
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // استخدام الـ UID كمعرّف للمستخدمين الموثقين
                    userId = user.uid;
                    console.log("User ID set:", userId);
                } else {
                    // استخدام UUID عشوائي كمعرّف للمستخدمين غير الموثقين
                    userId = crypto.randomUUID();
                    console.log("User signed out, using fallback UUID:", userId);
                }
                isAuthReady = true;
                console.log("Firebase: المصادقة جاهزة، يمكن بدء منطق التطبيق.");
                
                // **** هنا يمكنك استدعاء الدالة الرئيسية لبدء التطبيق والتفاعل مع Firestore ****
                // مثال: startApplicationLogic();
                setupEventListeners();
                if (window.adminModalInstance && window.adminModalInstance.isOpen) {
                    loadAdminData(); // تحميل البيانات إذا كانت لوحة المدير مفتوحة
                }
            });

        } catch (error) {
            console.error("خطأ في تهيئة أو مصادقة Firebase:", error);
            // قد تحتاج إلى إظهار رسالة خطأ للمستخدم هنا
        }
    }

    // استدعاء دالة التهيئة عند تحميل الصفحة
    initializeFirebase();

    // جعل المتغيرات متاحة عالمياً (ضروري لتفاعل باقي سكريبتات الصفحة معها)
    window.db = db;
    window.auth = auth;
    window.userId = userId;
    window.isAuthReady = isAuthReady;
    window.getPublicBookingsCollectionPath = getPublicBookingsCollectionPath;
    window.Timestamp = Timestamp;
    window.collection = collection;
    window.addDoc = addDoc;
    window.query = query;
    window.onSnapshot = onSnapshot;
    window.where = where;
    window.doc = doc;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.getDocs = getDocs;

    // =========================================================================
    //                 منطق واجهة المستخدم (UI Logic)
    // =========================================================================

    // بيانات الفترات المتاحة للحجز (الاسم ، المدة بالدقائق)
    const breakPeriods = [
        { name: 'البريك الأول', duration: 15 },
        { name: 'البريك الثاني', duration: 15 },
        { name: 'البريك الثالث', duration: 15 },
        { name: 'البريك الرابع', duration: 15 }
    ];
    
    // قائمة الأقسام (يمكن تحديثها)
    const departments = [
        "قسم التسويق",
        "قسم المبيعات",
        "قسم الموارد البشرية",
        "قسم التطوير",
        "قسم المالية"
    ];

    let currentBookings = []; // لتخزين الحجوزات الحالية محليًا
    let selectedDepartment = departments[0]; // القسم الافتراضي
    let selectedBreak = breakPeriods[0].name; // البريك الافتراضي
    let isBookingLoading = false; // حالة التحميل للحجز

    /**
     * دالة مساعدة لإنشاء وإدارة إطار التنبيه/الرسائل
     * (بديل لـ alert() و confirm())
     */
    function showMessageModal(title, message, type = 'info') {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.id = 'messageModalOverlay';

        let bgColor = '';
        let icon = '';
        let iconColor = '';
        let btnColor = '';

        switch (type) {
            case 'success':
                bgColor = 'bg-secondary-green/10 dark:bg-secondary-green/20';
                icon = '<i data-feather="check-circle" class="w-7 h-7"></i>';
                iconColor = 'text-secondary-green';
                btnColor = 'bg-secondary-green hover:bg-emerald-600';
                break;
            case 'error':
                bgColor = 'bg-danger-red/10 dark:bg-danger-red/20';
                icon = '<i data-feather="alert-triangle" class="w-7 h-7"></i>';
                iconColor = 'text-danger-red';
                btnColor = 'bg-danger-red hover:bg-red-600';
                break;
            case 'warning':
                bgColor = 'bg-gold-star/10 dark:bg-gold-star/20';
                icon = '<i data-feather="alert-octagon" class="w-7 h-7"></i>';
                iconColor = 'text-gold-star';
                btnColor = 'bg-gold-star hover:bg-yellow-600';
                break;
            default:
                bgColor = 'bg-light-blue/10 dark:bg-light-blue/20';
                icon = '<i data-feather="info" class="w-7 h-7"></i>';
                iconColor = 'text-light-blue';
                btnColor = 'bg-light-blue hover:bg-blue-600';
                break;
        }

        overlay.innerHTML = `
            <div class="card p-6 w-11/12 max-w-sm rounded-xl ${bgColor} dark:bg-gray-800 border-t-4 ${iconColor.replace('text-', 'border-')} transform transition-all scale-100 animate-in fade-in zoom-in-50">
                <div class="flex items-start">
                    <div class="flex-shrink-0 ${iconColor}">
                        ${icon}
                    </div>
                    <div class="mr-4 w-full">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">${title}</h3>
                        <p class="text-sm text-gray-700 dark:text-gray-300">${message}</p>
                    </div>
                </div>
                <div class="mt-5">
                    <button id="closeModalButton" class="w-full ${btnColor} text-white font-bold py-2 rounded-lg transition-colors shadow-md hover:shadow-lg">
                        إغلاق
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
        feather.replace(); // إعادة تحميل الأيقونات داخل الـ modal

        document.getElementById('closeModalButton').onclick = () => {
            overlay.remove();
        };
    }
    
    /**
     * دالة مساعدة لإنشاء وإدارة إطار التنبيه/الرسائل (للتأكيد)
     * (بديل لـ confirm())
     */
    function showConfirmationModal(title, message, onConfirm) {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.id = 'confirmationModalOverlay';

        overlay.innerHTML = `
            <div class="card p-6 w-11/12 max-w-sm rounded-xl bg-white dark:bg-gray-800 border-t-4 border-danger-red transform transition-all scale-100 animate-in fade-in zoom-in-50">
                <div class="flex items-start">
                    <div class="flex-shrink-0 text-danger-red">
                        <i data-feather="alert-triangle" class="w-7 h-7"></i>
                    </div>
                    <div class="mr-4 w-full">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">${title}</h3>
                        <p class="text-sm text-gray-700 dark:text-gray-300">${message}</p>
                    </div>
                </div>
                <div class="mt-5 flex justify-end space-x-3 space-x-reverse">
                    <button id="cancelButton" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        إلغاء
                    </button>
                    <button id="confirmButton" class="px-4 py-2 text-sm font-semibold text-white bg-danger-red hover:bg-red-600 rounded-lg transition-colors shadow-md hover:shadow-lg">
                        تأكيد الحذف
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
        feather.replace();

        const close = () => overlay.remove();

        document.getElementById('cancelButton').onclick = close;
        document.getElementById('confirmButton').onclick = () => {
            onConfirm();
            close();
        };
    }

    /**
     * إنشاء خيارات القائمة المنسدلة للأقسام.
     */
    function populateDepartmentDropdown() {
        const select = document.getElementById('departmentSelect');
        if (!select) return;

        select.innerHTML = '';
        departments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept;
            option.textContent = dept;
            select.appendChild(option);
        });
        select.value = selectedDepartment; // تعيين القيمة الافتراضية
    }

    /**
     * إنشاء أزرار الفترات الزمنية.
     */
    function renderBreakButtons() {
        const container = document.getElementById('breakButtonsContainer');
        if (!container) return;

        container.innerHTML = '';
        breakPeriods.forEach((period, index) => {
            const isSelected = period.name === selectedBreak;
            const button = document.createElement('button');
            button.className = `
                px-4 py-3 rounded-xl font-bold transition-all duration-200 text-sm md:text-base
                ${isSelected
                    ? 'bg-primary-indigo text-white shadow-lg shadow-indigo-500/50 scale-105'
                    : 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'
                }
            `;
            button.textContent = period.name;
            button.dataset.breakName = period.name;
            button.onclick = () => selectBreak(period.name);
            container.appendChild(button);
        });
    }

    /**
     * تحديث حالة البريك المختار.
     */
    function selectBreak(breakName) {
        selectedBreak = breakName;
        renderBreakButtons();
        updateBookingSummary();
        renderBookingGrid();
    }
    
    /**
     * تحديث ملخص الحجز أسفل القائمة المنسدلة.
     */
    function updateBookingSummary() {
        const summaryElement = document.getElementById('bookingSummary');
        if (!summaryElement) return;

        const totalBookings = currentBookings.filter(b => b.breakName === selectedBreak).length;
        const maxCapacity = 2; // الحد الأقصى الافتراضي للحجز (يمكن جعله إعداداً)
        const remainingSlots = maxCapacity - totalBookings;

        let statusText = '';
        let statusColor = '';

        if (remainingSlots > 0) {
            statusText = `توجد ${remainingSlots} أماكن متاحة للحجز.`;
            statusColor = 'text-secondary-green dark:text-emerald-400';
        } else {
            statusText = 'البريك محجوز بالكامل، اختر وقتاً آخر.';
            statusColor = 'text-danger-red dark:text-red-400';
        }

        // تحديث زر الحجز بناءً على التوفر
        const bookButton = document.getElementById('bookBreakButton');
        if (bookButton) {
            bookButton.disabled = remainingSlots <= 0 || isBookingLoading;
            bookButton.classList.toggle('opacity-50', remainingSlots <= 0 || isBookingLoading);
            bookButton.textContent = isBookingLoading ? 'جاري الحجز...' : 'حجز البريك';
        }

        summaryElement.innerHTML = `
            <span class="text-xs font-semibold ${statusColor}">
                ${selectedBreak}: ${statusText}
            </span>
        `;
    }

    /**
     * عرض شبكة الحجوزات الحالية (الجدول).
     */
    function renderBookingGrid() {
        const gridContainer = document.getElementById('bookingGrid');
        if (!gridContainer) return;

        const relevantBookings = currentBookings.filter(b => b.breakName === selectedBreak);
        gridContainer.innerHTML = ''; // مسح المحتوى القديم

        if (relevantBookings.length === 0) {
            gridContainer.innerHTML = `
                <div class="text-center p-6 text-gray-500 dark:text-gray-400">
                    <i data-feather="calendar" class="w-10 h-10 mx-auto mb-2"></i>
                    <p class="font-medium">لم يتم حجز ${selectedBreak} بعد.</p>
                </div>
            `;
            feather.replace();
            return;
        }

        relevantBookings.forEach(booking => {
            const isUserBooking = booking.userId === userId; // تحديد ما إذا كان الحجز للمستخدم الحالي
            const bookingTime = booking.createdAt ? new Date(booking.createdAt.seconds * 1000).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit', hour12: true }) : 'وقت غير متوفر';

            const card = document.createElement('div');
            card.className = `
                p-4 rounded-xl border-r-4 shadow-md transition-shadow duration-300
                ${isUserBooking
                    ? 'bg-primary-indigo/10 dark:bg-primary-indigo/20 border-primary-indigo hover:shadow-lg'
                    : 'bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 hover:shadow-lg'
                }
            `;
            
            card.innerHTML = `
                <div class="flex items-center justify-between">
                    <p class="font-bold text-gray-800 dark:text-white">${booking.departmentName}</p>
                    <span class="text-xs font-semibold text-gray-500 dark:text-gray-400">${bookingTime}</span>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">${booking.breakName}</p>
                
                ${isUserBooking ? `
                    <div class="mt-3 flex justify-end">
                        <button data-id="${booking.id}" class="cancel-booking-btn text-xs font-semibold text-danger-red hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 transition-colors flex items-center">
                            <i data-feather="trash-2" class="w-4 h-4 ml-1"></i>
                            إلغاء الحجز
                        </button>
                    </div>
                ` : ''}
            `;
            gridContainer.appendChild(card);
        });

        feather.replace(); // إعادة تحميل الأيقونات

        // إرفاق مستمعي الأحداث لأزرار الإلغاء
        document.querySelectorAll('.cancel-booking-btn').forEach(button => {
            button.onclick = (e) => {
                const bookingId = e.currentTarget.dataset.id;
                handleCancelBooking(bookingId);
            };
        });
    }

    /**
     * معالجة محاولة الحجز.
     */
    async function handleBookBreak() {
        if (!isAuthReady || !db || !userId) {
            showMessageModal('خطأ في الاتصال', 'الرجاء الانتظار حتى يتم الاتصال بخدمة قاعدة البيانات.', 'warning');
            return;
        }

        // 1. التحقق من وجود حجز لنفس المستخدم لهذا البريك اليوم
        const existingUserBooking = currentBookings.find(b => 
            b.userId === userId && b.breakName === selectedBreak
        );
        if (existingUserBooking) {
            showMessageModal('حجز مكرر', `لقد قمت بالفعل بحجز ${selectedBreak} اليوم.`, 'warning');
            return;
        }

        // 2. التحقق من السعة المتبقية
        const maxCapacity = 2; 
        const totalBookings = currentBookings.filter(b => b.breakName === selectedBreak).length;
        if (totalBookings >= maxCapacity) {
            showMessageModal('محجوز بالكامل', `عفواً، ${selectedBreak} محجوز بالكامل لهذا اليوم.`, 'error');
            return;
        }

        // 3. التحضير للحجز
        const newBooking = {
            departmentName: selectedDepartment,
            breakName: selectedBreak,
            userId: userId,
            createdAt: Timestamp.now(),
            dateString: new Date().toISOString().slice(0, 10) // لتسهيل الفلترة اليومية
        };

        isBookingLoading = true;
        updateBookingSummary(); // تحديث حالة زر الحجز
        
        try {
            // إضافة الوثيقة إلى مجموعة الحجوزات العامة
            const colRef = collection(db, getPublicBookingsCollectionPath());
            await addDoc(colRef, newBooking);
            
            showMessageModal('تم الحجز بنجاح', `تم حجز ${selectedBreak} لقسم ${selectedDepartment}.`, 'success');

        } catch (error) {
            console.error("خطأ في إضافة الحجز:", error);
            showMessageModal('فشل الحجز', 'حدث خطأ أثناء محاولة حجز البريك. الرجاء المحاولة مرة أخرى.', 'error');
        } finally {
            isBookingLoading = false;
            updateBookingSummary(); // إعادة زر الحجز لوضعه الطبيعي
        }
    }

    /**
     * معالجة إلغاء الحجز.
     */
    function handleCancelBooking(bookingId) {
        showConfirmationModal(
            'تأكيد الإلغاء', 
            'هل أنت متأكد من رغبتك في إلغاء هذا الحجز؟ لا يمكن التراجع عن هذا الإجراء.',
            async () => {
                if (!isAuthReady || !db) return;
                
                try {
                    // حذف الوثيقة من Firestore
                    const docRef = doc(db, getPublicBookingsCollectionPath(), bookingId);
                    await deleteDoc(docRef);
                    showMessageModal('تم الإلغاء', 'تم إلغاء حجزك بنجاح.', 'success');
                } catch (error) {
                    console.error("خطأ في إلغاء الحجز:", error);
                    showMessageModal('فشل الإلغاء', 'حدث خطأ أثناء إلغاء الحجز. الرجاء المحاولة مرة أخرى.', 'error');
                }
            }
        );
    }

    // =========================================================================
    //               تحميل البيانات في الوقت الفعلي (Firestore Listener)
    // =========================================================================
    function startDataListener() {
        if (!isAuthReady || !db) {
            // إذا لم تكن المصادقة جاهزة، انتظر حتى يتم تشغيل onAuthStateChanged
            console.log("Firestore Listener: المصادقة غير جاهزة بعد، جاري الانتظار...");
            return; 
        }

        const today = new Date().toISOString().slice(0, 10); // تنسيق YYYY-MM-DD
        const bookingsColRef = collection(db, getPublicBookingsCollectionPath());
        
        // إنشاء استعلام للحجوزات ليومنا هذا فقط
        const q = query(
            bookingsColRef,
            where("dateString", "==", today)
        );

        // إنشاء مستمع onSnapshot للتحديثات في الوقت الفعلي
        onSnapshot(q, (snapshot) => {
            console.log("Firestore: تم استلام تحديث جديد للحجوزات.");
            
            // تحويل البيانات من Firestore إلى مصفوفة JavaScript
            currentBookings = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));

            // إعادة عرض الواجهة بناءً على البيانات الجديدة
            renderBookingGrid();
            updateBookingSummary();
            // تحديث لوحة المدير إذا كانت مفتوحة
            if (window.adminModalInstance && window.adminModalInstance.isOpen) {
                renderAdminBookings();
            }

        }, (error) => {
            console.error("خطأ في مستمع Firestore:", error);
            showMessageModal('خطأ في الاتصال', 'فشل الاتصال بقاعدة البيانات. الرجاء تحديث الصفحة.', 'error');
        });
    }

    // =========================================================================
    //                       منطق لوحة المدير (Admin Panel Logic)
    // =========================================================================

    const ADMIN_CODE = "12345"; // رمز المدير الافتراضي

    let adminModalInstance = {
        isOpen: false,
        element: null
    };

    /**
     * فتح أو إغلاق لوحة المدير.
     */
    function toggleAdminModal(open) {
        const modal = document.getElementById('adminModal');
        if (!modal) return;

        if (open) {
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            adminModalInstance.isOpen = true;
            // إخفاء محتوى المدير حتى يتم تسجيل الدخول
            document.getElementById('adminContent').classList.add('hidden');
            document.getElementById('adminLoginForm').classList.remove('hidden');
            document.getElementById('adminCode').value = '';

            // تفعيل listener عندما يتم فتح اللوحة
            if (isAuthReady) {
                loadAdminData();
            }
        } else {
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            adminModalInstance.isOpen = false;
        }
    }
    
    /**
     * محاولة تسجيل الدخول للمدير.
     */
    function handleAdminLogin() {
        const codeInput = document.getElementById('adminCode');
        if (codeInput.value === ADMIN_CODE) {
            document.getElementById('adminLoginForm').classList.add('hidden');
            document.getElementById('adminContent').classList.remove('hidden');
            loadAdminData();
            showMessageModal('نجاح', 'تم تسجيل الدخول كمدير.', 'success');
        } else {
            showMessageModal('خطأ', 'رمز المدير غير صحيح.', 'error');
        }
    }

    /**
     * تسجيل خروج المدير.
     */
    function handleAdminLogout() {
        document.getElementById('adminContent').classList.add('hidden');
        document.getElementById('adminLoginForm').classList.remove('hidden');
        showMessageModal('تسجيل الخروج', 'تم تسجيل خروج المدير بنجاح.', 'info');
    }

    /**
     * تحميل وعرض البيانات في لوحة المدير (يعتمد على currentBookings).
     */
    function loadAdminData() {
        // تحديث إعدادات المدير
        renderAdminSettings();
        // عرض قائمة الحجوزات
        renderAdminBookings();
    }

    /**
     * عرض قائمة الحجوزات في لوحة المدير.
     */
    function renderAdminBookings() {
        const listContainer = document.getElementById('adminBookingsList');
        if (!listContainer) return;

        // فرز الحجوزات حسب اسم البريك ثم حسب وقت الإنشاء
        const sortedBookings = [...currentBookings].sort((a, b) => {
            const breakOrderA = breakPeriods.findIndex(p => p.name === a.breakName);
            const breakOrderB = breakPeriods.findIndex(p => p.name === b.breakName);

            if (breakOrderA !== breakOrderB) {
                return breakOrderA - breakOrderB;
            }
            // إذا كانت نفس الفترة، افرز حسب الأحدث (الأحدث يظهر أولاً)
            const timeA = a.createdAt?.seconds || 0;
            const timeB = b.createdAt?.seconds || 0;
            return timeB - timeA; 
        });

        if (sortedBookings.length === 0) {
            listContainer.innerHTML = `
                <div class="text-center p-6 text-gray-500 dark:text-gray-400">
                    <i data-feather="database" class="w-8 h-8 mx-auto mb-2"></i>
                    <p class="font-medium">لا توجد حجوزات لهذا اليوم.</p>
                </div>
            `;
            feather.replace();
            return;
        }

        let html = '';
        let currentBreak = null;

        sortedBookings.forEach(booking => {
            const bookingTime = booking.createdAt ? new Date(booking.createdAt.seconds * 1000).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit', hour12: false }) : 'N/A';
            
            if (booking.breakName !== currentBreak) {
                currentBreak = booking.breakName;
                html += `<h4 class="sticky top-0 p-3 bg-gray-50 dark:bg-gray-700 text-primary-indigo dark:text-light-blue font-extrabold border-b border-gray-200 dark:border-gray-600 mt-2">${currentBreak} (${sortedBookings.filter(b => b.breakName === currentBreak).length} حجوزات)</h4>`;
            }

            html += `
                <div class="flex justify-between items-center p-3 border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <div>
                        <p class="font-semibold text-gray-900 dark:text-white">${booking.departmentName}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">وقت الحجز: ${bookingTime} - <span class="text-2xs font-mono select-all">${booking.userId.substring(0, 8)}...</span></p>
                    </div>
                    <button data-id="${booking.id}" class="admin-delete-btn text-danger-red hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 transition-colors">
                        <i data-feather="x-circle" class="w-5 h-5"></i>
                    </button>
                </div>
            `;
        });

        listContainer.innerHTML = html;
        feather.replace();

        // إرفاق مستمعي أحداث الحذف
        document.querySelectorAll('.admin-delete-btn').forEach(button => {
            button.onclick = (e) => {
                const bookingId = e.currentTarget.dataset.id;
                handleAdminDeleteBooking(bookingId);
            };
        });
    }

    /**
     * معالجة حذف حجز من لوحة المدير.
     */
    function handleAdminDeleteBooking(bookingId) {
        showConfirmationModal(
            'حذف حجز المدير', 
            'هل أنت متأكد من حذف هذا الحجز؟ هذا الإجراء لا يمكن التراجع عنه.',
            async () => {
                if (!isAuthReady || !db) return;
                
                try {
                    const docRef = doc(db, getPublicBookingsCollectionPath(), bookingId);
                    await deleteDoc(docRef);
                    showMessageModal('تم الحذف', 'تم حذف الحجز بنجاح.', 'success');
                } catch (error) {
                    console.error("خطأ في حذف حجز المدير:", error);
                    showMessageModal('فشل الحذف', 'حدث خطأ أثناء حذف الحجز. الرجاء المحاولة مرة أخرى.', 'error');
                }
            }
        );
    }
    
    /**
     * عرض إعدادات المدير (مثل زر مسح كل الحجوزات).
     */
    function renderAdminSettings() {
        const container = document.getElementById('adminSettingsContainer');
        if (!container) return;

        // التحقق مما إذا كان الزر موجودًا لتجنب تكرار الإرفاق
        if (container.querySelector('#deleteAllBookingsButton')) return; 

        const deleteAllButton = document.createElement('button');
        deleteAllButton.id = 'deleteAllBookingsButton';
        deleteAllButton.className = 'w-full bg-danger-red hover:bg-red-700 text-white font-bold py-3 rounded-lg transition-colors flex items-center justify-center';
        deleteAllButton.innerHTML = '<i data-feather="alert-octagon" class="w-5 h-5 ml-2"></i> مسح جميع حجوزات اليوم';
        
        deleteAllButton.onclick = handleAdminDeleteAllBookings;
        container.appendChild(deleteAllButton);
        feather.replace();
    }

    /**
     * معالجة مسح جميع الحجوزات اليومية.
     */
    function handleAdminDeleteAllBookings() {
        showConfirmationModal(
            'مسح كل الحجوزات', 
            '⚠️ تحذير: هل أنت متأكد من حذف جميع الحجوزات لهذا اليوم؟ لا يمكن التراجع عن هذا الإجراء.',
            async () => {
                if (!isAuthReady || !db) return;
                
                try {
                    const today = new Date().toISOString().slice(0, 10);
                    const bookingsColRef = collection(db, getPublicBookingsCollectionPath());
                    const q = query(bookingsColRef, where("dateString", "==", today));
                    
                    const snapshot = await getDocs(q);
                    
                    if (snapshot.empty) {
                        showMessageModal('لا يوجد شيء للحذف', 'لا توجد حجوزات لحذفها لهذا اليوم.', 'info');
                        return;
                    }

                    // حذف كل وثيقة بشكل منفصل (لا تدعم Firestore الحذف الجماعي مباشرة في الويب SDK)
                    const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deletePromises);
                    
                    showMessageModal('تم المسح بنجاح', `تم حذف ${snapshot.size} حجزاً بنجاح لهذا اليوم.`, 'success');

                } catch (error) {
                    console.error("خطأ في مسح جميع الحجوزات:", error);
                    showMessageModal('فشل المسح', 'حدث خطأ أثناء مسح جميع الحجوزات. الرجاء مراجعة الـ console.', 'error');
                }
            }
        );
    }


    // =========================================================================
    //                 إعداد المستمعين للأحداث (Event Listeners)
    // =========================================================================
    function setupEventListeners() {
        // إذا كان المستمع جاهزاً، ابدأ بالاستماع للبيانات
        if (isAuthReady) {
            startDataListener(); 
        } else {
            // وإلا، ستبدأ الدالة عند اكتمال المصادقة في onAuthStateChanged
        }

        // Dropdown تغيير القسم
        const departmentSelect = document.getElementById('departmentSelect');
        if (departmentSelect) {
            departmentSelect.onchange = (e) => {
                selectedDepartment = e.target.value;
            };
        }

        // زر حجز البريك
        const bookButton = document.getElementById('bookBreakButton');
        if (bookButton) {
            bookButton.onclick = handleBookBreak;
        }
        
        // زر فتح لوحة المدير
        const adminButton = document.getElementById('openAdminModal');
        if (adminButton) {
            adminButton.onclick = () => toggleAdminModal(true);
        }

        // إغلاق لوحة المدير
        const adminCloseButton = document.getElementById('adminCloseButton');
        if (adminCloseButton) {
            adminCloseButton.onclick = () => toggleAdminModal(false);
        }
        
        // تسجيل دخول المدير
        const adminLoginButton = document.getElementById('adminLoginButton');
        if (adminLoginButton) {
            adminLoginButton.onclick = handleAdminLogin;
        }

        // تسجيل خروج المدير
        const adminLogoutButton = document.getElementById('adminLogoutButton');
        if (adminLogoutButton) {
            adminLogoutButton.onclick = handleAdminLogout;
        }


        // تهيئة العناصر عند التحميل
        populateDepartmentDropdown();
        renderBreakButtons();
        updateBookingSummary();
        renderBookingGrid(); // العرض المبدئي قبل تحميل البيانات
    }


    window.onload = () => {
        // تهيئة الأيقونات
        feather.replace();
        // بدء إعداد المستمعات والأحداث بعد تحميل الصفحة بالكامل
        if (isAuthReady) {
            setupEventListeners();
        } else {
            // إذا لم تكن المصادقة جاهزة بعد، فسيتم استدعاء setupEventListeners
            // ضمن onAuthStateChanged لضمان أن كل شيء تم تهيئته.
        }
    };


    // =========================================================================
    //                       منطق الوضع الداكن (Dark Mode)
    // =========================================================================
    function toggleDarkMode() {
        const html = document.documentElement;
        html.classList.toggle('dark');
        const isDark = html.classList.contains('dark');
        localStorage.setItem('darkMode', isDark);

        // تحديث أيقونة الزر
        const toggleButton = document.getElementById('darkModeToggle');
        if (toggleButton) {
            toggleButton.innerHTML = `<i data-feather="${isDark ? 'sun' : 'moon'}" class="w-6 h-6"></i>`;
            feather.replace();
        }
    }

    // تطبيق الوضع الداكن من localStorage عند التحميل
    if (localStorage.getItem('darkMode') === 'true' || 
        (!('darkMode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
    }
    
    // إرفاق مستمع الحدث لزر الوضع الداكن
    document.addEventListener('DOMContentLoaded', () => {
        const toggleButton = document.getElementById('darkModeToggle');
        if (toggleButton) {
            toggleButton.onclick = toggleDarkMode;
            // تحديث الأيقونة عند التحميل
            const isDark = document.documentElement.classList.contains('dark');
            toggleButton.innerHTML = `<i data-feather="${isDark ? 'sun' : 'moon'}" class="w-6 h-6"></i>`;
            feather.replace();
        }
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors p-4 md:p-8">

    <!-- لوحة المدير (Admin Modal) -->
    <div id="adminModal" class="modal-overlay hidden">
        <div class="card bg-white dark:bg-gray-800 p-6 w-11/12 max-w-lg rounded-xl transform transition-all scale-100 animate-in fade-in zoom-in-50">
            
            <!-- رأس لوحة المدير -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-extrabold text-primary-indigo dark:text-light-blue">لوحة إدارة الحجوزات</h2>
                <button id="adminCloseButton" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 transition-colors p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- نموذج تسجيل دخول المدير -->
            <div id="adminLoginForm">
                <p class="text-gray-600 dark:text-gray-400 mb-3">الرجاء إدخال رمز المدير للمتابعة.</p>
                <input type="password" id="adminCode" placeholder="رمز المدير" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-indigo focus:border-primary-indigo dark:bg-gray-700 dark:text-white font-medium mb-4" />
                <button id="adminLoginButton" class="w-full bg-primary-indigo hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition-colors">
                    تسجيل الدخول
                </button>
            </div>

            <!-- محتوى المدير (يظهر بعد تسجيل الدخول) -->
            <div id="adminContent" class="hidden">
                <div id="adminSettingsContainer" class="mb-4"></div>

                <p class="text-sm font-semibold text-red-600 dark:text-red-400 mb-4">⚠️ تنبيه: الحذف هنا يؤثر على حجوزات اليوم الحالي فقط.</p>
                
                <!-- قائمة الحجوزات للعرض -->
                <div id="adminBookingsList" class="max-h-80 overflow-y-auto no-scrollbar border border-gray-200 dark:border-gray-700 rounded-lg">
                    <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                </div>

                <button id="adminLogoutButton" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-colors mt-4">
                    تسجيل الخروج من لوحة المدير
                </button>
            </div>

        </div>
    </div>


    <!-- واجهة التطبيق الرئيسية -->
    <div class="max-w-4xl mx-auto">
        
        <!-- الرأس والأزرار (Toggle + Admin) -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white flex items-center">
                Break Time Buddy
            </h1>
            <div class="flex space-x-2 space-x-reverse">
                <button id="openAdminModal" class="p-2 rounded-full text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" title="لوحة المدير">
                    <i data-feather="lock" class="w-6 h-6"></i>
                </button>
                <button id="darkModeToggle" class="p-2 rounded-full text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" title="تبديل الوضع الداكن">
                    <!-- الأيقونة سيتم تحديثها بواسطة JS -->
                </button>
            </div>
        </header>

        <!-- بطاقة الحجز الرئيسية -->
        <div class="card bg-white dark:bg-gray-800 p-6 md:p-8 rounded-2xl shadow-xl mb-8">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">جدول حجز البريكات للأقسام</h2>
            <p class="text-gray-600 dark:text-gray-400 mb-6">احجز الفترة الزمنية لبريك قسمك لضمان عدم تداخل المواعيد.</p>
            
            <!-- نموذج الحجز -->
            <div class="space-y-6">
                
                <!-- اختيار القسم -->
                <div>
                    <label for="departmentSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">1. اختر قسمك:</label>
                    <div class="relative">
                        <select id="departmentSelect" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg appearance-none focus:ring-primary-indigo focus:border-primary-indigo dark:bg-gray-700 dark:text-white font-medium">
                            <!-- خيارات الأقسام يتم ملؤها بواسطة JS -->
                        </select>
                        <i data-feather="chevron-down" class="w-5 h-5 absolute top-1/2 left-3 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 pointer-events-none"></i>
                    </div>
                </div>

                <!-- اختيار فترة البريك -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">2. اختر فترة البريك:</label>
                    <div id="breakButtonsContainer" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <!-- أزرار البريك يتم إنشاؤها بواسطة JS -->
                    </div>
                </div>

                <!-- زر الحجز والملخص -->
                <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center mb-3">
                        <button id="bookBreakButton" class="flex-grow bg-secondary-green hover:bg-emerald-600 text-white font-bold py-3 rounded-lg transition-colors shadow-md hover:shadow-lg disabled:opacity-50" disabled>
                            حجز البريك
                        </button>
                        <div id="bookingSummary" class="mr-4 p-2 rounded-lg">
                            <!-- ملخص الحجز يتم تحديثه بواسطة JS -->
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 text-center">كل بريك متاح لـ 2 قسم كحد أقصى.</p>
                </div>
            </div>
        </div>

        <!-- بطاقة عرض الحجوزات -->
        <div class="card bg-white dark:bg-gray-800 p-6 md:p-8 rounded-2xl shadow-xl">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                <i data-feather="list" class="w-6 h-6 ml-2 text-primary-indigo"></i>
                الحجوزات الحالية لليوم
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="bookingGrid">
                <!-- سيتم عرض الحجوزات هنا بواسطة JavaScript -->
            </div>
        </div>

    </div>

</body>
</html>
