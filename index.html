<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Break Time Buddy - جدول حجز البريكات</title>
    
    <!-- تحميل Tailwind CSS مرة واحدة -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- تأكيد إعدادات Tailwind لتفعيل dark mode عبر الفئة (class) -->
    <script>
        tailwind.config = {
            darkMode: 'class', 
        }
    </script>
                      <link rel="icon" href="images/favicon.png" type="image/png" />


    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <script type="module">
        // Firebase Imports - جميعها موحدة على الإصدار 11.6.1
    // استيراد المكتبات من النسخة 12.4.0 فقط
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, deleteDoc, collection, query, onSnapshot, getDocs, where } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // إعدادات Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyARZtk0LhDVK6aj-C-aFcqzn7trBA_aZ9o",
        authDomain: "breaktime-8e28a.firebaseapp.com",
        projectId: "breaktime-8e28a",
        storageBucket: "breaktime-8e28a.firebasestorage.app",
        messagingSenderId: "653808445317",
        appId: "1:653808445317:web:55aa4a365b8fcf4ac246ec",
        measurementId: "G-077KHT3Y1L"
    };

    // تهيئة Firebase
    const appId = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);

    setLogLevel('Debug'); // تفعيل مستوى Debug

        
        setLogLevel('Debug'); // ⭐️ تفعيل تسجيل مستوى Debug لرؤية سجلات Firebase

        
        // =========================================================================
        // ⭐️⭐️ التعديل الأساسي: الاعتماد حصريًا على المتغيرات العامة الآمنة ⭐️⭐️
        
        // 1. استرداد إعدادات Firebase من المتغيرات العامة (GLOBALS)
        let firebaseConfig = {};
        try {
            // استخدام try/catch للتعامل مع السيناريو الذي تكون فيه __firebase_config غير مُعرَّفة
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        } catch (e) {
            console.error("Error parsing __firebase_config:", e);
        }

        if (Object.keys(firebaseConfig).length === 0) {
            // هذا التنبيه يظهر إذا لم يتم تهيئة الـ Globals، لكنه آمن الآن
            console.error("Firebase configuration is missing or empty. Database functions will fail.");
            window.showNotification('خطأ: إعدادات Firebase مفقودة. لن تعمل وظائف الحفظ.', 'error');
            // وضع إعدادات وهمية لتجنب تعطل الكود، مع العلم أنها لن تتصل بـ Firebase حقيقية
            firebaseConfig = { projectId: "default-app-id" }; 
        }
        
        // استخدام projectId لتوليد appId (يجب أن يتطابق مع الإعدادات الفعلية للمستخدم)
        const appId = typeof __app_id !== 'undefined' && __app_id !== 'default-app-id' ? __app_id : (firebaseConfig.projectId || 'breaktime-8e28a');
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // 2. تهيئة Firebase
        
        let firebaseDb = getFirestore(app);
        let firebaseAuth = getAuth(app); 
        
        // =========================================================================

        let userId = null; // Will be set after auth completes
        let isAuthReady = false;

        // ⭐️⭐️ المسار الإجباري للمجموعة العامة في Firestore ⭐️⭐️
        const collectionPath = `artifacts/${appId}/public/data/public_bookings`;

        // -----------------------------------------------------------
        // Expose Firebase State and Firestore Functions Globals for Main Script Access
        // -----------------------------------------------------------
        window.getDb = () => firebaseDb; 
        window.getAuth = () => firebaseAuth; 
        window.getUserId = () => userId;
        window.getIsAuthReady = () => isAuthReady;
        window.getAppId = () => appId; // ⭐️ تعريض appId
        
        // Expose critical Firestore functions to the global scope (window)
        window.doc = doc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.collection = collection;
        window.getDocs = getDocs;
        window.query = query;
        window.where = where;
        
        /**
         * تبدأ مزامنة البيانات في الوقت الفعلي من Firestore.
         */
        window.startRealtimeSync = function() {
            // التأكد من أن Firestore مهيأ وجاهز
            if (!window.getDb() || !window.getIsAuthReady()) {
                return; 
            }
            
            // تعريف المرجع للمجموعة العامة للحجوزات 
            const employeeBookingsRef = collection(window.getDb(), collectionPath);

            // نستخدم onSnapshot من Firestore للاستماع للتغييرات في الوقت الفعلي
            const unsubscribe = onSnapshot(employeeBookingsRef, (snapshot) => {
                const fetchedEmployees = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                if (typeof window.setEmployees === 'function') {
                    window.setEmployees(fetchedEmployees);
                } else {
                    console.error("setEmployees function not found. Data not updated.");
                    return;
                }
                
                if (window.selectedShift) {
                    window.renderTimeSlots(); 
                    window.renderSchedule();  
                    window.updateAllTimers(); 
                }

                console.log("Employees data synchronized from Firestore.");
                window.showNotification('تم تحديث جدول الحجوزات.', 'info');

            }, (error) => {
                console.error("Firestore read failed: " + error.message);
                if (!error.message.includes("is not initialized")) {
                    window.showNotification("فشل في تحميل جدول الحجوزات: " + error.message, 'error');
                }
            });
            window.firestoreUnsubscribe = unsubscribe;
        };
        // -----------------------------------------------------------

        try {
            // ⭐️⭐️ التعديل 2: استخدام initialAuthToken للمصادقة ⭐️⭐️
            async function authenticateAndSetup() {
                if (!firebaseAuth) {
                    isAuthReady = true;
                    return;
                }
                 try {
                    if (initialAuthToken) {
                        // استخدام الرمز المخصص إذا كان متوفراً
                        await signInWithCustomToken(firebaseAuth, initialAuthToken);
                        console.log("Signed in with Custom Token.");
                    } else { 
                        // المصادقة المجهولة كخيار احتياطي
                        await signInAnonymously(firebaseAuth);
                        console.log("Signed in Anonymously.");
                    }
                } catch(error) {
                    console.error("Error during Firebase sign-in:", error);
                    window.showNotification(`فشل في المصادقة: ${error.message}`, 'error');
                }

                // 2. Auth State Listener
                onAuthStateChanged(firebaseAuth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        // Start real-time sync when auth is ready
                        window.startRealtimeSync(); 
                    } else {
                        userId = null;
                        isAuthReady = true;
                        console.log("Firebase Auth Ready: No user logged in.");
                    }
                });
            }
            
            if (app) {
                authenticateAndSetup(); // بدء عملية المصادقة فقط إذا تم تهيئة التطبيق بنجاح
            } else {
                isAuthReady = true; 
                window.showNotification('فشل تهيئة Firebase. لن تعمل وظائف الحفظ/المزامنة.', 'error');
            }


        } catch (e) {
            console.error("Failed to initialize Firebase:", e);
        }

    </script>
    
    <!-- تحميل مكتبة الأيقونات Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <link rel="icon" href="images/favicon.png" type="image/png" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
        body {
            font-family: 'Tajawal', sans-serif;
        }
        /* Custom styles for the break selection buttons */
        .time-slot {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .time-slot:hover:not(.booked):not([disabled]) {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        /* Dark Mode adjustments for custom hover effect */
        /* NOTE: Now targetting body.dark */
        body.dark .time-slot:hover:not(.booked):not([disabled]) {
            box-shadow: 0 8px 15px rgba(255, 255, 255, 0.05);
        }

        .floating-notification {
            animation: floatUp 4s ease forwards;
        }
        @keyframes floatUp {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .timer-text {
            font-size: 0.75rem; /* text-xs */
            font-weight: 700; /* font-bold */
        }
         /* Style for the Admin Modal */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
    </style>
</head>
<!-- تم تغيير هذا السطر ليصبح BODY هو الهدف الرئيسي لـ DARK MODE -->
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen dark:from-gray-900 dark:to-black dark:text-gray-100">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-12 relative">
            
            <button id="themeToggle" class="absolute top-0 left-0 p-3 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 dark:bg-gray-700 dark:text-yellow-400 dark:hover:bg-gray-600 transition-colors" title="تبديل الوضع">
                <!-- تم ترك الأيقونة الافتراضية هنا، وسيتم تحديثها بالـ JS عند التحميل -->
                <i id="themeIcon" data-feather="moon" class="w-6 h-6"></i>
            </button>
            
            <button id="adminToggle" class="absolute top-0 right-0 p-3 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 dark:bg-gray-700 dark:text-indigo-400 dark:hover:bg-gray-600 transition-colors" title="إعدادات النظام (إدارة)">
                <i data-feather="settings" class="w-6 h-6"></i>
            </button>
            <h1 class="text-5xl font-extrabold text-indigo-800 mb-2 tracking-wide dark:text-indigo-400">BreakTime ⏳</h1>
            <p class="text-lg text-gray-600 dark:text-gray-400">نظام حجز ومتابعة فترات الراحة (الترتيب الإجباري: 15 د، 30 د، 15 د)</p>
        </header>

        <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden dark:bg-gray-800 dark:shadow-none dark:border dark:border-indigo-900">
            
            <div id="shiftSelection" class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-3xl font-extrabold text-indigo-900 mb-6 text-center dark:text-white">
                    اختر وردية العمل اليومية
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button id="morningShift" onclick="selectShift('morning')" 
                            class="shift-card bg-white dark:bg-gray-700 dark:border-gray-600 border-2 border-transparent p-6 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:scale-[1.02] cursor-pointer focus:outline-none focus:ring-4 focus:ring-blue-300 dark:hover:shadow-indigo-900/50">
                        <div class="flex flex-col items-center">
                            <i data-feather="sun" class="w-12 h-12 text-yellow-500 mb-3 drop-shadow-md"></i>
                            <span class="text-xl font-extrabold text-gray-800 mb-1 dark:text-gray-100">الدوام الصباحي</span>
                            <span class="text-sm text-gray-500 font-medium dark:text-gray-300">9:00 صباحًا - 5:00 مساءً</span>
                            <span class="mt-4 inline-block bg-blue-50 text-blue-700 text-xs font-bold px-3 py-1 rounded-full dark:bg-blue-900 dark:text-blue-300">
                                البريك متاح بين 10:00 ص و 4:00 م
                            </span>
                        </div>
                    </button>

                    <button id="eveningShift" onclick="selectShift('evening')" 
                            class="shift-card bg-white dark:bg-gray-700 dark:border-gray-600 border-2 border-transparent p-6 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:scale-[1.02] cursor-pointer focus:outline-none focus:ring-4 focus:ring-purple-300 dark:hover:shadow-indigo-900/50">
                        <div class="flex flex-col items-center">
                            <i data-feather="moon" class="w-12 h-12 text-purple-600 mb-3 drop-shadow-md"></i>
                            <span class="text-xl font-extrabold text-gray-800 mb-1 dark:text-gray-100">الدوام المسائي</span>
                            <span class="text-sm text-gray-500 font-medium dark:text-gray-300">3:00 مساءً - 11:00 مساءً</span>
                            <span class="mt-4 inline-block bg-purple-50 text-purple-700 text-xs font-bold px-3 py-1 rounded-full dark:bg-purple-900 dark:text-purple-300">
                                البريك متاح بين 4:00 م و 10:00 م
                            </span>
                        </div>
                    </button>
                </div>
            </div>

            <div id="breakSelection" class="hidden p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-100">اختر فترات الراحة (الترتيب الإجباري):</h2>
                    <div class="flex items-center gap-2 bg-indigo-100 text-indigo-800 font-bold px-4 py-1.5 rounded-full text-lg dark:bg-indigo-900 dark:text-indigo-300">
                        <span id="selectedCount">0</span>
                        <span>/ 3</span>
                    </div>
                </div>
                
                <p class="text-sm text-center text-gray-600 mb-4 font-bold dark:text-gray-400">
                    يجب اختيار البريكات بالترتيب: <span class="text-indigo-700 dark:text-indigo-300">15 دقيقة</span> ، ثم <span class="text-red-700 dark:text-red-300">30 دقيقة</span> ، ثم <span class="text-indigo-700 dark:text-indigo-300">15 دقيقة</span>.
                </p>
                
                <div id="timeSlotsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-6 p-3 bg-gray-50 rounded-lg border border-gray-200 dark:bg-gray-900 dark:border-gray-700">
                    </div>
                
                <div class="flex flex-col sm:flex-row gap-3">
                    <input id="employeeName" type="text" placeholder="اسم الموظف" 
                           class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                    
                    <button id="confirmButton" disabled class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed dark:bg-indigo-700 dark:hover:bg-indigo-600">
                        تأكيد الحجز
                    </button>
                    <button onclick="resetSelection()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-6 rounded-lg shadow-md transition-all duration-300 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-white">
                        اختيار وردية أخرى
                    </button>
                </div>
            </div>

            <div id="scheduleDisplay" class="p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 dark:text-gray-100">جدول فترات الراحة المحجوزة</h2>
                
                <div id="scheduleTable" class="bg-gray-50 rounded-xl shadow-inner overflow-hidden border border-gray-200 dark:bg-gray-900 dark:border-indigo-900">
                    <div class="grid grid-cols-12 bg-gray-200 font-bold text-gray-700 text-sm md:text-base dark:bg-gray-700 dark:text-gray-200">
                        <div class="col-span-3 p-3 border-r border-gray-300 text-center dark:border-gray-600">الموظف</div>
                        <div class="col-span-3 p-3 border-r border-gray-300 text-center dark:border-gray-600">البريك الأول (15 د)</div>
                        <div class="col-span-3 p-3 border-r border-gray-300 text-center dark:border-gray-600">البريك الثاني (30 د)</div>
                        <div class="col-span-3 p-3 text-center">البريك الثالث (15 د)</div>
                    </div>
                    <div id="scheduleContent" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <div class="grid grid-cols-12 text-center items-center py-4 px-2 text-gray-500 dark:text-gray-400">
                            <div class="col-span-12 p-2">لا توجد حجوزات في هذه الوردية حتى الآن</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-6 text-center text-gray-600 dark:text-gray-400">
            <p id="currentTime" class="text-md font-medium bg-white/50 inline-block px-4 py-2 rounded-lg shadow-inner dark:bg-gray-800/50"></p>
        </div>

        <div id="notificationContainer" class="fixed bottom-4 right-4 space-y-2 z-50"></div>
    </div>

    <div id="adminModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg dark:bg-gray-800 dark:border dark:border-indigo-900">
            <div class="flex justify-between items-center border-b pb-3 mb-4 dark:border-gray-700">
                <h3 class="text-2xl font-bold text-indigo-700 dark:text-indigo-400">إعدادات النظام (Admin)</h3>
                <button onclick="document.getElementById('adminModal').classList.add('hidden', 'opacity-0')" class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-400">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div id="adminStep1">
                <p class="mb-4 text-gray-600 dark:text-gray-300">للوصول إلى أدوات الإدارة، يرجى إدخال الرمز السري:</p>
                <input id="adminCode" type="password" placeholder="الرمز السري"
                       class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <button id="adminLoginButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600">
                    دخول
                </button>
            </div>

            <div id="adminStep2" class="hidden">
                <p class="text-lg font-semibold mb-3 text-indigo-700 dark:text-indigo-400 border-b pb-2 dark:border-gray-700">إدارة الحجوزات يدوياً:</p>
                
                <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg dark:bg-yellow-900/20 dark:border-yellow-900">
                    <h4 class="text-lg font-bold text-yellow-800 dark:text-yellow-400 mb-2">حذف بريك لموظف محدد (Admin Override)</h4>
                    <p class="text-sm text-yellow-700 dark:text-yellow-300 mb-3">يمكنك حذف بريك واحد من سجل موظف معين **بالاسم** ورقم البريك (1، 2، أو 3).</p>
                    <input id="deleteBreakName" type="text" placeholder="اسم الموظف"
                           class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <input id="deleteBreakIndex" type="number" min="1" max="3" placeholder="رقم البريك (1 أو 2 أو 3)"
                           class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <button id="deleteSingleBreakButton" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg shadow-md transition-colors dark:bg-yellow-700 dark:hover:bg-yellow-600">
                        <i data-feather="minus-circle" class="w-5 h-5 inline-block ml-2"></i>
                        حذف هذا البريك
                    </button>
                </div>

                <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg dark:bg-red-900/20 dark:border-red-900">
                    <h4 class="text-lg font-bold text-red-800 dark:text-red-400 mb-2">حذف موظف كامل وسجل بريكاته ⚠️</h4>
                    <p class="text-sm text-red-700 dark:text-red-300 mb-3">سيتم مسح جميع بريكات الموظف بالاسم وجعلها متاحة للحجز مرة أخرى.</p>
                    <input id="deleteEmployeeName" type="text" placeholder="اسم الموظف المراد حذفه بالكامل"
                           class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <button id="deleteEmployeeButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg shadow-md transition-colors dark:bg-red-700 dark:hover:bg-red-600">
                        <i data-feather="user-x" class="w-5 h-5 inline-block ml-2"></i>
                        حذف الموظف وحجوزاته بالكامل
                    </button>
                </div>
                
                <p class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-200 border-b pb-2 dark:border-gray-700">مسح بيانات التخزين بالكامل:</p>
                <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg dark:bg-red-900/20 dark:border-red-900">
                    <p class="text-sm font-medium text-red-700 dark:text-red-400 mb-2">⚠️ سيتم مسح جميع سجلات الحجوزات من قاعدة البيانات.</p>
                </div>

                <button id="deleteStorageButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg shadow-md transition-colors dark:bg-red-700 dark:hover:bg-red-600">
                    <i data-feather="trash-2" class="w-5 h-5 inline-block ml-2"></i>
                    مسح جميع بيانات الموظفين بالكامل
                </button>
                <p class="text-xs text-red-500 mt-2 text-center dark:text-red-400">⚠️ هذا الإجراء لا يمكن التراجع عنه.</p>
            </div>

        </div>
    </div>
    <script>
        
        // ****** التعديل 1: تحميل البيانات المحفوظة ******
        let selectedShift = null;
        let employees = [];
        let selectedBreaks = []; // سيحتوي على كائنات { time: "10:00 ص", duration: 15 }
        
        // NEW: Global setter for employees, called from module script (startRealtimeSync)
        window.setEmployees = (newEmployees) => {
            employees = newEmployees;
        };

        const BREAK_TYPES = {
            '15': 15, // مدة 15 دقيقة
            '30': 30  // مدة 30 دقيقة
        };
        const MAX_TOTAL_BREAKS = 3;
        
        // ******* التعديل الجديد لفرض الترتيب *******
        const REQUIRED_ORDER = [15, 30, 15]; // الترتيب الإجباري: 15 د، 30 د، 15 د
        
        
        // توليد فترات البريك المتاحة
        const generateBreakTimes = (startHour, endHour) => {
            const slots = [];
            for (let h = startHour; h < endHour; h++) {
                for (let m = 0; m < 60; m += 15) {
                    let time = `${String(h % 12 || 12).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    let period = h >= 12 && h < 24 ? 'م' : 'ص';
                    
                    // بريك 15 دقيقة
                    if (h + (m + 15) / 60 <= endHour) {
                        slots.push({ time: `${time} ${period}`, duration: 15 });
                    }
                    
                    // بريك 30 دقيقة (فقط في بداية ونصف الساعة)
                    if (m % 30 === 0 && h + (m + 30) / 60 <= endHour) {
                        slots.push({ time: `${time} ${period}`, duration: 30 });
                    }
                }
            }
            // إزالة التكرارات
            const uniqueSlots = Array.from(new Set(slots.map(s => `${s.time}-${s.duration}`)))
                                             .map(str => {
                                                 const [time, durationStr] = str.split('-');
                                                 return { time: time, duration: Number(durationStr) };
                                             });
            
            // التصفية النهائية للحفاظ على النطاق
            const filterSlots = (slots, startHour, endHour) => {
                const today = new Date();
                return slots.filter(slot => {
                    const [timeStr, period] = slot.time.split(' ');
                    let [hours, minutes] = timeStr.split(':').map(Number);
                    if (period === 'م' && hours !== 12) hours += 12;
                    if (period === 'ص' && hours === 12) hours = 0;
                    
                    // يتم إنشاء كائن وقت النهاية للبريك
                    const startTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes, 0, 0);
                    const endTime = new Date(startTime.getTime() + slot.duration * 60000);
                    
                    // تحويل ساعات النهاية إلى تنسيق 24 ساعة لغرض المقارنة
                    const endLimit = new Date(today.getFullYear(), today.getMonth(), today.getDate(), endHour, 0, 0, 0);
                    
                    return endTime <= endLimit;
                });
            };
            
            return filterSlots(uniqueSlots, startHour, endHour).sort((a, b) => timeToDate(a.time) - timeToDate(b.time));
        };

        const morningBreakStartTimes = generateBreakTimes(10, 16); // 10:00 ص إلى 4:00 م (16:00)
        const eveningBreakStartTimes = generateBreakTimes(16, 22); // 4:00 م (16:00) إلى 10:00 م (22:00)

        const shiftSelection = document.getElementById('shiftSelection');
        const breakSelection = document.getElementById('breakSelection');
        const timeSlotsContainer = document.getElementById('timeSlotsContainer');
        const selectedCount = document.getElementById('selectedCount');
        const employeeName = document.getElementById('employeeName');
        const confirmButton = document.getElementById('confirmButton');
        const scheduleContent = document.getElementById('scheduleContent');
        const currentTimeDisplay = document.getElementById('currentTime');
        const notificationContainer = document.getElementById('notificationContainer');
        const themeToggle = document.getElementById('themeToggle');
        // تم تعريف themeIcon هنا
        const themeIcon = document.getElementById('themeIcon');
        
        // ****** متغيرات وإعدادات التحكم بالتخزين الجديدة ******
        const ADMIN_CODE = '!#?!#!@@??#!'; // الرمز السري للوصول للإدارة
        const adminToggle = document.getElementById('adminToggle');
        const adminModal = document.getElementById('adminModal');
        const adminCode = document.getElementById('adminCode');
        const adminLoginButton = document.getElementById('adminLoginButton');
        const adminStep1 = document.getElementById('adminStep1');
        const adminStep2 = document.getElementById('adminStep2');
        const deleteStorageButton = document.getElementById('deleteStorageButton');
        const storageSizeDisplay = document.getElementById('storageSizeDisplay');
        // المتغيرات لخاصية حذف بريك موظف محدد (موجودة سابقاً)
        const deleteBreakName = document.getElementById('deleteBreakName');
        const deleteBreakIndex = document.getElementById('deleteBreakIndex');
        const deleteSingleBreakButton = document.getElementById('deleteSingleBreakButton');
        // المتغيرات الجديدة لخاصية حذف موظف كامل
        const deleteEmployeeName = document.getElementById('deleteEmployeeName');
        const deleteEmployeeButton = document.getElementById('deleteEmployeeButton');
        // *******************************************************
        
        // UTILITY FUNCTIONS

        function timeToDate(timeString) {
            const [time, period] = timeString.split(' ');
            let [hours, minutes] = time.split(':').map(Number);

            if (period === 'م' && hours !== 12) {
                hours += 12;
            } else if (period === 'ص' && hours === 12) {
                hours = 0;
            }

            const today = new Date();
            let date = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes, 0, 0);
            
            return date;
        }

        function formatTimeDifference(ms) {
            const totalSeconds = Math.max(0, Math.floor(ms / 1000));
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            const pad = (num) => num.toString().padStart(2, '0');
            
            if (hours > 0) return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
            return `${pad(minutes)}:${pad(seconds)}`;
        }
        
        function getBreakEndString(startTime, duration) {
            const startDate = timeToDate(startTime);
            const endDate = new Date(startDate.getTime() + duration * 60000);
            
            const options = { hour: '2-digit', minute: '2-digit', hour12: true };
            let endString = endDate.toLocaleTimeString('ar-EG', options);
            
            // تصحيح التنسيق (قد تختلف البيئة)
            endString = endString.replace('ص', 'ص').replace('م', 'م'); 
            
            return endString;
        }
        
        /**
         * تحديث حالة الثيم (dark/light) في localStorage وعلى عنصر <body>.
         * وتحديث أيقونة التبديل.
         */
        function updateTheme(mode) {
            const targetElement = document.body; // تغيير الهدف من html إلى body
            // إذا كان الوضع "dark" (ليلي)، يجب أن تظهر أيقونة "sun" (شمس) للتبديل إلى الوضع الفاتح
            const newIcon = mode === 'dark' ? 'sun' : 'moon'; 

            if (mode === 'dark') {
                targetElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                targetElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
            
            const iconEl = document.getElementById('themeIcon');
            if (iconEl) {
                iconEl.setAttribute('data-feather', newIcon);
            }
            
            // إعادة رسم أيقونات Feather Icons للتأكد من تحديث الأيقونة
            feather.replace(); 

            // تحديث الواجهة إذا كنا في وضع اختيار البريكات
            if (selectedShift) {
                renderTimeSlots();
                renderSchedule();
            }
        }
        
        /**
         * تبديل الوضع الحالي (dark <-> light)
         */
        function toggleTheme() {
            const targetElement = document.body;
            const currentMode = targetElement.classList.contains('dark') ? 'dark' : 'light';
            const newMode = currentMode === 'dark' ? 'light' : 'dark';
            updateTheme(newMode);
        }

        /**
         * تطبيق تفضيل الوضع الليلي عند تحميل الصفحة وتحديث الأيقونة.
         */
        function applyInitialTheme() {
            const isDarkMode = localStorage.getItem('theme') === 'dark' || 
                                (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            
            if (isDarkMode) {
                updateTheme('dark');
            } else {
                updateTheme('light');
            }
        }

        function showNotification(message, type) {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-orange-500'
            };
            const icon = {
                success: 'check-circle',
                error: 'x-circle',
                info: 'info',
                warning: 'alert-triangle'
            };

            const notification = document.createElement('div');
            notification.className = `floating-notification flex items-center p-4 rounded-lg shadow-xl text-white ${colors[type]} transform translate-y-20 opacity-0`;
            notification.innerHTML = `
                <i data-feather="${icon[type]}" class="w-6 h-6 ml-2"></i>
                <span class="font-medium">${message}</span>
            `;
            
            notificationContainer.appendChild(notification);
            feather.replace();

            // إزالة الإشعار بعد انتهاء مدة الأنميشن
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // ****** دالة لحفظ البيانات (تم تعديلها لاستخدام window.doc و window.setDoc) ******
        /**
         * دالة لحفظ أو تحديث حجز موظف في Firestore.
         */
        async function saveEmployeeBooking(employeeData) {
            const db = window.getDb();
            
            if (!db || !window.getIsAuthReady()) {
                showNotification('لم يتم تهيئة قاعدة البيانات أو المصادقة لم تكتمل.', 'error');
                return;
            }
            
            // ⭐️⭐️ استخدام المسار الإجباري ⭐️⭐️
            const collectionPath = 'artifacts/' + window.getAppId() + '/public/data/public_bookings';

            // إنشاء Doc ID فريد (مثلاً: "Ahmed_morning" أو "Layla_evening")
            const docId = `${employeeData.name.replace(/[^a-zA-Z0-9]/g, '')}_${employeeData.shift}`;
            
            const docRef = window.doc(db, collectionPath, docId);

            try {
                await window.setDoc(docRef, employeeData, { merge: true }); 
                console.log(`Booking for ${employeeData.name} saved successfully with ID: ${docId}`);
            } catch (error) {
                console.error("Error saving booking: ", error);
                showNotification('حدث خطأ في حفظ الحجز على السحابة.', 'error');
            }
        }
        
        // ---------------------------------------------------------------------
        // وظائف التحكم بالتخزين (تم تعديلها لاستخدام الدوال المعروضة عالمياً)
        // ---------------------------------------------------------------------

        /**
         * مسح جميع الحجوزات من Firestore (للاستخدام الإداري).
         */
        async function clearAllBookings() {
            const db = window.getDb();

            if (!db || !window.getIsAuthReady()) {
                 showNotification('لم يتم تهيئة قاعدة البيانات أو المصادقة لم تكتمل.', 'error');
                return;
            }

            // استخدام نافذة الإدارة كرسالة تأكيد مؤقتة
            const isConfirmed = await new Promise(resolve => {
                const modal = document.getElementById('adminModal');
                const originalContent = adminStep2.innerHTML;
                
                adminStep2.innerHTML = `
                    <div class="text-center p-4">
                        <h4 class="text-xl font-bold text-red-700 dark:text-red-400 mb-4">تأكيد مسح البيانات بالكامل</h4>
                        <p class="text-gray-700 dark:text-gray-300 mb-6">هل أنت متأكد من مسح جميع حجوزات الموظفين المحفوظة في Firestore؟ هذا الإجراء لا يمكن التراجع عنه!</p>
                        <button id="confirmClear" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg mr-4">تأكيد المسح</button>
                        <button id="cancelClear" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">إلغاء</button>
                    </div>
                `;
                adminStep2.classList.remove('hidden');
                adminStep1.classList.add('hidden');

                document.getElementById('confirmClear').onclick = () => {
                    adminStep2.innerHTML = originalContent;
                    adminStep1.classList.add('hidden');
                    renderAdminStep2(originalContent);
                    resolve(true);
                };
                document.getElementById('cancelClear').onclick = () => {
                    renderAdminStep2(originalContent);
                    resolve(false);
                };
                 function renderAdminStep2(content) {
                    adminStep2.innerHTML = content;
                    adminStep2.classList.remove('hidden');
                    adminStep1.classList.add('hidden');
                    // إعادة ربط الأحداث بعد إعادة رسم المحتوى
                    rebindAdminEvents();
                 }
            });

            if (!isConfirmed) {
                return;
            }
            
            try {
                // ⭐️ استخدام المسار الإجباري
                const collectionPath = 'artifacts/' + window.getAppId() + '/public/data/public_bookings';
                const employeeBookingsRef = window.collection(db, collectionPath);
                const snapshot = await window.getDocs(employeeBookingsRef);
                
                if (snapshot.docs.length === 0) {
                    showNotification('لا توجد حجوزات لحذفها في قاعدة البيانات.', 'info');
                    adminModal.classList.add('hidden', 'opacity-0');
                    return;
                }
                
                const deletePromises = snapshot.docs.map(doc => window.deleteDoc(doc.ref));
                await Promise.all(deletePromises);
                
                adminModal.classList.add('hidden', 'opacity-0'); 
                showNotification('تم مسح جميع بيانات الحجوزات بنجاح.', 'success');

            } catch (error) {
                console.error("Error deleting all bookings:", error);
                showNotification(`فشل في مسح الحجوزات: ${error.message}`, 'error');
            }
        }


        /**
         * دالة لحذف موظف كامل وسجل بريكاته من Firestore.
         */
        async function deleteEmployeeFullRecord() {
            const db = window.getDb();
            if (!db || !window.getIsAuthReady()) {
                 showNotification('لم يتم تهيئة قاعدة البيانات أو المصادقة لم تكتمل.', 'error');
                return;
            }
            
            const nameToDelete = deleteEmployeeName.value.trim();

            if (!nameToDelete) {
                showNotification('الرجاء إدخال اسم الموظف المراد حذفه بالكامل.', 'error');
                return;
            }
            
            // بناء Doc IDs المحتملة (صباحي ومسائي)
            const docIdMorning = `${nameToDelete.replace(/[^a-zA-Z0-9]/g, '')}_morning`;
            const docIdEvening = `${nameToDelete.replace(/[^a-zA-Z0-9]/g, '')}_evening`;
            
            // استخدام بديل لـ window.confirm()
            const isConfirmed = await new Promise(resolve => {
                const modal = document.getElementById('adminModal');
                const originalContent = adminStep2.innerHTML;
                
                adminStep2.innerHTML = `
                    <div class="text-center p-4">
                        <h4 class="text-xl font-bold text-red-700 dark:text-red-400 mb-4">تأكيد حذف سجل الموظف</h4>
                        <p class="text-gray-700 dark:text-gray-300 mb-6">هل أنت متأكد من حذف جميع سجلات وحجوزات البريك للموظف ${nameToDelete}؟</p>
                        <button id="confirmDelete" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg mr-4">تأكيد الحذف</button>
                        <button id="cancelDelete" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">إلغاء</button>
                    </div>
                `;
                adminStep2.classList.remove('hidden');
                adminStep1.classList.add('hidden');

                document.getElementById('confirmDelete').onclick = () => {
                    // إعادة إظهار محتوى الخطوة الثانية الأصلي وضمان إخفاء الخطوة الأولى
                    renderAdminStep2(originalContent);
                    resolve(true);
                };
                document.getElementById('cancelDelete').onclick = () => {
                    // إعادة إظهار محتوى الخطوة الثانية الأصلي وضمان إخفاء الخطوة الأولى
                    renderAdminStep2(originalContent);
                    resolve(false);
                };
                function renderAdminStep2(content) {
                    adminStep2.innerHTML = content;
                    adminStep2.classList.remove('hidden');
                    adminStep1.classList.add('hidden');
                    // إعادة ربط الأحداث بعد إعادة رسم المحتوى
                    rebindAdminEvents();
                 }
            });

            if (!isConfirmed) {
                return;
            }
            
            // ⭐️⭐️ استخدام المسار الإجباري ⭐️⭐️
            const collectionPath = 'artifacts/' + window.getAppId() + '/public/data/public_bookings';

            const docRefMorning = window.doc(db, collectionPath, docIdMorning);
            const docRefEvening = window.doc(db, collectionPath, docIdEvening);

            try {
                // استخدام window.deleteDoc للحذف
                await Promise.all([
                    window.deleteDoc(docRefMorning).catch(e => console.log(`No morning record for ${nameToDelete}: ${e.message}`)),
                    window.deleteDoc(docRefEvening).catch(e => console.log(`No evening record for ${nameToDelete}: ${e.message}`))
                ]);

                deleteEmployeeName.value = '';
                showNotification(`تم حذف جميع سجلات الموظف ${nameToDelete} بنجاح.`, 'success');

                adminModal.classList.add('hidden', 'opacity-0');

            } catch (error) {
                console.error("Error deleting employee record:", error);
                showNotification(`فشل في حذف سجل الموظف: ${error.message}`, 'error');
            }
        }


        /**
         * دالة لحذف بريك واحد لموظف محدد (للاستخدام الإداري).
         */
        async function deleteSingleBreak() {
            const db = window.getDb();

            if (!db || !window.getIsAuthReady()) {
                 showNotification('لم يتم تهيئة قاعدة البيانات أو المصادقة لم تكتمل.', 'error');
                return;
            }

            const name = deleteBreakName.value.trim();
            const indexStr = deleteBreakIndex.value.trim();
            const index = parseInt(indexStr);

            if (!name || isNaN(index) || index < 1 || index > 3) {
                showNotification('الرجاء إدخال اسم موظف صحيح ورقم بريك بين 1 و 3.', 'error');
                return;
            }
            
            // يجد أول سجل للموظف بالاسم (قد يكون صباحي أو مسائي)
            const employeeRecord = employees.find(emp => emp.name === name);

            if (!employeeRecord) {
                showNotification(`لم يتم العثور على حجز للموظف باسم: ${name}`, 'error');
                return;
            }

            const breakToRemoveIndex = index - 1; // تحويل من (1, 2, 3) إلى (0, 1, 2)
            const empBreaks = employeeRecord.breaks || [];

            if (breakToRemoveIndex >= empBreaks.length || !empBreaks[breakToRemoveIndex] || !empBreaks[breakToRemoveIndex].time) {
                showNotification(`الموظف ${name} لم يحجز البريك رقم ${index} أو أنه محذوف مسبقًا.`, 'warning');
                return;
            }

            const breakInfo = empBreaks[breakToRemoveIndex];
            
            // استخدام بديل لـ window.confirm()
            const isConfirmed = await new Promise(resolve => {
                const modal = document.getElementById('adminModal');
                const originalContent = adminStep2.innerHTML;
                
                adminStep2.innerHTML = `
                    <div class="text-center p-4">
                        <h4 class="text-xl font-bold text-yellow-700 dark:text-yellow-400 mb-4">تأكيد حذف بريك</h4>
                        <p class="text-gray-700 dark:text-gray-300 mb-6">هل أنت متأكد من حذف البريك رقم ${index} (${breakInfo.duration} دقيقة يبدأ عند ${breakInfo.time}) للموظف ${name} في وردية ${employeeRecord.shift === 'morning' ? 'الصباح' : 'المساء'}؟</p>
                        <button id="confirmBreakDelete" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded-lg mr-4">تأكيد الحذف</button>
                        <button id="cancelBreakDelete" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">إلغاء</button>
                    </div>
                `;
                adminStep2.classList.remove('hidden');
                adminStep1.classList.add('hidden');

                document.getElementById('confirmBreakDelete').onclick = () => {
                    // إعادة إظهار محتوى الخطوة الثانية الأصلي وضمان إخفاء الخطوة الأولى
                    renderAdminStep2(originalContent);
                    resolve(true);
                };
                document.getElementById('cancelBreakDelete').onclick = () => {
                    // إعادة إظهار محتوى الخطوة الثانية الأصلي وضمان إخفاء الخطوة الأولى
                    renderAdminStep2(originalContent);
                    resolve(false);
                };
                 function renderAdminStep2(content) {
                    adminStep2.innerHTML = content;
                    adminStep2.classList.remove('hidden');
                    adminStep1.classList.add('hidden');
                    // إعادة ربط الأحداث بعد إعادة رسم المحتوى
                    rebindAdminEvents();
                 }
            });

            if (!isConfirmed) {
                return;
            }


            // 1. تعديل البيانات محلياً (نسخ المصفوفة ثم حذف العنصر)
            const newBreaks = [];
            // بناء مصفوفة جديدة تخلو من العنصر المحذوف
            for(let i = 0; i < empBreaks.length; i++){
                if (i !== breakToRemoveIndex) {
                    newBreaks.push(empBreaks[i]);
                }
            }
            
            // 2. تحديث المستند في Firestore
            const docId = `${employeeRecord.name.replace(/[^a-zA-Z0-9]/g, '')}_${employeeRecord.shift}`;
            
            // ⭐️⭐️ استخدام المسار الإجباري ⭐️⭐️
            const collectionPath = 'artifacts/' + window.getAppId() + '/public/data/public_bookings';

            const docRef = window.doc(db, collectionPath, docId);

            try {
                if (newBreaks.length === 0) {
                    // إذا أصبح سجل الموظف فارغًا بعد حذف البريك، احذف المستند بالكامل
                    await window.deleteDoc(docRef);
                } else {
                    // تحديث الحقل 'breaks' فقط
                    await window.setDoc(docRef, { breaks: newBreaks }, { merge: true });
                }
                
                // مسح الحقول وإظهار الإشعار
                deleteBreakName.value = '';
                deleteBreakIndex.value = '';
                showNotification(`تم حذف البريك رقم ${index} للموظف ${name} بنجاح.`, 'success');

                adminModal.classList.add('hidden', 'opacity-0');

            } catch (error) {
                console.error("Error deleting single break:", error);
                showNotification(`فشل في حذف البريك: ${error.message}`, 'error');
            }
        }
        // ---------------------------------------------------------------------
        // وظائف رئيسية
        // ---------------------------------------------------------------------
 
        
        function selectShift(shift) {
            window.selectedShift = selectedShift = shift; // جعل المتغير global للوصول إليه في startRealtimeSync
            
            document.querySelectorAll('.shift-card').forEach(card => {
                card.classList.remove('border-indigo-600', 'ring-4', 'ring-indigo-200', 'dark:ring-indigo-900');
                card.classList.add('border-transparent');
            });

            const selectedElement = document.getElementById(`${shift}Shift`);
            selectedElement.classList.remove('border-transparent');
            selectedElement.classList.add('border-indigo-600', 'ring-4', 'ring-indigo-200', 'dark:ring-indigo-900');

            setTimeout(() => {
                shiftSelection.classList.add('hidden');
                breakSelection.classList.remove('hidden');
                renderTimeSlots();
                renderSchedule(); 
                updateAllTimers();
            }, 200); 
        }
        
        function renderTimeSlots() {
            const now = new Date();
            
            const lastPossibleBreakTime = selectedShift === 'morning' ? '04:00 م' : '10:00 م';
            const lastBreakEnd = timeToDate(lastPossibleBreakTime);
            const isShiftClosed = lastBreakEnd.getTime() < now.getTime();

            timeSlotsContainer.innerHTML = '';
            const slots = selectedShift === 'morning' ? morningBreakStartTimes : eveningBreakStartTimes;
            
            if (isShiftClosed) {
                timeSlotsContainer.innerHTML = `<p class="col-span-full text-center text-red-600 font-semibold py-4 bg-red-50 rounded-lg dark:bg-red-900 dark:text-red-300">
                    انتهى وقت حجز البريكات لهذه الوردية لليوم.
                </p>`;
                confirmButton.disabled = true;
                return;
            }
            
            // تحديد نوع البريك المطلوب حالياً
            const currentIndex = selectedBreaks.length;
            const requiredDuration = currentIndex < MAX_TOTAL_BREAKS ? REQUIRED_ORDER[currentIndex] : null;

            // دمج كل الحجوزات الحالية للوردية (لأغراض الإغلاق)
            const allBookedSlots = employees
                                            .filter(emp => emp.shift === selectedShift)
                                            .flatMap(emp => emp.breaks)
                                            .map(b => `${b.time}-${b.duration}`);


            slots.forEach(slot => {
                const slotStartTime = slot.time;
                const duration = slot.duration;
                const slotEndTime = getBreakEndString(slotStartTime, duration);
                const uniqueSlotKey = `${slotStartTime}-${duration}`;

                // حالة الحجز: محجوزة من موظف آخر
                const isBooked = allBookedSlots.includes(uniqueSlotKey);
                
                // حالة الاختيار: مختارة حاليًا من قبل هذا المستخدم
                const isSelected = selectedBreaks.some(b => b.time === slotStartTime && b.duration === duration);
                
                // حالة انتهاء الوقت
                const breakTimeEnd = new Date(timeToDate(slotStartTime).getTime() + duration * 60000);
                const isPastTime = breakTimeEnd.getTime() < now.getTime();
                
                // ******* التعديل لتطبيق قيد الترتيب *******
                const isIncorrectDuration = requiredDuration !== null && duration !== requiredDuration;

                // حالة تجاوز العدد الكلي (3 بريكات)
                const isTotalMaxed = selectedBreaks.length >= MAX_TOTAL_BREAKS && !isSelected;
                
                const isDisabled = isBooked || isPastTime || isIncorrectDuration || isTotalMaxed;

                let slotClasses;
                let statusText;
                let durationText = `(${duration} دقيقة)`;

                if (isPastTime) {
                    slotClasses = 'bg-gray-200 text-gray-500 cursor-not-allowed booked dark:bg-gray-700 dark:text-gray-400';
                    statusText = 'انتهت';
                } else if (isBooked) {
                    slotClasses = 'bg-gray-300 text-red-600 cursor-not-allowed booked dark:bg-gray-700 dark:text-red-400';
                    statusText = 'محجوزة';
                } else if (isSelected) {
                    slotClasses = 'bg-indigo-600 text-white shadow-lg border-2 border-indigo-800 dark:bg-indigo-700 dark:border-indigo-500 dark:shadow-indigo-500/50';
                    statusText = 'مختارة';
                } else if (isIncorrectDuration) {
                    slotClasses = 'bg-gray-200 text-orange-600 cursor-not-allowed booked dark:bg-gray-700 dark:text-orange-400';
                    statusText = `يجب اختيار بريك ${requiredDuration} دقيقة`;
                } else if (isTotalMaxed) {
                    slotClasses = 'bg-gray-200 text-red-600 cursor-not-allowed booked dark:bg-gray-700 dark:text-red-400';
                    statusText = 'اكتمل اختيار البريكات';
                } else {
                    slotClasses = 'bg-white text-indigo-600 hover:bg-indigo-100 border border-indigo-200 dark:bg-gray-800 dark:text-indigo-400 dark:hover:bg-gray-700 dark:border-indigo-900';
                    statusText = 'متاحة للحجز';
                }
                
                const slotElement = document.createElement('button');
                slotElement.className = `time-slot p-3 rounded-lg text-center text-sm font-bold ${slotClasses}`;
                slotElement.innerHTML = `
                    <span class="block text-xs font-normal mb-1">${durationText}</span>
                    <span class="block">${slotStartTime} - ${slotEndTime}</span>
                    <span class="block text-xs font-normal mt-1">${statusText}</span>
                `;
                slotElement.disabled = isDisabled;
                
                if (!isDisabled || isSelected) {
                    slotElement.addEventListener('click', () => toggleBreakSelection(slotStartTime, duration));
                }
                
                timeSlotsContainer.appendChild(slotElement);
            });
        }

        // ******* منطق التحقق من الترتيب الزمني *******
        function toggleBreakSelection(slotStartTime, duration) {
            const index = selectedBreaks.findIndex(b => b.time === slotStartTime && b.duration === duration);
            
            if (index !== -1) {
                // إلغاء الاختيار مسموح به فقط إذا كان هو آخر بريك تم اختياره
                if (index !== selectedBreaks.length - 1) {
                    showNotification('لا يمكن إلغاء بريك من المنتصف، يجب إلغاء آخر بريك تم اختياره أولاً.', 'error');
                    return;
                }
                
                selectedBreaks.splice(index, 1);
            } else {
                // إضافة الاختيار
                
                const currentSelectionIndex = selectedBreaks.length;
                
                if (currentSelectionIndex >= MAX_TOTAL_BREAKS) {
                    showNotification('تم اختيار 3 بريكات بالفعل.', 'error');
                    return;
                }

                const requiredDuration = REQUIRED_ORDER[currentSelectionIndex];
                
                // التحقق من الترتيب الإجباري (المدة)
                if (duration !== requiredDuration) {
                    showNotification(`البريك رقم ${currentSelectionIndex + 1} يجب أن يكون ${requiredDuration} دقيقة.`, 'error');
                    return;
                }
                
                // منطق التحقق من الترتيب الزمني الجديد (التسلسل وعدم التداخل)
                if (selectedBreaks.length > 0) {
                    const lastBreak = selectedBreaks[selectedBreaks.length - 1];
                    const lastBreakStartTime = timeToDate(lastBreak.time);
                    const lastBreakEndTime = new Date(lastBreakStartTime.getTime() + lastBreak.duration * 60000); // وقت انتهاء البريك الأخير
                    const newBreakStartTime = timeToDate(slotStartTime); // وقت بدء البريك الجديد

                    // إذا كان وقت بدء البريك الجديد أصغر من أو يساوي وقت انتهاء البريك الأخير، فإنه متداخل أو معكوس.
                    if (newBreakStartTime <= lastBreakEndTime) {
                        const lastBreakEndTimeString = getBreakEndString(lastBreak.time, lastBreak.duration);
                        showNotification(`البريك رقم ${currentSelectionIndex + 1} يجب أن يبدأ بعد انتهاء البريك السابق (بعد ${lastBreakEndTimeString}).`, 'error');
                        return;
                    }
                }
                
                selectedBreaks.push({ time: slotStartTime, duration: duration });
                
                // الفرز ليس ضرورياً هنا بعد الآن بل نعتمد على ترتيب الإضافة
            }
            
            renderTimeSlots();
            selectedCount.textContent = selectedBreaks.length;
            
            const isThreeBreaks = selectedBreaks.length === MAX_TOTAL_BREAKS;
            // التحقق من الترتيب الصحيح للمدد
            const isCorrectDurationOrder = isThreeBreaks && selectedBreaks.every((b, i) => b.duration === REQUIRED_ORDER[i]);
            
            // التحقق من الترتيب الزمني (متتالي وغير متداخل)
            let isCorrectTimeOrder = true;
            for(let i = 1; i < selectedBreaks.length; i++) {
                const prevBreak = selectedBreaks[i-1];
                const currentBreak = selectedBreaks[i];

                const prevBreakStartTime = timeToDate(prevBreak.time);
                const prevBreakEndTime = new Date(prevBreakStartTime.getTime() + prevBreak.duration * 60000);
                const currentBreakStartTime = timeToDate(currentBreak.time);

                if (currentBreakStartTime <= prevBreakEndTime) {
                    isCorrectTimeOrder = false;
                    break;
                }
            }

            confirmButton.disabled = !(isCorrectDurationOrder && isCorrectTimeOrder && employeeName.value.trim());
        }

        // ******* استدعاء دالة الحفظ داخل تأكيد الحجز (تم تفعيلها هنا) *******
        async function confirmReservation() {
            const name = employeeName.value.trim();
            
            const isThreeBreaks = selectedBreaks.length === MAX_TOTAL_BREAKS;
            const isCorrectDurationOrder = isThreeBreaks && selectedBreaks.every((b, i) => b.duration === REQUIRED_ORDER[i]);
            
            let isCorrectTimeOrder = true;
            for(let i = 1; i < selectedBreaks.length; i++) {
                const prevBreak = selectedBreaks[i-1];
                const currentBreak = selectedBreaks[i];
                const prevBreakStartTime = timeToDate(prevBreak.time);
                const prevBreakEndTime = new Date(prevBreakStartTime.getTime() + prevBreak.duration * 60000);
                const currentBreakStartTime = timeToDate(currentBreak.time);
                if (currentBreakStartTime <= prevBreakEndTime) {
                    isCorrectTimeOrder = false;
                    break;
                }
            }
            
            if (!name || !isCorrectDurationOrder || !isCorrectTimeOrder) {
                showNotification('يجب إدخال الاسم واختيار 3 بريكات بالترتيب الإجباري (15، 30، 15) وبتسلسل زمني صحيح لتأكيد الحجز.', 'error');
                return;
            }
            
            // Note: employees array is now kept up-to-date by the startRealtimeSync function
            if (employees.some(emp => emp.name === name && emp.shift === selectedShift)) {
                showNotification(`الموظف ${name} لديه حجز بالفعل في هذه الوردية.`, 'error');
                return;
            }
            
            const employee = {
                name,
                shift: selectedShift,
                breaks: [...selectedBreaks], // نسخ البريكات بالوقت والمدة
                confirmedAt: new Date().toISOString()
            };
            
            // ⭐️ الخطوة الحاسمة: حفظ البيانات في Firestore (باستخدام الدالة المحدثة)
            await saveEmployeeBooking(employee);

            employeeName.value = '';
            selectedBreaks = [];
            selectedCount.textContent = '0';
            confirmButton.disabled = true;

            showNotification(`تم حجز البريكات لـ ${name} بنجاح ✅`, 'success');
        }
        
        function createBreakCellContent(breakItem) {
            const breakTime = breakItem.time;
            const duration = breakItem.duration;
            const breakEndString = getBreakEndString(breakTime, duration);
            
            const durationTextClass = duration === 30 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400';

            return `
                <span class="inline-block font-bold text-sm text-gray-800 dark:text-gray-100">${breakTime} - ${breakEndString}</span>
                <span class="block text-xs font-medium ${durationTextClass}">(${duration} دقيقة)</span>
                <div id="status-timer-${breakTime.replace(/ /g, '-').replace(/:/g, '-')}-${breakItem.duration}" class="timer-display mt-1">
                    </div>
            `;
        }

      
        function renderSchedule() {
            const filteredEmployees = employees.filter(emp => emp.shift === selectedShift);

            if (filteredEmployees.length === 0) {
                scheduleContent.innerHTML = `
                    <div class="grid grid-cols-12 text-center items-center py-4 px-2 text-gray-500 dark:text-gray-400">
                        <div class="col-span-12 p-2">لا توجد حجوزات في هذه الوردية حتى الآن</div>
                    </div>
                `;
                return;
            }
            
            // فرز الموظفين
            filteredEmployees.sort((a, b) => {
                // التأكد من أن البريك الأول موجود قبل الفرز
                const timeA = a.breaks && a.breaks.length > 0 ? timeToDate(a.breaks[0].time) : new Date(0);
                const timeB = b.breaks && b.breaks.length > 0 ? timeToDate(b.breaks[0].time) : new Date(0);
                return timeA - timeB;
            });
            
            scheduleContent.innerHTML = filteredEmployees.map((emp, index) => {
                const rowClass = index % 2 === 0 ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-900';
                
                // التأكد من وجود 3 بريكات (يمكن أن يكون البريك محذوفًا إدارياً)
                const breaksArray = emp.breaks || [];
                
                // ملء الفراغات بـ null إذا كان العدد أقل من 3 للعرض الصحيح
                const displayBreaks = [...breaksArray];
                while(displayBreaks.length < MAX_TOTAL_BREAKS) {
                    displayBreaks.push(null);
                }
                
                const breakCells = displayBreaks.map((breakItem, breakIndex) => {
                    // تحديد ما إذا كان هذا البريك هو البريك الثاني (30 دقيقة)
                    const isLunch = breakIndex === 1 && breakItem && breakItem.duration === 30;
                    
                    if (breakItem) {
                         return `
                            <div class="col-span-3 p-3 border-r border-gray-200 dark:border-gray-700 ${isLunch ? 'bg-yellow-50 dark:bg-gray-700' : ''}">
                                ${createBreakCellContent(breakItem)}
                            </div>
                        `;
                    } else {
                        return `
                             <div class="col-span-3 p-3 border-r border-gray-200 dark:border-gray-700 text-gray-400 text-sm">
                                <span class="font-medium">غير محجوز</span>
                            </div>
                        `;
                    }
                }).join('');
                
                return `
                    <div class="grid grid-cols-12 text-center items-center py-3 px-2 ${rowClass} hover:bg-indigo-50 dark:hover:bg-indigo-900/40 transition-colors">
                        <div class="col-span-3 p-3 font-extrabold text-gray-900 dark:text-white border-r border-gray-200 dark:border-gray-700">
                            ${emp.name} 
                        </div>
                        ${breakCells}
                    </div>
                `;
            }).join('');
            
            // FIX: استدعاء Feather Replace بعد إضافة محتوى جديد
            feather.replace();
        }

        let timerInterval = null;

        function updateTimer(breakItem) {
            const now = new Date();
            const breakStartTime = timeToDate(breakItem.time);
            const breakEndTime = new Date(breakStartTime.getTime() + breakItem.duration * 60000);
            
            const timerId = `status-timer-${breakItem.time.replace(/ /g, '-').replace(/:/g, '-')}-${breakItem.duration}`;
            const timerElement = document.getElementById(timerId);

            if (!timerElement) return; // قد لا يكون العنصر موجوداً إذا تم تبديل الوردية

            let statusHTML = '';

            if (now < breakStartTime) {
                // حالة: لم يبدأ بعد (يتبقى)
                const msUntilStart = breakStartTime.getTime() - now.getTime();
                statusHTML = `
                    <span class="timer-text text-blue-600 dark:text-blue-400">
                        يبدأ بعد: ${formatTimeDifference(msUntilStart)}
                    </span>
                `;
            } else if (now >= breakStartTime && now < breakEndTime) {
                // حالة: البريك قيد التشغيل (متبقي)
                const msRemaining = breakEndTime.getTime() - now.getTime();
                statusHTML = `
                    <span class="timer-text text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/50 px-2 py-0.5 rounded-full">
                        متبقي: ${formatTimeDifference(msRemaining)}
                    </span>
                `;
            } else {
                // حالة: انتهى البريك
                statusHTML = `
                    <span class="timer-text text-gray-500 dark:text-gray-500">
                        انتهى البريك
                    </span>
                `;
            }

            timerElement.innerHTML = statusHTML;
        }

        function updateAllTimers() {
            if (!selectedShift) return;

            // تحديد جميع البريكات في الوردية المحددة حالياً
            const activeBreaks = employees
                                    .filter(emp => emp.shift === selectedShift)
                                    .flatMap(emp => emp.breaks || []); // التأكد من أن breaks موجودة
            
            // تحديث مؤقت كل بريك
            activeBreaks.forEach(breakItem => updateTimer(breakItem));

            // تحديث الساعة الحالية
            const now = new Date();
            const options = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            currentTimeDisplay.textContent = `الساعة الحالية: ${now.toLocaleTimeString('ar-EG', options)}`;
        }

        function startTimerLoop() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            // تحديث كل ثانية
            timerInterval = setInterval(updateAllTimers, 1000);
        }
        
        function resetSelection() {
            window.selectedShift = selectedShift = null;
            selectedBreaks = [];
            employeeName.value = '';
            selectedCount.textContent = '0';
            confirmButton.disabled = true;
            
            shiftSelection.classList.remove('hidden');
            breakSelection.classList.add('hidden');
        }
        
        // ******* وظائف الإدارة (Admin) *******
        
        function checkAdminLogin() {
            if (adminCode.value === ADMIN_CODE) {
                adminStep1.classList.add('hidden');
                adminStep2.classList.remove('hidden');
                showNotification('تم تسجيل الدخول بنجاح.', 'success');
                adminCode.value = '';
                adminModal.classList.remove('opacity-0');
            } else {
                showNotification('الرمز السري غير صحيح.', 'error');
                adminCode.value = '';
            }
        }
        
        function openAdminModal() {
            adminModal.classList.remove('hidden');
            // التأكد من عرض الخطوة الأولى دائماً عند الفتح
            adminStep1.classList.remove('hidden');
            adminStep2.classList.add('hidden');
            setTimeout(() => {
                adminModal.classList.remove('opacity-0');
            }, 10); // تأخير بسيط للتحول
        }

        // دالة مساعدة لإعادة ربط الأحداث بعد إعادة رسم محتوى adminStep2
        function rebindAdminEvents() {
            // ربط دوال الإدارة الجديدة بـ Firestore
            document.getElementById('deleteStorageButton').addEventListener('click', clearAllBookings); 
            document.getElementById('deleteEmployeeButton').addEventListener('click', deleteEmployeeFullRecord); 
            document.getElementById('deleteSingleBreakButton').addEventListener('click', deleteSingleBreak);
        }
        
        // ------------------------------------

        // INITIALIZATION AND EVENT LISTENERS
        
        // ربط الأحداث
        confirmButton.addEventListener('click', confirmReservation);
        employeeName.addEventListener('input', () => {
            const isThreeBreaks = selectedBreaks.length === MAX_TOTAL_BREAKS;
            const isCorrectDurationOrder = isThreeBreaks && selectedBreaks.every((b, i) => b.duration === REQUIRED_ORDER[i]);
            confirmButton.disabled = !(isCorrectDurationOrder && employeeName.value.trim());
        });
        
        // ربط حدث تبديل الوضع
        themeToggle.addEventListener('click', toggleTheme);
        
        // ****** ربط أحداث الإدارة الجديدة ******
        adminToggle.addEventListener('click', openAdminModal);
        adminLoginButton.addEventListener('click', checkAdminLogin);
        rebindAdminEvents(); // ربط الأحداث عند التحميل الأولي
        
        adminCode.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                checkAdminLogin();
            }
        });
        // ***************************************

        // ⭐️⭐️⭐️ الخطوة الحاسمة: تطبيق الوضع الأولي عند تحميل الصفحة ⭐️⭐️⭐️
        // هذا يضمن أن يتم تحديث الثيم والأيقونة مباشرة بعد تحميل الـ JS
        applyInitialTheme();

        // بدء حلقة المؤقت
        startTimerLoop();
        updateAllTimers(); // تحديث أولي للساعة والمؤقتات
    </script>
</body>
</html>
