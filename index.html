<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Break Time Buddy - Ø¬Ø¯ÙˆÙ„ Ø­Ø¬Ø² Ø§Ù„Ø¨Ø±ÙŠÙƒØ§Øª</title>
    
    <!-- ØªØ­Ù…ÙŠÙ„ Tailwind CSS Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ØªØ£ÙƒÙŠØ¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Tailwind Ù„ØªÙØ¹ÙŠÙ„ dark mode Ø¹Ø¨Ø± Ø§Ù„ÙØ¦Ø© (class) -->
    <script>
        tailwind.config = {
            darkMode: 'class', 
        }
    </script>
                      <link rel="icon" href="images/favicon.png" type="image/png" />


    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app-check.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, deleteDoc, collection, query, onSnapshot, getDocs, where, setLogLevel } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js"; 

    setLogLevel('Debug'); 

    // =========================================================================
    // ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ø³Ù…Ø©: Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙØªØ§Ø­ ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´
    const RECAPTCHA_SITE_KEY = 'YOUR_RECAPTCHA_V3_SITE_KEY'; 

    // 1. Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    let firebaseConfig = {
        apiKey: "AIzaSyARZtk0LhDVK6aj-C-aFcqzn7trBA_aZ9o",
        authDomain: "breaktime-8e28a.firebaseapp.com",
        projectId: "breaktime-8e28a",
        storageBucket: "breaktime-8e28a.firebasestorage.app",
        messagingSenderId: "653808445317",
        appId: "1:653808445317:web:55aa4a365b8fcf4ac246ec",
        measurementId: "G-077KHT3Y1L"
    };
    // ... (ÙƒÙˆØ¯ Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©)
    try {
        const globalConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        firebaseConfig = { ...firebaseConfig, ...globalConfig };
    } catch (e) {
        console.error("Error parsing __firebase_config:", e);
    }
    // ... (ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)
    if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
        console.error("Firebase configuration is missing or empty.");
        window.showNotification('Ø®Ø·Ø£: Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ù…ÙÙ‚ÙˆØ¯Ø©. Ù„Ù† ØªØ¹Ù…Ù„ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­ÙØ¸.', 'error');
        firebaseConfig = { projectId: "default-app-id" }; 
    }
    
    const appId = typeof __app_id !== 'undefined' && __app_id !== 'default-app-id' ? __app_id : firebaseConfig.projectId;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // 2. ØªÙ‡ÙŠØ¦Ø© Firebase
    let app;
    try {
         app = initializeApp(firebaseConfig);
         
         // ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ Ù…ÙˆØ¶Ø¹ ØªÙ‡ÙŠØ¦Ø© App Check ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´
         if (RECAPTCHA_SITE_KEY && RECAPTCHA_SITE_KEY !== 'YOUR_RECAPTCHA_V3_SITE_KEY') {
            const appCheck = initializeAppCheck(app, {
                provider: new ReCaptchaV3Provider(RECAPTCHA_SITE_KEY),
                isTokenAutoRefreshEnabled: true
            });
            console.log("Firebase App Check initialized with ReCAPTCHA V3.");
         } else {
             // ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙØªØ§Ø­
             console.warn("App Check not fully initialized: Missing or placeholder ReCAPTCHA V3 key. This may cause (auth/firebase-app-check-token-is-invalid).");
         }

         const analytics = getAnalytics(app);
    } catch (e) {
         console.error("Failed to initialize Firebase App:", e);
    }

    let firebaseDb = app ? getFirestore(app) : null;
    let firebaseAuth = app ? getAuth(app) : null; 
    
    // ... (Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙŠØ¸Ù„ ÙƒÙ…Ø§ Ù‡Ùˆ)
    let userId = null; 
    let isAuthReady = false;
    const collectionPath = `artifacts/${appId}/public/data/public_bookings`;

    window.getDb = () => firebaseDb; 
    window.getAuth = () => firebaseAuth; 
    window.getUserId = () => userId;
    window.getIsAuthReady = () => isAuthReady;
    window.getAppId = () => appId; 
    
    window.doc = doc;
    window.setDoc = setDoc;
    window.deleteDoc = deleteDoc;
    window.collection = collection;
    window.getDocs = getDocs;
    window.query = query;
    window.where = where;
    
    window.startRealtimeSync = function() {
        if (!window.getDb() || !window.getIsAuthReady()) {
            return; 
        }
        
        const employeeBookingsRef = collection(window.getDb(), collectionPath);

        const unsubscribe = onSnapshot(employeeBookingsRef, (snapshot) => {
            const fetchedEmployees = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));

            if (typeof window.setEmployees === 'function') {
                window.setEmployees(fetchedEmployees);
            } else {
                console.error("setEmployees function not found. Data not updated.");
                return;
            }
            
            if (window.selectedShift) {
                window.renderTimeSlots(); 
                window.renderSchedule();  
                window.updateAllTimers(); 
            }

            console.log("Employees data synchronized from Firestore.");
            window.showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª.', 'info');

        }, (error) => {
            console.error("Firestore read failed: " + error.message);
            if (!error.message.includes("is not initialized")) {
                window.showNotification("ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª: " + error.message, 'error');
            }
        });
        window.firestoreUnsubscribe = unsubscribe;
    };

    try {
        async function authenticateAndSetup() {
            if (!firebaseAuth) {
                isAuthReady = true;
                return;
            }
             try {
                if (initialAuthToken) {
                    await signInWithCustomToken(firebaseAuth, initialAuthToken);
                    console.log("Signed in with Custom Token.");
                } else { 
                    await signInAnonymously(firebaseAuth);
                    console.log("Signed in Anonymously.");
                }
            } catch(error) {
                console.error("Error during Firebase sign-in:", error);
                window.showNotification(`ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: ${error.message}`, 'error');
            }

            onAuthStateChanged(firebaseAuth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Firebase Auth Ready. User ID:", userId);
                    window.startRealtimeSync(); 
                } else {
                    userId = null;
                    isAuthReady = true;
                    console.log("Firebase Auth Ready: No user logged in.");
                }
            });
        }
        
        if (app) {
            authenticateAndSetup(); 
        } else {
            isAuthReady = true; 
            window.showNotification('ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Firebase. Ù„Ù† ØªØ¹Ù…Ù„ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­ÙØ¸/Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©.', 'error');
        }


    } catch (e) {
        console.error("Failed to initialize Firebase:", e);
    }

        try {
            // â­ï¸â­ï¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: Ø§Ø³ØªØ®Ø¯Ø§Ù… initialAuthToken Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø© â­ï¸â­ï¸
            async function authenticateAndSetup() {
                if (!firebaseAuth) {
                    isAuthReady = true;
                    return;
                }
                 try {
                    if (initialAuthToken) {
                        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ø®ØµØµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
                        await signInWithCustomToken(firebaseAuth, initialAuthToken);
                        console.log("Signed in with Custom Token.");
                    } else { 
                        // Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„Ø© ÙƒØ®ÙŠØ§Ø± Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                        await signInAnonymously(firebaseAuth);
                        console.log("Signed in Anonymously.");
                    }
                } catch(error) {
                    console.error("Error during Firebase sign-in:", error);
                    window.showNotification(`ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: ${error.message}`, 'error');
                }

                // 2. Auth State Listener
                onAuthStateChanged(firebaseAuth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        // Start real-time sync when auth is ready
                        window.startRealtimeSync(); 
                    } else {
                        userId = null;
                        isAuthReady = true;
                        console.log("Firebase Auth Ready: No user logged in.");
                    }
                });
            }
            
            if (app) {
                authenticateAndSetup(); // Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­
            } else {
                isAuthReady = true; 
                window.showNotification('ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Firebase. Ù„Ù† ØªØ¹Ù…Ù„ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­ÙØ¸/Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©.', 'error');
            }


        } catch (e) {
            console.error("Failed to initialize Firebase:", e);
        }

    </script>
    
    <!-- ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <link rel="icon" href="images/favicon.png" type="image/png" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
        body {
            font-family: 'Tajawal', sans-serif;
        }
        /* Custom styles for the break selection buttons */
        .time-slot {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .time-slot:hover:not(.booked):not([disabled]) {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        /* Dark Mode adjustments for custom hover effect */
        /* NOTE: Now targetting body.dark */
        body.dark .time-slot:hover:not(.booked):not([disabled]) {
            box-shadow: 0 8px 15px rgba(255, 255, 255, 0.05);
        }

        .floating-notification {
            animation: floatUp 4s ease forwards;
        }
        @keyframes floatUp {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .timer-text {
            font-size: 0.75rem; /* text-xs */
            font-weight: 700; /* font-bold */
        }
         /* Style for the Admin Modal */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
    </style>
</head>
<!-- ØªÙ… ØªØºÙŠÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù„ÙŠØµØ¨Ø­ BODY Ù‡Ùˆ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù€ DARK MODE -->
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen dark:from-gray-900 dark:to-black dark:text-gray-100">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-12 relative">
            
            <button id="themeToggle" class="absolute top-0 left-0 p-3 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 dark:bg-gray-700 dark:text-yellow-400 dark:hover:bg-gray-600 transition-colors" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹">
                <!-- ØªÙ… ØªØ±Ùƒ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù‡Ù†Ø§ØŒ ÙˆØ³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨Ø§Ù„Ù€ JS Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
                <i id="themeIcon" data-feather="moon" class="w-6 h-6"></i>
            </button>
            
            <button id="adminToggle" class="absolute top-0 right-0 p-3 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 dark:bg-gray-700 dark:text-indigo-400 dark:hover:bg-gray-600 transition-colors" title="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… (Ø¥Ø¯Ø§Ø±Ø©)">
                <i data-feather="settings" class="w-6 h-6"></i>
            </button>
            <h1 class="text-5xl font-extrabold text-indigo-800 mb-2 tracking-wide dark:text-indigo-400">BreakTime â³</h1>
            <p class="text-lg text-gray-600 dark:text-gray-400">Ù†Ø¸Ø§Ù… Ø­Ø¬Ø² ÙˆÙ…ØªØ§Ø¨Ø¹Ø© ÙØªØ±Ø§Øª Ø§Ù„Ø±Ø§Ø­Ø© (Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ: 15 Ø¯ØŒ 30 Ø¯ØŒ 15 Ø¯)</p>
        </header>

        <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden dark:bg-gray-800 dark:shadow-none dark:border dark:border-indigo-900">
            
            <div id="shiftSelection" class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-3xl font-extrabold text-indigo-900 mb-6 text-center dark:text-white">
                    Ø§Ø®ØªØ± ÙˆØ±Ø¯ÙŠØ© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button id="morningShift" onclick="selectShift('morning')" 
                            class="shift-card bg-white dark:bg-gray-700 dark:border-gray-600 border-2 border-transparent p-6 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:scale-[1.02] cursor-pointer focus:outline-none focus:ring-4 focus:ring-blue-300 dark:hover:shadow-indigo-900/50">
                        <div class="flex flex-col items-center">
                            <i data-feather="sun" class="w-12 h-12 text-yellow-500 mb-3 drop-shadow-md"></i>
                            <span class="text-xl font-extrabold text-gray-800 mb-1 dark:text-gray-100">Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„ØµØ¨Ø§Ø­ÙŠ</span>
                            <span class="text-sm text-gray-500 font-medium dark:text-gray-300">9:00 ØµØ¨Ø§Ø­Ù‹Ø§ - 5:00 Ù…Ø³Ø§Ø¡Ù‹</span>
                            <span class="mt-4 inline-block bg-blue-50 text-blue-700 text-xs font-bold px-3 py-1 rounded-full dark:bg-blue-900 dark:text-blue-300">
                                Ø§Ù„Ø¨Ø±ÙŠÙƒ Ù…ØªØ§Ø­ Ø¨ÙŠÙ† 10:00 Øµ Ùˆ 4:00 Ù…
                            </span>
                        </div>
                    </button>

                    <button id="eveningShift" onclick="selectShift('evening')" 
                            class="shift-card bg-white dark:bg-gray-700 dark:border-gray-600 border-2 border-transparent p-6 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:scale-[1.02] cursor-pointer focus:outline-none focus:ring-4 focus:ring-purple-300 dark:hover:shadow-indigo-900/50">
                        <div class="flex flex-col items-center">
                            <i data-feather="moon" class="w-12 h-12 text-purple-600 mb-3 drop-shadow-md"></i>
                            <span class="text-xl font-extrabold text-gray-800 mb-1 dark:text-gray-100">Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ù…Ø³Ø§Ø¦ÙŠ</span>
                            <span class="text-sm text-gray-500 font-medium dark:text-gray-300">3:00 Ù…Ø³Ø§Ø¡Ù‹ - 11:00 Ù…Ø³Ø§Ø¡Ù‹</span>
                            <span class="mt-4 inline-block bg-purple-50 text-purple-700 text-xs font-bold px-3 py-1 rounded-full dark:bg-purple-900 dark:text-purple-300">
                                Ø§Ù„Ø¨Ø±ÙŠÙƒ Ù…ØªØ§Ø­ Ø¨ÙŠÙ† 4:00 Ù… Ùˆ 10:00 Ù…
                            </span>
                        </div>
                    </button>
                </div>
            </div>

            <div id="breakSelection" class="hidden p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-100">Ø§Ø®ØªØ± ÙØªØ±Ø§Øª Ø§Ù„Ø±Ø§Ø­Ø© (Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ):</h2>
                    <div class="flex items-center gap-2 bg-indigo-100 text-indigo-800 font-bold px-4 py-1.5 rounded-full text-lg dark:bg-indigo-900 dark:text-indigo-300">
                        <span id="selectedCount">0</span>
                        <span>/ 3</span>
                    </div>
                </div>
                
                <p class="text-sm text-center text-gray-600 mb-4 font-bold dark:text-gray-400">
                    ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø±ÙŠÙƒØ§Øª Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨: <span class="text-indigo-700 dark:text-indigo-300">15 Ø¯Ù‚ÙŠÙ‚Ø©</span> ØŒ Ø«Ù… <span class="text-red-700 dark:text-red-300">30 Ø¯Ù‚ÙŠÙ‚Ø©</span> ØŒ Ø«Ù… <span class="text-indigo-700 dark:text-indigo-300">15 Ø¯Ù‚ÙŠÙ‚Ø©</span>.
                </p>
                
                <div id="timeSlotsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-6 p-3 bg-gray-50 rounded-lg border border-gray-200 dark:bg-gray-900 dark:border-gray-700">
                    </div>
                
                <div class="flex flex-col sm:flex-row gap-3">
                    <input id="employeeName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù" 
                           class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                    
                    <button id="confirmButton" disabled class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed dark:bg-indigo-700 dark:hover:bg-indigo-600">
                        ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²
                    </button>
                    <button onclick="resetSelection()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-6 rounded-lg shadow-md transition-all duration-300 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-white">
                        Ø§Ø®ØªÙŠØ§Ø± ÙˆØ±Ø¯ÙŠØ© Ø£Ø®Ø±Ù‰
                    </button>
                </div>
            </div>

            <div id="scheduleDisplay" class="p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 dark:text-gray-100">Ø¬Ø¯ÙˆÙ„ ÙØªØ±Ø§Øª Ø§Ù„Ø±Ø§Ø­Ø© Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø©</h2>
                
                <div id="scheduleTable" class="bg-gray-50 rounded-xl shadow-inner overflow-hidden border border-gray-200 dark:bg-gray-900 dark:border-indigo-900">
                    <div class="grid grid-cols-12 bg-gray-200 font-bold text-gray-700 text-sm md:text-base dark:bg-gray-700 dark:text-gray-200">
                        <div class="col-span-3 p-3 border-r border-gray-300 text-center dark:border-gray-600">Ø§Ù„Ù…ÙˆØ¸Ù</div>
                        <div class="col-span-3 p-3 border-r border-gray-300 text-center dark:border-gray-600">Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø£ÙˆÙ„ (15 Ø¯)</div>
                        <div class="col-span-3 p-3 border-r border-gray-300 text-center dark:border-gray-600">Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø«Ø§Ù†ÙŠ (30 Ø¯)</div>
                        <div class="col-span-3 p-3 text-center">Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø«Ø§Ù„Ø« (15 Ø¯)</div>
                    </div>
                    <div id="scheduleContent" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <div class="grid grid-cols-12 text-center items-center py-4 px-2 text-gray-500 dark:text-gray-400">
                            <div class="col-span-12 p-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-6 text-center text-gray-600 dark:text-gray-400">
            <p id="currentTime" class="text-md font-medium bg-white/50 inline-block px-4 py-2 rounded-lg shadow-inner dark:bg-gray-800/50"></p>
        </div>

        <div id="notificationContainer" class="fixed bottom-4 right-4 space-y-2 z-50"></div>
    </div>

    <div id="adminModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg dark:bg-gray-800 dark:border dark:border-indigo-900">
            <div class="flex justify-between items-center border-b pb-3 mb-4 dark:border-gray-700">
                <h3 class="text-2xl font-bold text-indigo-700 dark:text-indigo-400">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… (Admin)</h3>
                <button onclick="document.getElementById('adminModal').classList.add('hidden', 'opacity-0')" class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-400">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div id="adminStep1">
                <p class="mb-4 text-gray-600 dark:text-gray-300">Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ:</p>
                <input id="adminCode" type="password" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ"
                       class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <button id="adminLoginButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600">
                    Ø¯Ø®ÙˆÙ„
                </button>
            </div>

            <div id="adminStep2" class="hidden">
                <p class="text-lg font-semibold mb-3 text-indigo-700 dark:text-indigo-400 border-b pb-2 dark:border-gray-700">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹:</p>
                
                <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg dark:bg-yellow-900/20 dark:border-yellow-900">
                    <h4 class="text-lg font-bold text-yellow-800 dark:text-yellow-400 mb-2">Ø­Ø°Ù Ø¨Ø±ÙŠÙƒ Ù„Ù…ÙˆØ¸Ù Ù…Ø­Ø¯Ø¯ (Admin Override)</h4>
                    <p class="text-sm text-yellow-700 dark:text-yellow-300 mb-3">ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø¨Ø±ÙŠÙƒ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø³Ø¬Ù„ Ù…ÙˆØ¸Ù Ù…Ø¹ÙŠÙ† **Ø¨Ø§Ù„Ø§Ø³Ù…** ÙˆØ±Ù‚Ù… Ø§Ù„Ø¨Ø±ÙŠÙƒ (1ØŒ 2ØŒ Ø£Ùˆ 3).</p>
                    <input id="deleteBreakName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù"
                           class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <input id="deleteBreakIndex" type="number" min="1" max="3" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø±ÙŠÙƒ (1 Ø£Ùˆ 2 Ø£Ùˆ 3)"
                           class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <button id="deleteSingleBreakButton" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg shadow-md transition-colors dark:bg-yellow-700 dark:hover:bg-yellow-600">
                        <i data-feather="minus-circle" class="w-5 h-5 inline-block ml-2"></i>
                        Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠÙƒ
                    </button>
                </div>

                <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg dark:bg-red-900/20 dark:border-red-900">
                    <h4 class="text-lg font-bold text-red-800 dark:text-red-400 mb-2">Ø­Ø°Ù Ù…ÙˆØ¸Ù ÙƒØ§Ù…Ù„ ÙˆØ³Ø¬Ù„ Ø¨Ø±ÙŠÙƒØ§ØªÙ‡ âš ï¸</h4>
                    <p class="text-sm text-red-700 dark:text-red-300 mb-3">Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨Ø±ÙŠÙƒØ§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ø§Ù„Ø§Ø³Ù… ÙˆØ¬Ø¹Ù„Ù‡Ø§ Ù…ØªØ§Ø­Ø© Ù„Ù„Ø­Ø¬Ø² Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>
                    <input id="deleteEmployeeName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„"
                           class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <button id="deleteEmployeeButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg shadow-md transition-colors dark:bg-red-700 dark:hover:bg-red-600">
                        <i data-feather="user-x" class="w-5 h-5 inline-block ml-2"></i>
                        Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ­Ø¬ÙˆØ²Ø§ØªÙ‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                    </button>
                </div>
                
                <p class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-200 border-b pb-2 dark:border-gray-700">Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø¨Ø§Ù„ÙƒØ§Ù…Ù„:</p>
                <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg dark:bg-red-900/20 dark:border-red-900">
                    <p class="text-sm font-medium text-red-700 dark:text-red-400 mb-2">âš ï¸ Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
                </div>

                <button id="deleteStorageButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg shadow-md transition-colors dark:bg-red-700 dark:hover:bg-red-600">
                    <i data-feather="trash-2" class="w-5 h-5 inline-block ml-2"></i>
                    Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                </button>
                <p class="text-xs text-red-500 mt-2 text-center dark:text-red-400">âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.</p>
            </div>

        </div>
    </div>
    <script>
        
        // ****** Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ******
        let selectedShift = null;
        let employees = [];
        let selectedBreaks = []; // Ø³ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒØ§Ø¦Ù†Ø§Øª { time: "10:00 Øµ", duration: 15 }
        
        // NEW: Global setter for employees, called from module script (startRealtimeSync)
        window.setEmployees = (newEmployees) => {
            employees = newEmployees;
        };

        const BREAK_TYPES = {
            '15': 15, // Ù…Ø¯Ø© 15 Ø¯Ù‚ÙŠÙ‚Ø©
            '30': 30  // Ù…Ø¯Ø© 30 Ø¯Ù‚ÙŠÙ‚Ø©
        };
        const MAX_TOTAL_BREAKS = 3;
        
        // ******* Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„ÙØ±Ø¶ Ø§Ù„ØªØ±ØªÙŠØ¨ *******
        const REQUIRED_ORDER = [15, 30, 15]; // Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ: 15 Ø¯ØŒ 30 Ø¯ØŒ 15 Ø¯
        
        
        // ØªÙˆÙ„ÙŠØ¯ ÙØªØ±Ø§Øª Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ù…ØªØ§Ø­Ø©
        const generateBreakTimes = (startHour, endHour) => {
            const slots = [];
            for (let h = startHour; h < endHour; h++) {
                for (let m = 0; m < 60; m += 15) {
                    let time = `${String(h % 12 || 12).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    let period = h >= 12 && h < 24 ? 'Ù…' : 'Øµ';
                    
                    // Ø¨Ø±ÙŠÙƒ 15 Ø¯Ù‚ÙŠÙ‚Ø©
                    if (h + (m + 15) / 60 <= endHour) {
                        slots.push({ time: `${time} ${period}`, duration: 15 });
                    }
                    
                    // Ø¨Ø±ÙŠÙƒ 30 Ø¯Ù‚ÙŠÙ‚Ø© (ÙÙ‚Ø· ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†ØµÙ Ø§Ù„Ø³Ø§Ø¹Ø©)
                    if (m % 30 === 0 && h + (m + 30) / 60 <= endHour) {
                        slots.push({ time: `${time} ${period}`, duration: 30 });
                    }
                }
            }
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª
            const uniqueSlots = Array.from(new Set(slots.map(s => `${s.time}-${s.duration}`)))
                                             .map(str => {
                                                 const [time, durationStr] = str.split('-');
                                                 return { time: time, duration: Number(durationStr) };
                                             });
            
            // Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø·Ø§Ù‚
            const filterSlots = (slots, startHour, endHour) => {
                const today = new Date();
                return slots.filter(slot => {
                    const [timeStr, period] = slot.time.split(' ');
                    let [hours, minutes] = timeStr.split(':').map(Number);
                    if (period === 'Ù…' && hours !== 12) hours += 12;
                    if (period === 'Øµ' && hours === 12) hours = 0;
                    
                    // ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† ÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ù„Ù„Ø¨Ø±ÙŠÙƒ
                    const startTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes, 0, 0);
                    const endTime = new Date(startTime.getTime() + slot.duration * 60000);
                    
                    // ØªØ­ÙˆÙŠÙ„ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ 24 Ø³Ø§Ø¹Ø© Ù„ØºØ±Ø¶ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
                    const endLimit = new Date(today.getFullYear(), today.getMonth(), today.getDate(), endHour, 0, 0, 0);
                    
                    return endTime <= endLimit;
                });
            };
            
            return filterSlots(uniqueSlots, startHour, endHour).sort((a, b) => timeToDate(a.time) - timeToDate(b.time));
        };

        const morningBreakStartTimes = generateBreakTimes(10, 16); // 10:00 Øµ Ø¥Ù„Ù‰ 4:00 Ù… (16:00)
        const eveningBreakStartTimes = generateBreakTimes(16, 22); // 4:00 Ù… (16:00) Ø¥Ù„Ù‰ 10:00 Ù… (22:00)

        const shiftSelection = document.getElementById('shiftSelection');
        const breakSelection = document.getElementById('breakSelection');
        const timeSlotsContainer = document.getElementById('timeSlotsContainer');
        const selectedCount = document.getElementById('selectedCount');
        const employeeName = document.getElementById('employeeName');
        const confirmButton = document.getElementById('confirmButton');
        const scheduleContent = document.getElementById('scheduleContent');
        const currentTimeDisplay = document.getElementById('currentTime');
        const notificationContainer = document.getElementById('notificationContainer');
        const themeToggle = document.getElementById('themeToggle');
        // ØªÙ… ØªØ¹Ø±ÙŠÙ themeIcon Ù‡Ù†Ø§
        const themeIcon = document.getElementById('themeIcon');
        
        // ****** Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ******
        const ADMIN_CODE = '!#?!#!@@??#!'; // Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©
        const adminToggle = document.getElementById('adminToggle');
        const adminModal = document.getElementById('adminModal');
        const adminCode = document.getElementById('adminCode');
        const adminLoginButton = document.getElementById('adminLoginButton');
        const adminStep1 = document.getElementById('adminStep1');
        const adminStep2 = document.getElementById('adminStep2');
        const deleteStorageButton = document.getElementById('deleteStorageButton');
        const storageSizeDisplay = document.getElementById('storageSizeDisplay');
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ø®Ø§ØµÙŠØ© Ø­Ø°Ù Ø¨Ø±ÙŠÙƒ Ù…ÙˆØ¸Ù Ù…Ø­Ø¯Ø¯ (Ù…ÙˆØ¬ÙˆØ¯Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹)
        const deleteBreakName = document.getElementById('deleteBreakName');
        const deleteBreakIndex = document.getElementById('deleteBreakIndex');
        const deleteSingleBreakButton = document.getElementById('deleteSingleBreakButton');
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø®Ø§ØµÙŠØ© Ø­Ø°Ù Ù…ÙˆØ¸Ù ÙƒØ§Ù…Ù„
        const deleteEmployeeName = document.getElementById('deleteEmployeeName');
        const deleteEmployeeButton = document.getElementById('deleteEmployeeButton');
        // *******************************************************
        
        // UTILITY FUNCTIONS

        function timeToDate(timeString) {
            const [time, period] = timeString.split(' ');
            let [hours, minutes] = time.split(':').map(Number);

            if (period === 'Ù…' && hours !== 12) {
                hours += 12;
            } else if (period === 'Øµ' && hours === 12) {
                hours = 0;
            }

            const today = new Date();
            let date = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes, 0, 0);
            
            return date;
        }

        function formatTimeDifference(ms) {
            const totalSeconds = Math.max(0, Math.floor(ms / 1000));
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            const pad = (num) => num.toString().padStart(2, '0');
            
            if (hours > 0) return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
            return `${pad(minutes)}:${pad(seconds)}`;
        }
        
        function getBreakEndString(startTime, duration) {
            const startDate = timeToDate(startTime);
            const endDate = new Date(startDate.getTime() + duration * 60000);
            
            const options = { hour: '2-digit', minute: '2-digit', hour12: true };
            let endString = endDate.toLocaleTimeString('ar-EG', options);
            
            // ØªØµØ­ÙŠØ­ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ (Ù‚Ø¯ ØªØ®ØªÙ„Ù Ø§Ù„Ø¨ÙŠØ¦Ø©)
            endString = endString.replace('Øµ', 'Øµ').replace('Ù…', 'Ù…'); 
            
            return endString;
        }
        
        /**
         * ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø«ÙŠÙ… (dark/light) ÙÙŠ localStorage ÙˆØ¹Ù„Ù‰ Ø¹Ù†ØµØ± <body>.
         * ÙˆØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„.
         */
        function updateTheme(mode) {
            const targetElement = document.body; // ØªØºÙŠÙŠØ± Ø§Ù„Ù‡Ø¯Ù Ù…Ù† html Ø¥Ù„Ù‰ body
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆØ¶Ø¹ "dark" (Ù„ÙŠÙ„ÙŠ)ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªØ¸Ù‡Ø± Ø£ÙŠÙ‚ÙˆÙ†Ø© "sun" (Ø´Ù…Ø³) Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­
            const newIcon = mode === 'dark' ? 'sun' : 'moon'; 

            if (mode === 'dark') {
                targetElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                targetElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
            
            const iconEl = document.getElementById('themeIcon');
            if (iconEl) {
                iconEl.setAttribute('data-feather', newIcon);
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Feather Icons Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
            feather.replace(); 

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø±ÙŠÙƒØ§Øª
            if (selectedShift) {
                renderTimeSlots();
                renderSchedule();
            }
        }
        
        /**
         * ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (dark <-> light)
         */
        function toggleTheme() {
            const targetElement = document.body;
            const currentMode = targetElement.classList.contains('dark') ? 'dark' : 'light';
            const newMode = currentMode === 'dark' ? 'light' : 'dark';
            updateTheme(newMode);
        }

        /**
         * ØªØ·Ø¨ÙŠÙ‚ ØªÙØ¶ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©.
         */
        function applyInitialTheme() {
            const isDarkMode = localStorage.getItem('theme') === 'dark' || 
                                (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            
            if (isDarkMode) {
                updateTheme('dark');
            } else {
                updateTheme('light');
            }
        }

        function showNotification(message, type) {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-orange-500'
            };
            const icon = {
                success: 'check-circle',
                error: 'x-circle',
                info: 'info',
                warning: 'alert-triangle'
            };

            const notification = document.createElement('div');
            notification.className = `floating-notification flex items-center p-4 rounded-lg shadow-xl text-white ${colors[type]} transform translate-y-20 opacity-0`;
            notification.innerHTML = `
                <i data-feather="${icon[type]}" class="w-6 h-6 ml-2"></i>
                <span class="font-medium">${message}</span>
            `;
            
            notificationContainer.appendChild(notification);
            feather.replace();

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ø¯Ø© Ø§Ù„Ø£Ù†Ù…ÙŠØ´Ù†
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // ****** Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… window.doc Ùˆ window.setDoc) ******
        /**
         * Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø­Ø¬Ø² Ù…ÙˆØ¸Ù ÙÙŠ Firestore.
         */
        async function saveEmployeeBooking(employeeData) {
            const db = window.getDb();
            
            if (!db || !window.getIsAuthReady()) {
                showNotification('Ù„Ù… ÙŠØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù„Ù… ØªÙƒØªÙ…Ù„.', 'error');
                return;
            }
            
            // â­ï¸â­ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ â­ï¸â­ï¸
            const collectionPath = 'artifacts/' + window.getAppId() + '/public/data/public_bookings';

            // Ø¥Ù†Ø´Ø§Ø¡ Doc ID ÙØ±ÙŠØ¯ (Ù…Ø«Ù„Ø§Ù‹: "Ahmed_morning" Ø£Ùˆ "Layla_evening")
            const docId = `${employeeData.name.replace(/[^a-zA-Z0-9]/g, '')}_${employeeData.shift}`;
            
            const docRef = window.doc(db, collectionPath, docId);

            try {
                await window.setDoc(docRef, employeeData, { merge: true }); 
                console.log(`Booking for ${employeeData.name} saved successfully with ID: ${docId}`);
            } catch (error) {
                console.error("Error saving booking: ", error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©.', 'error');
            }
        }
        
        // ---------------------------------------------------------------------
        // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ØªØ®Ø²ÙŠÙ† (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹)
        // ---------------------------------------------------------------------

        /**
         * Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ù† Firestore (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ).
         */
        async function clearAllBookings() {
            const db = window.getDb();

            if (!db || !window.getIsAuthReady()) {
                 showNotification('Ù„Ù… ÙŠØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù„Ù… ØªÙƒØªÙ…Ù„.', 'error');
                return;
            }

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙƒØ±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø¤Ù‚ØªØ©
            const isConfirmed = await new Promise(resolve => {
                const modal = document.getElementById('adminModal');
                const originalContent = adminStep2.innerHTML;
                
                adminStep2.innerHTML = `
                    <div class="text-center p-4">
                        <h4 class="text-xl font-bold text-red-700 dark:text-red-400 mb-4">ØªØ£ÙƒÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</h4>
                        <p class="text-gray-700 dark:text-gray-300 mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ FirestoreØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!</p>
                        <button id="confirmClear" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg mr-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø³Ø­</button>
                        <button id="cancelClear" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                `;
                adminStep2.classList.remove('hidden');
                adminStep1.classList.add('hidden');

                document.getElementById('confirmClear').onclick = () => {
                    adminStep2.innerHTML = originalContent;
                    adminStep1.classList.add('hidden');
                    renderAdminStep2(originalContent);
                    resolve(true);
                };
                document.getElementById('cancelClear').onclick = () => {
                    renderAdminStep2(originalContent);
                    resolve(false);
                };
                 function renderAdminStep2(content) {
                    adminStep2.innerHTML = content;
                    adminStep2.classList.remove('hidden');
                    adminStep1.classList.add('hidden');
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                    rebindAdminEvents();
                 }
            });

            if (!isConfirmed) {
                return;
            }
            
            try {
                // â­ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ
                const collectionPath = 'artifacts/' + window.getAppId() + '/public/data/public_bookings';
                const employeeBookingsRef = window.collection(db, collectionPath);
                const snapshot = await window.getDocs(employeeBookingsRef);
                
                if (snapshot.docs.length === 0) {
                    showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù„Ø­Ø°ÙÙ‡Ø§ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', 'info');
                    adminModal.classList.add('hidden', 'opacity-0');
                    return;
                }
                
                const deletePromises = snapshot.docs.map(doc => window.deleteDoc(doc.ref));
                await Promise.all(deletePromises);
                
                adminModal.classList.add('hidden', 'opacity-0'); 
                showNotification('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.', 'success');

            } catch (error) {
                console.error("Error deleting all bookings:", error);
                showNotification(`ÙØ´Ù„ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª: ${error.message}`, 'error');
            }
        }


        /**
         * Ø¯Ø§Ù„Ø© Ù„Ø­Ø°Ù Ù…ÙˆØ¸Ù ÙƒØ§Ù…Ù„ ÙˆØ³Ø¬Ù„ Ø¨Ø±ÙŠÙƒØ§ØªÙ‡ Ù…Ù† Firestore.
         */
        async function deleteEmployeeFullRecord() {
            const db = window.getDb();
            if (!db || !window.getIsAuthReady()) {
                 showNotification('Ù„Ù… ÙŠØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù„Ù… ØªÙƒØªÙ…Ù„.', 'error');
                return;
            }
            
            const nameToDelete = deleteEmployeeName.value.trim();

            if (!nameToDelete) {
                showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.', 'error');
                return;
            }
            
            // Ø¨Ù†Ø§Ø¡ Doc IDs Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© (ØµØ¨Ø§Ø­ÙŠ ÙˆÙ…Ø³Ø§Ø¦ÙŠ)
            const docIdMorning = `${nameToDelete.replace(/[^a-zA-Z0-9]/g, '')}_morning`;
            const docIdEvening = `${nameToDelete.replace(/[^a-zA-Z0-9]/g, '')}_evening`;
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø¯ÙŠÙ„ Ù„Ù€ window.confirm()
            const isConfirmed = await new Promise(resolve => {
                const modal = document.getElementById('adminModal');
                const originalContent = adminStep2.innerHTML;
                
                adminStep2.innerHTML = `
                    <div class="text-center p-4">
                        <h4 class="text-xl font-bold text-red-700 dark:text-red-400 mb-4">ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ¸Ù</h4>
                        <p class="text-gray-700 dark:text-gray-300 mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª ÙˆØ­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø¨Ø±ÙŠÙƒ Ù„Ù„Ù…ÙˆØ¸Ù ${nameToDelete}ØŸ</p>
                        <button id="confirmDelete" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg mr-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</button>
                        <button id="cancelDelete" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                `;
                adminStep2.classList.remove('hidden');
                adminStep1.classList.add('hidden');

                document.getElementById('confirmDelete').onclick = () => {
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠ ÙˆØ¶Ù…Ø§Ù† Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
                    renderAdminStep2(originalContent);
                    resolve(true);
                };
                document.getElementById('cancelDelete').onclick = () => {
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠ ÙˆØ¶Ù…Ø§Ù† Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
                    renderAdminStep2(originalContent);
                    resolve(false);
                };
                function renderAdminStep2(content) {
                    adminStep2.innerHTML = content;
                    adminStep2.classList.remove('hidden');
                    adminStep1.classList.add('hidden');
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                    rebindAdminEvents();
                 }
            });

            if (!isConfirmed) {
                return;
            }
            
            // â­ï¸â­ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ â­ï¸â­ï¸
            const collectionPath = 'artifacts/' + window.getAppId() + '/public/data/public_bookings';

            const docRefMorning = window.doc(db, collectionPath, docIdMorning);
            const docRefEvening = window.doc(db, collectionPath, docIdEvening);

            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… window.deleteDoc Ù„Ù„Ø­Ø°Ù
                await Promise.all([
                    window.deleteDoc(docRefMorning).catch(e => console.log(`No morning record for ${nameToDelete}: ${e.message}`)),
                    window.deleteDoc(docRefEvening).catch(e => console.log(`No evening record for ${nameToDelete}: ${e.message}`))
                ]);

                deleteEmployeeName.value = '';
                showNotification(`ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù ${nameToDelete} Ø¨Ù†Ø¬Ø§Ø­.`, 'success');

                adminModal.classList.add('hidden', 'opacity-0');

            } catch (error) {
                console.error("Error deleting employee record:", error);
                showNotification(`ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ¸Ù: ${error.message}`, 'error');
            }
        }


        /**
         * Ø¯Ø§Ù„Ø© Ù„Ø­Ø°Ù Ø¨Ø±ÙŠÙƒ ÙˆØ§Ø­Ø¯ Ù„Ù…ÙˆØ¸Ù Ù…Ø­Ø¯Ø¯ (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ).
         */
        async function deleteSingleBreak() {
            const db = window.getDb();

            if (!db || !window.getIsAuthReady()) {
                 showNotification('Ù„Ù… ÙŠØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù„Ù… ØªÙƒØªÙ…Ù„.', 'error');
                return;
            }

            const name = deleteBreakName.value.trim();
            const indexStr = deleteBreakIndex.value.trim();
            const index = parseInt(indexStr);

            if (!name || isNaN(index) || index < 1 || index > 3) {
                showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù…ÙˆØ¸Ù ØµØ­ÙŠØ­ ÙˆØ±Ù‚Ù… Ø¨Ø±ÙŠÙƒ Ø¨ÙŠÙ† 1 Ùˆ 3.', 'error');
                return;
            }
            
            // ÙŠØ¬Ø¯ Ø£ÙˆÙ„ Ø³Ø¬Ù„ Ù„Ù„Ù…ÙˆØ¸Ù Ø¨Ø§Ù„Ø§Ø³Ù… (Ù‚Ø¯ ÙŠÙƒÙˆÙ† ØµØ¨Ø§Ø­ÙŠ Ø£Ùˆ Ù…Ø³Ø§Ø¦ÙŠ)
            const employeeRecord = employees.find(emp => emp.name === name);

            if (!employeeRecord) {
                showNotification(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø¬Ø² Ù„Ù„Ù…ÙˆØ¸Ù Ø¨Ø§Ø³Ù…: ${name}`, 'error');
                return;
            }

            const breakToRemoveIndex = index - 1; // ØªØ­ÙˆÙŠÙ„ Ù…Ù† (1, 2, 3) Ø¥Ù„Ù‰ (0, 1, 2)
            const empBreaks = employeeRecord.breaks || [];

            if (breakToRemoveIndex >= empBreaks.length || !empBreaks[breakToRemoveIndex] || !empBreaks[breakToRemoveIndex].time) {
                showNotification(`Ø§Ù„Ù…ÙˆØ¸Ù ${name} Ù„Ù… ÙŠØ­Ø¬Ø² Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø±Ù‚Ù… ${index} Ø£Ùˆ Ø£Ù†Ù‡ Ù…Ø­Ø°ÙˆÙ Ù…Ø³Ø¨Ù‚Ù‹Ø§.`, 'warning');
                return;
            }

            const breakInfo = empBreaks[breakToRemoveIndex];
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø¯ÙŠÙ„ Ù„Ù€ window.confirm()
            const isConfirmed = await new Promise(resolve => {
                const modal = document.getElementById('adminModal');
                const originalContent = adminStep2.innerHTML;
                
                adminStep2.innerHTML = `
                    <div class="text-center p-4">
                        <h4 class="text-xl font-bold text-yellow-700 dark:text-yellow-400 mb-4">ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø¨Ø±ÙŠÙƒ</h4>
                        <p class="text-gray-700 dark:text-gray-300 mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø±Ù‚Ù… ${index} (${breakInfo.duration} Ø¯Ù‚ÙŠÙ‚Ø© ÙŠØ¨Ø¯Ø£ Ø¹Ù†Ø¯ ${breakInfo.time}) Ù„Ù„Ù…ÙˆØ¸Ù ${name} ÙÙŠ ÙˆØ±Ø¯ÙŠØ© ${employeeRecord.shift === 'morning' ? 'Ø§Ù„ØµØ¨Ø§Ø­' : 'Ø§Ù„Ù…Ø³Ø§Ø¡'}ØŸ</p>
                        <button id="confirmBreakDelete" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded-lg mr-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</button>
                        <button id="cancelBreakDelete" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                `;
                adminStep2.classList.remove('hidden');
                adminStep1.classList.add('hidden');

                document.getElementById('confirmBreakDelete').onclick = () => {
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠ ÙˆØ¶Ù…Ø§Ù† Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
                    renderAdminStep2(originalContent);
                    resolve(true);
                };
                document.getElementById('cancelBreakDelete').onclick = () => {
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠ ÙˆØ¶Ù…Ø§Ù† Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
                    renderAdminStep2(originalContent);
                    resolve(false);
                };
                 function renderAdminStep2(content) {
                    adminStep2.innerHTML = content;
                    adminStep2.classList.remove('hidden');
                    adminStep1.classList.add('hidden');
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                    rebindAdminEvents();
                 }
            });

            if (!isConfirmed) {
                return;
            }


            // 1. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ (Ù†Ø³Ø® Ø§Ù„Ù…ØµÙÙˆÙØ© Ø«Ù… Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±)
            const newBreaks = [];
            // Ø¨Ù†Ø§Ø¡ Ù…ØµÙÙˆÙØ© Ø¬Ø¯ÙŠØ¯Ø© ØªØ®Ù„Ùˆ Ù…Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙ
            for(let i = 0; i < empBreaks.length; i++){
                if (i !== breakToRemoveIndex) {
                    newBreaks.push(empBreaks[i]);
                }
            }
            
            // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ÙÙŠ Firestore
            const docId = `${employeeRecord.name.replace(/[^a-zA-Z0-9]/g, '')}_${employeeRecord.shift}`;
            
            // â­ï¸â­ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ â­ï¸â­ï¸
            const collectionPath = 'artifacts/' + window.getAppId() + '/public/data/public_bookings';

            const docRef = window.doc(db, collectionPath, docId);

            try {
                if (newBreaks.length === 0) {
                    // Ø¥Ø°Ø§ Ø£ØµØ¨Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ¸Ù ÙØ§Ø±ØºÙ‹Ø§ Ø¨Ø¹Ø¯ Ø­Ø°Ù Ø§Ù„Ø¨Ø±ÙŠÙƒØŒ Ø§Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                    await window.deleteDoc(docRef);
                } else {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚Ù„ 'breaks' ÙÙ‚Ø·
                    await window.setDoc(docRef, { breaks: newBreaks }, { merge: true });
                }
                
                // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
                deleteBreakName.value = '';
                deleteBreakIndex.value = '';
                showNotification(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø±Ù‚Ù… ${index} Ù„Ù„Ù…ÙˆØ¸Ù ${name} Ø¨Ù†Ø¬Ø§Ø­.`, 'success');

                adminModal.classList.add('hidden', 'opacity-0');

            } catch (error) {
                console.error("Error deleting single break:", error);
                showNotification(`ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨Ø±ÙŠÙƒ: ${error.message}`, 'error');
            }
        }
        // ---------------------------------------------------------------------
        // ÙˆØ¸Ø§Ø¦Ù Ø±Ø¦ÙŠØ³ÙŠØ©
        // ---------------------------------------------------------------------
 
        
        function selectShift(shift) {
            window.selectedShift = selectedShift = shift; // Ø¬Ø¹Ù„ Ø§Ù„Ù…ØªØºÙŠØ± global Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡ ÙÙŠ startRealtimeSync
            
            document.querySelectorAll('.shift-card').forEach(card => {
                card.classList.remove('border-indigo-600', 'ring-4', 'ring-indigo-200', 'dark:ring-indigo-900');
                card.classList.add('border-transparent');
            });

            const selectedElement = document.getElementById(`${shift}Shift`);
            selectedElement.classList.remove('border-transparent');
            selectedElement.classList.add('border-indigo-600', 'ring-4', 'ring-indigo-200', 'dark:ring-indigo-900');

            setTimeout(() => {
                shiftSelection.classList.add('hidden');
                breakSelection.classList.remove('hidden');
                renderTimeSlots();
                renderSchedule(); 
                updateAllTimers();
            }, 200); 
        }
        
        function renderTimeSlots() {
            const now = new Date();
            
            const lastPossibleBreakTime = selectedShift === 'morning' ? '04:00 Ù…' : '10:00 Ù…';
            const lastBreakEnd = timeToDate(lastPossibleBreakTime);
            const isShiftClosed = lastBreakEnd.getTime() < now.getTime();

            timeSlotsContainer.innerHTML = '';
            const slots = selectedShift === 'morning' ? morningBreakStartTimes : eveningBreakStartTimes;
            
            if (isShiftClosed) {
                timeSlotsContainer.innerHTML = `<p class="col-span-full text-center text-red-600 font-semibold py-4 bg-red-50 rounded-lg dark:bg-red-900 dark:text-red-300">
                    Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø­Ø¬Ø² Ø§Ù„Ø¨Ø±ÙŠÙƒØ§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ù„Ù„ÙŠÙˆÙ….
                </p>`;
                confirmButton.disabled = true;
                return;
            }
            
            // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø­Ø§Ù„ÙŠØ§Ù‹
            const currentIndex = selectedBreaks.length;
            const requiredDuration = currentIndex < MAX_TOTAL_BREAKS ? REQUIRED_ORDER[currentIndex] : null;

            // Ø¯Ù…Ø¬ ÙƒÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„ÙˆØ±Ø¯ÙŠØ© (Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚)
            const allBookedSlots = employees
                                            .filter(emp => emp.shift === selectedShift)
                                            .flatMap(emp => emp.breaks)
                                            .map(b => `${b.time}-${b.duration}`);


            slots.forEach(slot => {
                const slotStartTime = slot.time;
                const duration = slot.duration;
                const slotEndTime = getBreakEndString(slotStartTime, duration);
                const uniqueSlotKey = `${slotStartTime}-${duration}`;

                // Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø²: Ù…Ø­Ø¬ÙˆØ²Ø© Ù…Ù† Ù…ÙˆØ¸Ù Ø¢Ø®Ø±
                const isBooked = allBookedSlots.includes(uniqueSlotKey);
                
                // Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±: Ù…Ø®ØªØ§Ø±Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§ Ù…Ù† Ù‚Ø¨Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const isSelected = selectedBreaks.some(b => b.time === slotStartTime && b.duration === duration);
                
                // Ø­Ø§Ù„Ø© Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª
                const breakTimeEnd = new Date(timeToDate(slotStartTime).getTime() + duration * 60000);
                const isPastTime = breakTimeEnd.getTime() < now.getTime();
                
                // ******* Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠØ¯ Ø§Ù„ØªØ±ØªÙŠØ¨ *******
                const isIncorrectDuration = requiredDuration !== null && duration !== requiredDuration;

                // Ø­Ø§Ù„Ø© ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ (3 Ø¨Ø±ÙŠÙƒØ§Øª)
                const isTotalMaxed = selectedBreaks.length >= MAX_TOTAL_BREAKS && !isSelected;
                
                const isDisabled = isBooked || isPastTime || isIncorrectDuration || isTotalMaxed;

                let slotClasses;
                let statusText;
                let durationText = `(${duration} Ø¯Ù‚ÙŠÙ‚Ø©)`;

                if (isPastTime) {
                    slotClasses = 'bg-gray-200 text-gray-500 cursor-not-allowed booked dark:bg-gray-700 dark:text-gray-400';
                    statusText = 'Ø§Ù†ØªÙ‡Øª';
                } else if (isBooked) {
                    slotClasses = 'bg-gray-300 text-red-600 cursor-not-allowed booked dark:bg-gray-700 dark:text-red-400';
                    statusText = 'Ù…Ø­Ø¬ÙˆØ²Ø©';
                } else if (isSelected) {
                    slotClasses = 'bg-indigo-600 text-white shadow-lg border-2 border-indigo-800 dark:bg-indigo-700 dark:border-indigo-500 dark:shadow-indigo-500/50';
                    statusText = 'Ù…Ø®ØªØ§Ø±Ø©';
                } else if (isIncorrectDuration) {
                    slotClasses = 'bg-gray-200 text-orange-600 cursor-not-allowed booked dark:bg-gray-700 dark:text-orange-400';
                    statusText = `ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø±ÙŠÙƒ ${requiredDuration} Ø¯Ù‚ÙŠÙ‚Ø©`;
                } else if (isTotalMaxed) {
                    slotClasses = 'bg-gray-200 text-red-600 cursor-not-allowed booked dark:bg-gray-700 dark:text-red-400';
                    statusText = 'Ø§ÙƒØªÙ…Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø±ÙŠÙƒØ§Øª';
                } else {
                    slotClasses = 'bg-white text-indigo-600 hover:bg-indigo-100 border border-indigo-200 dark:bg-gray-800 dark:text-indigo-400 dark:hover:bg-gray-700 dark:border-indigo-900';
                    statusText = 'Ù…ØªØ§Ø­Ø© Ù„Ù„Ø­Ø¬Ø²';
                }
                
                const slotElement = document.createElement('button');
                slotElement.className = `time-slot p-3 rounded-lg text-center text-sm font-bold ${slotClasses}`;
                slotElement.innerHTML = `
                    <span class="block text-xs font-normal mb-1">${durationText}</span>
                    <span class="block">${slotStartTime} - ${slotEndTime}</span>
                    <span class="block text-xs font-normal mt-1">${statusText}</span>
                `;
                slotElement.disabled = isDisabled;
                
                if (!isDisabled || isSelected) {
                    slotElement.addEventListener('click', () => toggleBreakSelection(slotStartTime, duration));
                }
                
                timeSlotsContainer.appendChild(slotElement);
            });
        }

        // ******* Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø²Ù…Ù†ÙŠ *******
        function toggleBreakSelection(slotStartTime, duration) {
            const index = selectedBreaks.findIndex(b => b.time === slotStartTime && b.duration === duration);
            
            if (index !== -1) {
                // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ùˆ Ø¢Ø®Ø± Ø¨Ø±ÙŠÙƒ ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡
                if (index !== selectedBreaks.length - 1) {
                    showNotification('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù„ØºØ§Ø¡ Ø¨Ø±ÙŠÙƒ Ù…Ù† Ø§Ù„Ù…Ù†ØªØµÙØŒ ÙŠØ¬Ø¨ Ø¥Ù„ØºØ§Ø¡ Ø¢Ø®Ø± Ø¨Ø±ÙŠÙƒ ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡ Ø£ÙˆÙ„Ø§Ù‹.', 'error');
                    return;
                }
                
                selectedBreaks.splice(index, 1);
            } else {
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
                
                const currentSelectionIndex = selectedBreaks.length;
                
                if (currentSelectionIndex >= MAX_TOTAL_BREAKS) {
                    showNotification('ØªÙ… Ø§Ø®ØªÙŠØ§Ø± 3 Ø¨Ø±ÙŠÙƒØ§Øª Ø¨Ø§Ù„ÙØ¹Ù„.', 'error');
                    return;
                }

                const requiredDuration = REQUIRED_ORDER[currentSelectionIndex];
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ (Ø§Ù„Ù…Ø¯Ø©)
                if (duration !== requiredDuration) {
                    showNotification(`Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø±Ù‚Ù… ${currentSelectionIndex + 1} ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ${requiredDuration} Ø¯Ù‚ÙŠÙ‚Ø©.`, 'error');
                    return;
                }
                
                // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ù„ØªØ³Ù„Ø³Ù„ ÙˆØ¹Ø¯Ù… Ø§Ù„ØªØ¯Ø§Ø®Ù„)
                if (selectedBreaks.length > 0) {
                    const lastBreak = selectedBreaks[selectedBreaks.length - 1];
                    const lastBreakStartTime = timeToDate(lastBreak.time);
                    const lastBreakEndTime = new Date(lastBreakStartTime.getTime() + lastBreak.duration * 60000); // ÙˆÙ‚Øª Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø£Ø®ÙŠØ±
                    const newBreakStartTime = timeToDate(slotStartTime); // ÙˆÙ‚Øª Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯

                    // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙˆÙ‚Øª Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£ØµØºØ± Ù…Ù† Ø£Ùˆ ÙŠØ³Ø§ÙˆÙŠ ÙˆÙ‚Øª Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø£Ø®ÙŠØ±ØŒ ÙØ¥Ù†Ù‡ Ù…ØªØ¯Ø§Ø®Ù„ Ø£Ùˆ Ù…Ø¹ÙƒÙˆØ³.
                    if (newBreakStartTime <= lastBreakEndTime) {
                        const lastBreakEndTimeString = getBreakEndString(lastBreak.time, lastBreak.duration);
                        showNotification(`Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø±Ù‚Ù… ${currentSelectionIndex + 1} ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ (Ø¨Ø¹Ø¯ ${lastBreakEndTimeString}).`, 'error');
                        return;
                    }
                }
                
                selectedBreaks.push({ time: slotStartTime, duration: duration });
                
                // Ø§Ù„ÙØ±Ø² Ù„ÙŠØ³ Ø¶Ø±ÙˆØ±ÙŠØ§Ù‹ Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù† Ø¨Ù„ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
            }
            
            renderTimeSlots();
            selectedCount.textContent = selectedBreaks.length;
            
            const isThreeBreaks = selectedBreaks.length === MAX_TOTAL_BREAKS;
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ù…Ø¯Ø¯
            const isCorrectDurationOrder = isThreeBreaks && selectedBreaks.every((b, i) => b.duration === REQUIRED_ORDER[i]);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø²Ù…Ù†ÙŠ (Ù…ØªØªØ§Ù„ÙŠ ÙˆØºÙŠØ± Ù…ØªØ¯Ø§Ø®Ù„)
            let isCorrectTimeOrder = true;
            for(let i = 1; i < selectedBreaks.length; i++) {
                const prevBreak = selectedBreaks[i-1];
                const currentBreak = selectedBreaks[i];

                const prevBreakStartTime = timeToDate(prevBreak.time);
                const prevBreakEndTime = new Date(prevBreakStartTime.getTime() + prevBreak.duration * 60000);
                const currentBreakStartTime = timeToDate(currentBreak.time);

                if (currentBreakStartTime <= prevBreakEndTime) {
                    isCorrectTimeOrder = false;
                    break;
                }
            }

            confirmButton.disabled = !(isCorrectDurationOrder && isCorrectTimeOrder && employeeName.value.trim());
        }

        // ******* Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø¯Ø§Ø®Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² (ØªÙ… ØªÙØ¹ÙŠÙ„Ù‡Ø§ Ù‡Ù†Ø§) *******
        async function confirmReservation() {
            const name = employeeName.value.trim();
            
            const isThreeBreaks = selectedBreaks.length === MAX_TOTAL_BREAKS;
            const isCorrectDurationOrder = isThreeBreaks && selectedBreaks.every((b, i) => b.duration === REQUIRED_ORDER[i]);
            
            let isCorrectTimeOrder = true;
            for(let i = 1; i < selectedBreaks.length; i++) {
                const prevBreak = selectedBreaks[i-1];
                const currentBreak = selectedBreaks[i];
                const prevBreakStartTime = timeToDate(prevBreak.time);
                const prevBreakEndTime = new Date(prevBreakStartTime.getTime() + prevBreak.duration * 60000);
                const currentBreakStartTime = timeToDate(currentBreak.time);
                if (currentBreakStartTime <= prevBreakEndTime) {
                    isCorrectTimeOrder = false;
                    break;
                }
            }
            
            if (!name || !isCorrectDurationOrder || !isCorrectTimeOrder) {
                showNotification('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ø®ØªÙŠØ§Ø± 3 Ø¨Ø±ÙŠÙƒØ§Øª Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ (15ØŒ 30ØŒ 15) ÙˆØ¨ØªØ³Ù„Ø³Ù„ Ø²Ù…Ù†ÙŠ ØµØ­ÙŠØ­ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø².', 'error');
                return;
            }
            
            // Note: employees array is now kept up-to-date by the startRealtimeSync function
            if (employees.some(emp => emp.name === name && emp.shift === selectedShift)) {
                showNotification(`Ø§Ù„Ù…ÙˆØ¸Ù ${name} Ù„Ø¯ÙŠÙ‡ Ø­Ø¬Ø² Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ±Ø¯ÙŠØ©.`, 'error');
                return;
            }
            
            const employee = {
                name,
                shift: selectedShift,
                breaks: [...selectedBreaks], // Ù†Ø³Ø® Ø§Ù„Ø¨Ø±ÙŠÙƒØ§Øª Ø¨Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ù…Ø¯Ø©
                confirmedAt: new Date().toISOString()
            };
            
            // â­ï¸ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ø³Ù…Ø©: Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firestore (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©)
            await saveEmployeeBooking(employee);

            employeeName.value = '';
            selectedBreaks = [];
            selectedCount.textContent = '0';
            confirmButton.disabled = true;

            showNotification(`ØªÙ… Ø­Ø¬Ø² Ø§Ù„Ø¨Ø±ÙŠÙƒØ§Øª Ù„Ù€ ${name} Ø¨Ù†Ø¬Ø§Ø­ âœ…`, 'success');
        }
        
        function createBreakCellContent(breakItem) {
            const breakTime = breakItem.time;
            const duration = breakItem.duration;
            const breakEndString = getBreakEndString(breakTime, duration);
            
            const durationTextClass = duration === 30 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400';

            return `
                <span class="inline-block font-bold text-sm text-gray-800 dark:text-gray-100">${breakTime} - ${breakEndString}</span>
                <span class="block text-xs font-medium ${durationTextClass}">(${duration} Ø¯Ù‚ÙŠÙ‚Ø©)</span>
                <div id="status-timer-${breakTime.replace(/ /g, '-').replace(/:/g, '-')}-${breakItem.duration}" class="timer-display mt-1">
                    </div>
            `;
        }

      
        function renderSchedule() {
            const filteredEmployees = employees.filter(emp => emp.shift === selectedShift);

            if (filteredEmployees.length === 0) {
                scheduleContent.innerHTML = `
                    <div class="grid grid-cols-12 text-center items-center py-4 px-2 text-gray-500 dark:text-gray-400">
                        <div class="col-span-12 p-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</div>
                    </div>
                `;
                return;
            }
            
            // ÙØ±Ø² Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
            filteredEmployees.sort((a, b) => {
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø£ÙˆÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ù‚Ø¨Ù„ Ø§Ù„ÙØ±Ø²
                const timeA = a.breaks && a.breaks.length > 0 ? timeToDate(a.breaks[0].time) : new Date(0);
                const timeB = b.breaks && b.breaks.length > 0 ? timeToDate(b.breaks[0].time) : new Date(0);
                return timeA - timeB;
            });
            
            scheduleContent.innerHTML = filteredEmployees.map((emp, index) => {
                const rowClass = index % 2 === 0 ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-900';
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ 3 Ø¨Ø±ÙŠÙƒØ§Øª (ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø¨Ø±ÙŠÙƒ Ù…Ø­Ø°ÙˆÙÙ‹Ø§ Ø¥Ø¯Ø§Ø±ÙŠØ§Ù‹)
                const breaksArray = emp.breaks || [];
                
                // Ù…Ù„Ø¡ Ø§Ù„ÙØ±Ø§ØºØ§Øª Ø¨Ù€ null Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ø¯Ø¯ Ø£Ù‚Ù„ Ù…Ù† 3 Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµØ­ÙŠØ­
                const displayBreaks = [...breaksArray];
                while(displayBreaks.length < MAX_TOTAL_BREAKS) {
                    displayBreaks.push(null);
                }
                
                const breakCells = displayBreaks.map((breakItem, breakIndex) => {
                    // ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ù‡Ùˆ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø«Ø§Ù†ÙŠ (30 Ø¯Ù‚ÙŠÙ‚Ø©)
                    const isLunch = breakIndex === 1 && breakItem && breakItem.duration === 30;
                    
                    if (breakItem) {
                         return `
                            <div class="col-span-3 p-3 border-r border-gray-200 dark:border-gray-700 ${isLunch ? 'bg-yellow-50 dark:bg-gray-700' : ''}">
                                ${createBreakCellContent(breakItem)}
                            </div>
                        `;
                    } else {
                        return `
                             <div class="col-span-3 p-3 border-r border-gray-200 dark:border-gray-700 text-gray-400 text-sm">
                                <span class="font-medium">ØºÙŠØ± Ù…Ø­Ø¬ÙˆØ²</span>
                            </div>
                        `;
                    }
                }).join('');
                
                return `
                    <div class="grid grid-cols-12 text-center items-center py-3 px-2 ${rowClass} hover:bg-indigo-50 dark:hover:bg-indigo-900/40 transition-colors">
                        <div class="col-span-3 p-3 font-extrabold text-gray-900 dark:text-white border-r border-gray-200 dark:border-gray-700">
                            ${emp.name} 
                        </div>
                        ${breakCells}
                    </div>
                `;
            }).join('');
            
            // FIX: Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Feather Replace Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯
            feather.replace();
        }

        let timerInterval = null;

        function updateTimer(breakItem) {
            const now = new Date();
            const breakStartTime = timeToDate(breakItem.time);
            const breakEndTime = new Date(breakStartTime.getTime() + breakItem.duration * 60000);
            
            const timerId = `status-timer-${breakItem.time.replace(/ /g, '-').replace(/:/g, '-')}-${breakItem.duration}`;
            const timerElement = document.getElementById(timerId);

            if (!timerElement) return; // Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„Ø¹Ù†ØµØ± Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø¥Ø°Ø§ ØªÙ… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ±Ø¯ÙŠØ©

            let statusHTML = '';

            if (now < breakStartTime) {
                // Ø­Ø§Ù„Ø©: Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯ (ÙŠØªØ¨Ù‚Ù‰)
                const msUntilStart = breakStartTime.getTime() - now.getTime();
                statusHTML = `
                    <span class="timer-text text-blue-600 dark:text-blue-400">
                        ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯: ${formatTimeDifference(msUntilStart)}
                    </span>
                `;
            } else if (now >= breakStartTime && now < breakEndTime) {
                // Ø­Ø§Ù„Ø©: Ø§Ù„Ø¨Ø±ÙŠÙƒ Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„ (Ù…ØªØ¨Ù‚ÙŠ)
                const msRemaining = breakEndTime.getTime() - now.getTime();
                statusHTML = `
                    <span class="timer-text text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/50 px-2 py-0.5 rounded-full">
                        Ù…ØªØ¨Ù‚ÙŠ: ${formatTimeDifference(msRemaining)}
                    </span>
                `;
            } else {
                // Ø­Ø§Ù„Ø©: Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¨Ø±ÙŠÙƒ
                statusHTML = `
                    <span class="timer-text text-gray-500 dark:text-gray-500">
                        Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¨Ø±ÙŠÙƒ
                    </span>
                `;
            }

            timerElement.innerHTML = statusHTML;
        }

        function updateAllTimers() {
            if (!selectedShift) return;

            // ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø±ÙŠÙƒØ§Øª ÙÙŠ Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹
            const activeBreaks = employees
                                    .filter(emp => emp.shift === selectedShift)
                                    .flatMap(emp => emp.breaks || []); // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† breaks Ù…ÙˆØ¬ÙˆØ¯Ø©
            
            // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ù‚Øª ÙƒÙ„ Ø¨Ø±ÙŠÙƒ
            activeBreaks.forEach(breakItem => updateTimer(breakItem));

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            const now = new Date();
            const options = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            currentTimeDisplay.textContent = `Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${now.toLocaleTimeString('ar-EG', options)}`;
        }

        function startTimerLoop() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
            timerInterval = setInterval(updateAllTimers, 1000);
        }
        
        function resetSelection() {
            window.selectedShift = selectedShift = null;
            selectedBreaks = [];
            employeeName.value = '';
            selectedCount.textContent = '0';
            confirmButton.disabled = true;
            
            shiftSelection.classList.remove('hidden');
            breakSelection.classList.add('hidden');
        }
        
        // ******* ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Admin) *******
        
        function checkAdminLogin() {
            if (adminCode.value === ADMIN_CODE) {
                adminStep1.classList.add('hidden');
                adminStep2.classList.remove('hidden');
                showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                adminCode.value = '';
                adminModal.classList.remove('opacity-0');
            } else {
                showNotification('Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­.', 'error');
                adminCode.value = '';
            }
        }
        
        function openAdminModal() {
            adminModal.classList.remove('hidden');
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
            adminStep1.classList.remove('hidden');
            adminStep2.classList.add('hidden');
            setTimeout(() => {
                adminModal.classList.remove('opacity-0');
            }, 10); // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ù„ØªØ­ÙˆÙ„
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ù…Ø­ØªÙˆÙ‰ adminStep2
        function rebindAdminEvents() {
            // Ø±Ø¨Ø· Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù€ Firestore
            document.getElementById('deleteStorageButton').addEventListener('click', clearAllBookings); 
            document.getElementById('deleteEmployeeButton').addEventListener('click', deleteEmployeeFullRecord); 
            document.getElementById('deleteSingleBreakButton').addEventListener('click', deleteSingleBreak);
        }
        
        // ------------------------------------

        // INITIALIZATION AND EVENT LISTENERS
        
        // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        confirmButton.addEventListener('click', confirmReservation);
        employeeName.addEventListener('input', () => {
            const isThreeBreaks = selectedBreaks.length === MAX_TOTAL_BREAKS;
            const isCorrectDurationOrder = isThreeBreaks && selectedBreaks.every((b, i) => b.duration === REQUIRED_ORDER[i]);
            confirmButton.disabled = !(isCorrectDurationOrder && employeeName.value.trim());
        });
        
        // Ø±Ø¨Ø· Ø­Ø¯Ø« ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹
        themeToggle.addEventListener('click', toggleTheme);
        
        // ****** Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ******
        adminToggle.addEventListener('click', openAdminModal);
        adminLoginButton.addEventListener('click', checkAdminLogin);
        rebindAdminEvents(); // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
        
        adminCode.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                checkAdminLogin();
            }
        });
        // ***************************************

        // â­ï¸â­ï¸â­ï¸ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ø³Ù…Ø©: ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© â­ï¸â­ï¸â­ï¸
        // Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø£Ù† ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø«ÙŠÙ… ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ JS
        applyInitialTheme();

        // Ø¨Ø¯Ø¡ Ø­Ù„Ù‚Ø© Ø§Ù„Ù…Ø¤Ù‚Øª
        startTimerLoop();
        updateAllTimers(); // ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ„ÙŠ Ù„Ù„Ø³Ø§Ø¹Ø© ÙˆØ§Ù„Ù…Ø¤Ù‚ØªØ§Øª
    </script>
</body>
</html>
